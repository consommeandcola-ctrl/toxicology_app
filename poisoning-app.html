<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ¯’è¨ºç™‚æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ  - è–¬å‰¤æ¯’æ€§è©•ä¾¡ã¨æ²»ç™‚å¦¥å½“æ€§æ¤œè¨¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .step-card { transition: all 0.2s; }
        .step-card:hover { transform: translateY(-1px); }
        .severity-critical { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 5px solid #dc2626; }
        .severity-high { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); border-left: 5px solid #ea580c; }
        .severity-mid { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 5px solid #d97706; }
        .severity-low { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 5px solid #059669; }
        .match-yes { color: #059669; font-weight: bold; }
        .match-partial { color: #d97706; font-weight: bold; }
        .match-no { color: #dc2626; }
        .treatment-valid { background: #dcfce7; }
        .treatment-invalid { background: #fee2e2; }
        .treatment-consider { background: #fef3c7; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">

    <header class="bg-gradient-to-r from-slate-800 to-slate-700 text-white p-5 shadow-xl">
        <div class="container mx-auto max-w-5xl">
            <h1 class="text-2xl font-bold flex items-center gap-3">
                <span class="text-3xl">ğŸ§ª</span>
                ä¸­æ¯’è¨ºç™‚æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ 
            </h1>
            <p class="text-slate-300 text-sm mt-1">è–¬å‰¤æˆåˆ†åˆ†æ â†’ æ¯’æ€§è©•ä¾¡ â†’ é‡ç—‡åº¦æ¨å¯Ÿ â†’ ç—‡çŠ¶ç…§åˆ â†’ æ²»ç™‚å¦¥å½“æ€§æ¤œè¨¼</p>
            <div class="mt-3 flex gap-6 text-sm">
                <label>æ‚£è€…ä½“é‡: <input type="number" id="patientWeight" value="60" min="1" class="bg-slate-600 border border-slate-500 rounded px-2 py-1 w-20 text-white"> kg</label>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-5xl p-5 space-y-6">

        <!-- Step 1: æ‘‚å–è–¬å‰¤å…¥åŠ› -->
        <section class="bg-white rounded-xl shadow-lg p-6 border border-slate-200 step-card">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                æ‘‚å–è–¬å‰¤ãƒ»é‡ã®å…¥åŠ›
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <input type="text" id="drugInput" placeholder="è–¬å‰¤å (ä¾‹: ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³)" 
                    class="border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500">
                <input type="number" id="amountInput" placeholder="æ‘‚å–é‡ (mg)" min="0" step="0.1"
                    class="border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500">
                <select id="unitSelect" class="border border-slate-300 p-3 rounded-lg">
                    <option value="mg">mg</option>
                    <option value="g">g</option>
                    <option value="éŒ ">éŒ </option>
                    <option value="åŒ…">åŒ…</option>
                </select>
                <button onclick="app.addDrug()" class="bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 transition shadow">
                    ãƒªã‚¹ãƒˆã«è¿½åŠ 
                </button>
            </div>
            <p class="text-xs text-slate-500 mt-2">â€» éŒ ãƒ»åŒ…ã®å ´åˆã¯1éŒ /åŒ…ã‚ãŸã‚Šã®mgã‚’æ‘‚å–é‡ã«å…¥åŠ›</p>
        </section>

        <!-- Step 2: æ‚£è€…ç—‡çŠ¶å…¥åŠ› -->
        <section class="bg-white rounded-xl shadow-lg p-6 border border-slate-200 step-card">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="bg-amber-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                æ‚£è€…ã®ç¾åœ¨ç—‡çŠ¶ï¼ˆç…§åˆç”¨ï¼‰
            </h2>
            <textarea id="patientSymptoms" rows="3" placeholder="ä¾‹: å˜”æ°—ã€æ„è­˜æ··æ¿ã€é »è„ˆã€å‘¼å¸æŠ‘åˆ¶ã€ç³å­”ç¸®å°..."
                class="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-amber-500"></textarea>
        </section>

        <!-- Step 3: é‡ç—‡åº¦é †ãƒªã‚¹ãƒˆï¼ˆè–¬å‰¤â†’æˆåˆ†â†’æ¯’æ€§â†’é‡ç—‡åº¦ã®çµæœï¼‰ -->
        <section class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">3</span>
                é‡ç—‡åº¦é † è–¬å‰¤ä¸€è¦§ï¼ˆæˆåˆ†ãƒ»æ¯’æ€§ãƒ»äºˆæ¸¬ç—‡çŠ¶ï¼‰
            </h2>
            <div id="drugList" class="space-y-3">
                <p class="text-slate-400 text-center py-12">è–¬å‰¤ã‚’å…¥åŠ›ã—ã¦ã€Œãƒªã‚¹ãƒˆã«è¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
            </div>
        </section>

        <!-- Step 4: ç—‡çŠ¶ç…§åˆçµæœ -->
        <section id="symptomMatchSection" class="hidden bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">4</span>
                äºˆæ¸¬ç—‡çŠ¶ã¨æ‚£è€…ç—‡çŠ¶ã®ç…§åˆ
            </h2>
            <div id="symptomMatchResult" class="space-y-4"></div>
        </section>

        <!-- Step 5: æ²»ç™‚å¦¥å½“æ€§æ¤œè¨¼ãƒãƒˆãƒªã‚¯ã‚¹ -->
        <section id="treatmentSection" class="hidden bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 border-b-2 border-slate-800 pb-2">
                <span class="bg-purple-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-sm">5</span>
                æ²»ç™‚å¦¥å½“æ€§ã®æ¤œè¨¼
            </h2>
            <p class="text-sm text-slate-600 mb-4">å„è–¬å‰¤ã«ã¤ã„ã¦ã€æ‹®æŠ—è–¬ãƒ»èƒƒæ´—æµ„ãƒ»æ´»æ€§ç‚­ãƒ»è¡€æ¶²æµ„åŒ–ãƒ»ãã®ä»–ã®å¦¥å½“æ€§ã‚’æ¤œè¨¼</p>
            <div id="treatmentDetails" class="space-y-8"></div>
        </section>
    </main>

    <script>
        /**
         * ä¸­æ¯’è¨ºç™‚æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ 
         * ãƒ•ãƒ­ãƒ¼: è–¬å‰¤åâ†’æˆåˆ†â†’æ¯’æ€§â†’ä¸­æ¯’é‡â†’é‡ç—‡åº¦æ¨å¯Ÿâ†’ç—‡çŠ¶ç…§åˆâ†’æ²»ç™‚å¦¥å½“æ€§æ¤œè¨¼
         */
        class PoisoningApp {
            constructor() {
                this.drugs = [];
                this.patientWeight = 60;
                // è–¬å‰¤ãƒã‚¹ã‚¿ãƒ¼: è–¬å‰¤å â†’ { æˆåˆ†, æ¯’æ€§æƒ…å ±, ä¸­æ¯’é‡, ç—‡çŠ¶, æ²»ç™‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ }
                this.masterData = {
                    "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³": {
                        comp: "Acetaminophen (ãƒ‘ãƒ©ã‚»ã‚¿ãƒ¢ãƒ¼ãƒ«)",
                        toxicDose: 150,
                        toxicDoseMax: 250,
                        unit: "mg/kg",
                        symptoms: "å˜”æ°—, å˜”å, è…¹ç—›, è‚éšœå®³, è‚ä¸å…¨, æ„è­˜éšœå®³",
                        antidote: "N-ã‚¢ã‚»ãƒãƒ«ã‚·ã‚¹ãƒ†ã‚¤ãƒ³ (NAC)",
                        antidoteNote: "8æ™‚é–“ä»¥å†…é–‹å§‹ãŒæœ›ã¾ã—ã„ã€‚è¡€ä¸­æ¿ƒåº¦-æ™‚é–“æ›²ç·šã§åˆ¤æ–­",
                        lavage: { valid: true, note: "æ‘‚å–1æ™‚é–“ä»¥å†…ã§ã‚ã‚Œã°è€ƒæ…®ã€‚é…å»¶æ™‚ã¯åŠ¹æœè–„" },
                        charcoal: { valid: true, note: "å˜å›æŠ•ä¸æ¨å¥¨ã€‚NACã¨åŒæ™‚æŠ•ä¸å¯ï¼ˆåˆ¥çµŒè·¯ï¼‰" },
                        dialysis: { valid: false, note: "åŠ¹æœãªã—ã€‚è‚ç§»æ¤é©å¿œã®æ¤œè¨" },
                        other: "è‚æ©Ÿèƒ½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ãƒ—ãƒ­ãƒˆãƒ­ãƒ³ãƒ“ãƒ³æ™‚é–“"
                    },
                    "ã‚«ãƒ•ã‚§ã‚¤ãƒ³": {
                        comp: "Caffeine (1,3,7-ãƒˆãƒªãƒ¡ãƒãƒ«ã‚­ã‚µãƒ³ãƒãƒ³)",
                        toxicDose: 15,
                        toxicDoseMax: 30,
                        unit: "mg/kg",
                        symptoms: "é »è„ˆ, ä¸æ•´è„ˆ, èˆˆå¥®, ç—™æ”£, å˜”å, ä½Kè¡€ç—‡",
                        antidote: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—",
                        antidoteNote: "ãƒ™ãƒ³ã‚¾ã‚¸ã‚¢ã‚¼ãƒ”ãƒ³ï¼ˆç—™æ”£ï¼‰ã€Î²é®æ–­è–¬ï¼ˆä¸æ•´è„ˆï¼‰ã¯å¯¾ç—‡ç™‚æ³•",
                        lavage: { valid: true, note: "æ‘‚å–1æ™‚é–“ä»¥å†…ã§å¤§é‡æ‘‚å–æ™‚" },
                        charcoal: { valid: true, note: "æœ‰åŠ¹ã€‚è¤‡æ•°å›æŠ•ä¸ã‚‚æ¤œè¨" },
                        dialysis: { valid: true, note: "é‡ç—‡æ™‚ï¼ˆè¡€ä¸­æ¿ƒåº¦>80Î¼g/mLï¼‰ã§è¡€æ¶²æµ„åŒ–æ¤œè¨" },
                        other: "ãƒã‚°ãƒã‚·ã‚¦ãƒ ã€ãƒªãƒ‰ã‚«ã‚¤ãƒ³ï¼ˆä¸æ•´è„ˆæ™‚ï¼‰"
                    },
                    "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ": {
                        comp: "Diazepam (ãƒ™ãƒ³ã‚¾ã‚¸ã‚¢ã‚¼ãƒ”ãƒ³ç³»)",
                        toxicDose: 0.5,
                        toxicDoseMax: 2,
                        unit: "mg/kg",
                        symptoms: "å‚¾çœ , æ„è­˜éšœå®³, å‘¼å¸æŠ‘åˆ¶, é‹å‹•å¤±èª¿, æ§‹éŸ³éšœå®³",
                        antidote: "ãƒ•ãƒ«ãƒã‚¼ãƒ‹ãƒ«",
                        antidoteNote: "ãƒ™ãƒ³ã‚¾ä¾å­˜ãƒ»ç—™æ”£æ­´ã‚ã‚‹å ´åˆã¯æ…é‡ã€‚ç—™æ”£ãƒªã‚¹ã‚¯",
                        lavage: { valid: false, note: "éæ¨å¥¨ã€‚æ°—é“ç¢ºä¿å›°é›£ã€èª¤åš¥ãƒªã‚¹ã‚¯" },
                        charcoal: { valid: true, note: "å˜å›æŠ•ä¸ã€‚æ‘‚å–1æ™‚é–“ä»¥å†…ãŒæœ›ã¾ã—ã„" },
                        dialysis: { valid: false, note: "è„‚æº¶æ€§ã®ãŸã‚åŠ¹æœãªã—" },
                        other: "å‘¼å¸ãƒ»å¾ªç’°ç®¡ç†ã€ãƒ•ãƒ«ãƒã‚¼ãƒ‹ãƒ«ã¯æ…é‡é©å¿œ"
                    },
                    "ã‚¤ãƒ–ãƒ—ãƒ­ãƒ•ã‚§ãƒ³": {
                        comp: "Ibuprofen (NSAIDs)",
                        toxicDose: 100,
                        toxicDoseMax: 400,
                        unit: "mg/kg",
                        symptoms: "æ‚ªå¿ƒ, å˜”å, è…¹ç—›, è…éšœå®³, ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹, ç—™æ”£",
                        antidote: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—",
                        antidoteNote: "å¯¾ç—‡ç™‚æ³•ã€‚é‡ç‚­é…¸ï¼ˆã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ï¼‰",
                        lavage: { valid: true, note: "æ‘‚å–1æ™‚é–“ä»¥å†…ã§å¤§é‡æ‘‚å–" },
                        charcoal: { valid: true, note: "æœ‰åŠ¹" },
                        dialysis: { valid: false, note: "è›‹ç™½çµåˆé«˜ãåŠ¹æœè–„" },
                        other: "è…æ©Ÿèƒ½ãƒ»é›»è§£è³ªãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°"
                    },
                    "ã‚ªã‚­ã‚·ã‚³ãƒ‰ãƒ³": {
                        comp: "Oxycodone (ã‚ªãƒ”ã‚ªã‚¤ãƒ‰)",
                        toxicDose: 0.1,
                        toxicDoseMax: 0.5,
                        unit: "mg/kg",
                        symptoms: "å‘¼å¸æŠ‘åˆ¶, ç³å­”ç¸®å°, æ„è­˜éšœå®³, ä¾¿ç§˜, æ‚ªå¿ƒ",
                        antidote: "ãƒŠãƒ­ã‚­ã‚½ãƒ³",
                        antidoteNote: "0.4mg IVã€åå¿œãªã‘ã‚Œã°ç¹°ã‚Šè¿”ã—ã€‚æŒç¶šæ³¨å…¥ã‚‚æ¤œè¨",
                        lavage: { valid: true, note: "æ‘‚å–1æ™‚é–“ä»¥å†…ã€æ°—é“ç¢ºä¿ä¸‹ã§" },
                        charcoal: { valid: true, note: "æœ‰åŠ¹ã€‚é…å»¶æ”¾å‡ºè£½å‰¤ã¯æ³¨æ„" },
                        dialysis: { valid: false, note: "åŠ¹æœãªã—" },
                        other: "å‘¼å¸ç®¡ç†ã€ãƒŠãƒ­ã‚­ã‚½ãƒ³æŒç¶š"
                    },
                    "ã‚¢ãƒŸãƒˆãƒªãƒ—ãƒãƒªãƒ³": {
                        comp: "Amitriptyline (ä¸‰ç’°ç³»æŠ—ã†ã¤è–¬)",
                        toxicDose: 5,
                        toxicDoseMax: 15,
                        unit: "mg/kg",
                        symptoms: "æ„è­˜éšœå®³, ç—™æ”£, ä¸æ•´è„ˆ, æŠ—ã‚³ãƒªãƒ³ç—‡çŠ¶(ç³å­”æ•£å¤§, å°¿é–‰), ä½è¡€åœ§",
                        antidote: "é‡ç‚­é…¸ãƒŠãƒˆãƒªã‚¦ãƒ ",
                        antidoteNote: "QRSå»¶é•·ãƒ»ä¸æ•´è„ˆã«ã€‚è¡€æ¼¿pH7.45-7.55ç›®æ¨™",
                        lavage: { valid: true, note: "æ‘‚å–1æ™‚é–“ä»¥å†…ã€‚æ°—é“ç¢ºä¿å¿…é ˆ" },
                        charcoal: { valid: true, note: "æœ‰åŠ¹ã€‚è¤‡æ•°å›æŠ•ä¸ã‚‚" },
                        dialysis: { valid: false, note: "è›‹ç™½çµåˆé«˜ãåŠ¹æœãªã—" },
                        other: "å¿ƒé›»å›³ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ãƒ™ãƒ³ã‚¾ã‚¸ã‚¢ã‚¼ãƒ”ãƒ³(ç—™æ”£)"
                    },
                    "ãƒªãƒã‚¦ãƒ ": {
                        comp: "Lithium (Li+)",
                        toxicDose: 2,
                        toxicDoseMax: 4,
                        unit: "mEq/kg",
                        symptoms: "æŒ¯æˆ¦, å¤±èª¿, æ„è­˜éšœå®³, è…æ€§å°¿å´©ç—‡, ç”²çŠ¶è…ºæ©Ÿèƒ½ä½ä¸‹",
                        antidote: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—",
                        antidoteNote: "ç”Ÿç†é£Ÿå¡©æ°´è² è·ã€è¡€æ¶²æµ„åŒ–",
                        lavage: { valid: true, note: "æ‘‚å–1æ™‚é–“ä»¥å†…" },
                        charcoal: { valid: false, note: "ãƒªãƒã‚¦ãƒ ã¯å¸ç€ã•ã‚Œãªã„" },
                        dialysis: { valid: true, note: "é‡ç—‡æ™‚ï¼ˆè¡€ä¸­>2.5mEq/Lï¼‰ã§é©å¿œ" },
                        other: "è¡€ä¸­ãƒªãƒã‚¦ãƒ æ¿ƒåº¦ã€è…æ©Ÿèƒ½"
                    },
                    "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«": {
                        comp: "Methanol (ãƒ¡ãƒãƒ«ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«)",
                        toxicDose: 20,
                        toxicDoseMax: 50,
                        unit: "mg/kg",
                        symptoms: "è¦–åŠ›éšœå®³, ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹, æ„è­˜éšœå®³, è…¹ç—›",
                        antidote: "ã‚¨ã‚¿ãƒãƒ¼ãƒ« or ãƒ›ãƒ¡ãƒ”ã‚¾ãƒ¼ãƒ«",
                        antidoteNote: "ã‚¢ãƒ«ãƒ‡ãƒ’ãƒ‰è„±æ°´ç´ é…µç´ é˜»å®³ã€‚æ—©æœŸé–‹å§‹",
                        lavage: { valid: true, note: "æ‘‚å–ç›´å¾Œ" },
                        charcoal: { valid: false, note: "ãƒ¡ã‚¿ãƒãƒ¼ãƒ«ã¯å¸ç€ã•ã‚Œã«ãã„" },
                        dialysis: { valid: true, note: "é‡ç—‡ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã€è¦–åŠ›éšœå®³ã§é©å¿œ" },
                        other: "è‘‰é…¸ã€è¡€æ¼¿æµ¸é€åœ§ã‚®ãƒ£ãƒƒãƒ—"
                    },
                    "ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³": {
                        comp: "Warfarin (ãƒ“ã‚¿ãƒŸãƒ³Kæ‹®æŠ—è–¬)",
                        toxicDose: 0.1,
                        toxicDoseMax: 0.5,
                        unit: "mg/kg",
                        symptoms: "å‡ºè¡€å‚¾å‘, PT-INRå»¶é•·, çš®ä¸‹å‡ºè¡€, æ¶ˆåŒ–ç®¡å‡ºè¡€",
                        antidote: "ãƒ“ã‚¿ãƒŸãƒ³K1",
                        antidoteNote: "é‡ç—‡å‡ºè¡€æ™‚ã¯æ–°é®®å‡çµè¡€æ¼¿ãƒ»PCCä½µç”¨",
                        lavage: { valid: true, note: "å¤§é‡æ‘‚å–ç›´å¾Œ" },
                        charcoal: { valid: true, note: "æœ‰åŠ¹" },
                        dialysis: { valid: false, note: "è›‹ç™½çµåˆé«˜ãåŠ¹æœãªã—" },
                        other: "PT-INRãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€ãƒ“ã‚¿ãƒŸãƒ³KçµŒå£/IV"
                    },
                    "ã‚¸ã‚´ã‚­ã‚·ãƒ³": {
                        comp: "Digoxin (ã‚¸ã‚®ã‚¿ãƒªã‚¹)",
                        toxicDose: 0.01,
                        toxicDoseMax: 0.03,
                        unit: "mg/kg",
                        symptoms: "æ‚ªå¿ƒ, å¾è„ˆ, ä¸æ•´è„ˆ, è¦–è¦šç•°å¸¸(é»„è¦–ç—‡), é«˜Kè¡€ç—‡",
                        antidote: "ã‚¸ã‚´ã‚­ã‚·ãƒ³ç‰¹ç•°çš„æŠ—ä½“ (DigiFab)",
                        antidoteNote: "é‡ç—‡ä¸æ•´è„ˆãƒ»é«˜Kè¡€ç—‡ã§é©å¿œ",
                        lavage: { valid: true, note: "æ‘‚å–1æ™‚é–“ä»¥å†…" },
                        charcoal: { valid: true, note: "æœ‰åŠ¹ã€‚è¤‡æ•°å›æŠ•ä¸" },
                        dialysis: { valid: false, note: "åˆ†å¸ƒå®¹ç©å¤§ã§åŠ¹æœè–„" },
                        other: "è¡€ä¸­ã‚¸ã‚´ã‚­ã‚·ãƒ³æ¿ƒåº¦ã€ãƒã‚°ãƒã‚·ã‚¦ãƒ ã€ã‚¢ãƒˆãƒ­ãƒ”ãƒ³"
                    }
                };
            }

            addDrug() {
                const name = document.getElementById('drugInput').value.trim();
                let amount = parseFloat(document.getElementById('amountInput').value);
                const unit = document.getElementById('unitSelect').value;
                this.patientWeight = parseFloat(document.getElementById('patientWeight').value) || 60;

                if (!name || isNaN(amount)) return alert("è–¬å‰¤åã¨æ‘‚å–é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if (unit === 'g') amount *= 1000;

                const info = this.masterData[name] || {
                    comp: "ä¸æ˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æœªç™»éŒ²ï¼‰",
                    toxicDose: 0,
                    toxicDoseMax: 0,
                    unit: "mg/kg",
                    symptoms: "ä¸æ˜",
                    antidote: "è¦èª¿æŸ»",
                    antidoteNote: "",
                    lavage: { valid: false, note: "è¦å€‹åˆ¥æ¤œè¨" },
                    charcoal: { valid: false, note: "è¦å€‹åˆ¥æ¤œè¨" },
                    dialysis: { valid: false, note: "è¦å€‹åˆ¥æ¤œè¨" },
                    other: "æ¯’ç‰©æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ç­‰ã«ç…§ä¼š",
                    unknown: true
                };

                const dosePerKg = amount / this.patientWeight;
                const toxicDose = info.toxicDose || 1;
                const severityScore = toxicDose > 0 ? (dosePerKg / toxicDose) : 0;

                this.drugs.push({ name, amount, dosePerKg, unit, info, severityScore });
                this.drugs.sort((a, b) => b.severityScore - a.severityScore);

                document.getElementById('drugInput').value = '';
                document.getElementById('amountInput').value = '';
                this.render();
            }

            removeDrug(index) {
                this.drugs.splice(index, 1);
                this.render();
            }

            getSeverityClass(score) {
                if (score >= 2) return 'severity-critical';
                if (score >= 1) return 'severity-high';
                if (score >= 0.5) return 'severity-mid';
                return 'severity-low';
            }

            getSeverityLabel(score) {
                if (score >= 2) return 'è‡´å‘½çš„';
                if (score >= 1) return 'é‡ç—‡';
                if (score >= 0.5) return 'ä¸­ç­‰ç—‡';
                return 'è»½ç—‡';
            }

            matchSymptoms(predicted, patientInput) {
                if (!patientInput || !predicted) return { match: 0, detail: [] };
                const synonyms = { "å˜”æ°—": ["æ‚ªå¿ƒ", "åãæ°—"], "æ‚ªå¿ƒ": ["å˜”æ°—", "åãæ°—"], "æ„è­˜éšœå®³": ["æ„è­˜æ··æ¿", "å‚¾çœ ", "æ˜è¿·"], "å‘¼å¸æŠ‘åˆ¶": ["å‘¼å¸ä½ä¸‹", "ç„¡å‘¼å¸"], "ç³å­”ç¸®å°": ["ç¸®ç³"], "ç³å­”æ•£å¤§": ["æ•£ç³"] };
                const predList = predicted.split(/[,ã€\s]+/).map(s => s.trim()).filter(Boolean);
                const patientList = patientInput.split(/[,ã€\s]+/).map(s => s.trim()).filter(Boolean);
                const matches = [];
                let matchCount = 0;
                predList.forEach(p => {
                    const alts = synonyms[p] || [p];
                    const found = patientList.some(pt => alts.some(a => pt.includes(a) || a.includes(pt)) || pt.includes(p) || p.includes(pt));
                    matches.push({ symptom: p, matched: found });
                    if (found) matchCount++;
                });
                return {
                    match: predList.length ? matchCount / predList.length : 0,
                    detail: matches,
                    matchCount,
                    total: predList.length
                };
            }

            render() {
                const listEl = document.getElementById('drugList');
                const treatEl = document.getElementById('treatmentSection');
                const treatDetailEl = document.getElementById('treatmentDetails');
                const symptomSection = document.getElementById('symptomMatchSection');
                const symptomResult = document.getElementById('symptomMatchResult');
                const patientSymptoms = document.getElementById('patientSymptoms').value;

                listEl.innerHTML = '';
                treatDetailEl.innerHTML = '';
                symptomResult.innerHTML = '';

                if (this.drugs.length > 0) {
                    treatEl.classList.remove('hidden');
                    symptomSection.classList.remove('hidden');
                }

                this.drugs.forEach((drug, index) => {
                    const sevClass = this.getSeverityClass(drug.severityScore);
                    const sevLabel = this.getSeverityLabel(drug.severityScore);

                    // Step 3: é‡ç—‡åº¦é †ãƒªã‚¹ãƒˆ
                    listEl.innerHTML += `
                        <div class="${sevClass} p-4 rounded-lg shadow flex justify-between items-start gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold bg-slate-800 text-white px-2 py-0.5 rounded">No.${index + 1}</span>
                                    <span class="text-xs font-bold px-2 py-0.5 rounded ${drug.severityScore >= 1 ? 'bg-red-600 text-white' : 'bg-amber-500 text-white'}">${sevLabel}</span>
                                    <button onclick="app.removeDrug(${index})" class="text-xs text-red-600 hover:text-red-800 ml-auto">å‰Šé™¤</button>
                                </div>
                                <h3 class="font-bold text-lg">${drug.name}</h3>
                                <p class="text-sm text-slate-600"><strong>æˆåˆ†:</strong> ${drug.info.comp}</p>
                                <p class="text-sm text-slate-600"><strong>ä¸­æ¯’é‡:</strong> ${drug.info.toxicDose || '?'}${drug.info.unit} ä»¥ä¸Š</p>
                                <p class="text-sm mt-2"><strong>äºˆæ¸¬ç—‡çŠ¶:</strong> <span class="text-red-700">${drug.info.symptoms}</span></p>
                            </div>
                            <div class="text-right shrink-0">
                                <div class="text-2xl font-black">${drug.dosePerKg.toFixed(2)}</div>
                                <div class="text-xs">${drug.info.unit} æ‘‚å–</div>
                                <div class="text-xs mt-1">é‡ç—‡åº¦æ¯”: ${(drug.severityScore * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    `;

                    // Step 4: ç—‡çŠ¶ç…§åˆ
                    const matchResult = this.matchSymptoms(drug.info.symptoms, patientSymptoms);
                    let matchHtml = '<div class="border rounded-lg p-3 ' + (matchResult.match >= 0.5 ? 'bg-green-50 border-green-200' : 'bg-amber-50 border-amber-200') + '">';
                    matchHtml += `<h4 class="font-bold mb-2">${drug.name}</h4>`;
                    matchHtml += `<p class="text-sm">ä¸€è‡´: ${matchResult.matchCount}/${matchResult.total} (${(matchResult.match * 100).toFixed(0)}%)</p>`;
                    matchHtml += '<div class="flex flex-wrap gap-1 mt-2">';
                    matchResult.detail.forEach(d => {
                        matchHtml += `<span class="px-2 py-0.5 rounded text-xs ${d.matched ? 'bg-green-200 match-yes' : 'bg-slate-200 match-no'}">${d.symptom}${d.matched ? ' âœ“' : ''}</span>`;
                    });
                    matchHtml += '</div></div>';
                    symptomResult.innerHTML += matchHtml;

                    // Step 5: æ²»ç™‚å¦¥å½“æ€§æ¤œè¨¼ï¼ˆobject/booleanä¸¡å¯¾å¿œï¼‰
                    const lavage = drug.info.lavage;
                    const charcoal = drug.info.charcoal;
                    const dialysis = drug.info.dialysis;
                    const getValid = (x) => (typeof x === 'object' ? x?.valid : x);
                    const getNote = (x) => (typeof x === 'object' ? x?.note : (x ? 'æœ‰åŠ¹' : 'éæ¨å¥¨'));

                    treatDetailEl.innerHTML += `
                        <div class="border-l-4 border-purple-600 pl-5">
                            <h3 class="font-black text-xl mb-4">${drug.name} ã®æ²»ç™‚å¦¥å½“æ€§æ¤œè¨¼</h3>
                            <table class="w-full text-sm border-collapse">
                                <tr class="border-b">
                                    <td class="py-3 font-bold w-28 bg-slate-50">æ‹®æŠ—è–¬</td>
                                    <td class="py-3 pl-3">
                                        <span class="font-semibold">${drug.info.antidote || 'ãªã—'}</span>
                                        ${drug.info.antidoteNote ? `<br><span class="text-slate-600 text-xs">${drug.info.antidoteNote}</span>` : ''}
                                    </td>
                                    <td class="py-3 w-24 text-center ${drug.info.antidote && !drug.info.unknown ? 'treatment-valid' : 'treatment-consider'}">
                                        ${drug.info.antidote && !drug.info.unknown ? 'âœ… æ¤œè¨' : 'âš ï¸ è¦æ¤œè¨'}
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-3 font-bold bg-slate-50">èƒƒæ´—æµ„</td>
                                    <td class="py-3 pl-3">${getNote(lavage) || 'è¦æ¤œè¨'}</td>
                                    <td class="py-3 text-center ${getValid(lavage) ? 'treatment-valid' : 'treatment-invalid'}">
                                        ${getValid(lavage) ? 'âœ… å¦¥å½“' : 'âŒ éæ¨å¥¨'}
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-3 font-bold bg-slate-50">æ´»æ€§ç‚­</td>
                                    <td class="py-3 pl-3">${getNote(charcoal) || 'è¦æ¤œè¨'}</td>
                                    <td class="py-3 text-center ${getValid(charcoal) ? 'treatment-valid' : 'treatment-invalid'}">
                                        ${getValid(charcoal) ? 'âœ… å¦¥å½“' : 'âŒ åŠ¹æœè–„/ç¦å¿Œ'}
                                    </td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-3 font-bold bg-slate-50">è¡€æ¶²æµ„åŒ–</td>
                                    <td class="py-3 pl-3">${getNote(dialysis) || 'è¦æ¤œè¨'}</td>
                                    <td class="py-3 text-center ${getValid(dialysis) ? 'treatment-consider' : 'treatment-invalid'}">
                                        ${getValid(dialysis) ? 'âš ï¸ é‡ç—‡æ™‚æ¤œè¨' : 'âŒ åŠ¹æœãªã—'}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="py-3 font-bold bg-slate-50">ãã®ä»–</td>
                                    <td class="py-3 pl-3" colspan="2">${drug.info.other || '-'}</td>
                                </tr>
                            </table>
                        </div>
                    `;
                });
            }
        }

        const app = new PoisoningApp();
        document.getElementById('patientSymptoms').addEventListener('input', () => app.render());
        document.getElementById('patientWeight').addEventListener('change', () => app.render());
    </script>
</body>
</html>
