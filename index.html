<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToxicNavi - ä¸­æ¯’è¨ºç™‚ãƒ•ãƒ­ãƒ¼æ”¯æ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .severity-critical { background: #7f1d1d; color: #fff; }
        .severity-high { background: #dc2626; color: #fff; }
        .severity-mid { background: #f59e0b; color: #fff; }
        .severity-low { background: #0ea5e9; color: #fff; }
        .severity-minimal { background: #16a34a; color: #fff; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-16">
    <header class="bg-slate-800 text-white shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>ğŸ§ª ToxicNavi</span>
                <span class="text-sm font-normal opacity-80">è–¬å‰¤ä¸­æ¯’ åˆæœŸè¨ºç™‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</span>
            </h1>
            <p class="text-xs text-amber-200">
                æ•™è‚²ãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã€‚å®Ÿè‡¨åºŠã§ã¯ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼/å°‚é–€åŒ»ã‚³ãƒ³ã‚µãƒ«ãƒˆã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 space-y-6">
        <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2">1) æ‚£è€…èƒŒæ™¯ã¨ç¾ç—‡å…¥åŠ›</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <label class="text-sm font-medium">
                    ä½“é‡ (kg)
                    <input id="patientWeight" type="number" min="1" value="60" class="mt-1 w-full border rounded p-2">
                </label>
                <label class="text-sm font-medium">
                    æ‘‚å–ã‹ã‚‰ã®æ™‚é–“ (åˆ†)
                    <input id="elapsedMinutes" type="number" min="0" value="90" class="mt-1 w-full border rounded p-2">
                </label>
                <label class="text-sm font-medium md:col-span-2">
                    æ‚£è€…ç—‡çŠ¶ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
                    <input id="observedSymptoms" type="text" placeholder="ä¾‹: å˜”å, æ„è­˜éšœå®³, é »è„ˆ" class="mt-1 w-full border rounded p-2">
                </label>
            </div>
            <div class="mt-3 flex items-center gap-2">
                <input id="airwaySecured" type="checkbox" class="h-4 w-4">
                <label for="airwaySecured" class="text-sm">æ°—é“ç¢ºä¿æ¸ˆã¿ï¼ˆèƒƒæ´—æµ„ã®å®‰å…¨æ€§è©•ä¾¡ã«ä½¿ç”¨ï¼‰</label>
            </div>
            <div class="mt-3">
                <p class="text-xs text-slate-500 mb-2">ç—‡çŠ¶ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›</p>
                <div id="symptomChips" class="flex flex-wrap gap-2"></div>
            </div>
        </section>

        <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2">2) æ‘‚å–è–¬å‰¤å…¥åŠ›ï¼ˆè£½å‰¤å/æˆåˆ†åã€å†…æœé‡ï¼‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <label class="text-sm font-medium md:col-span-2">
                    è–¬å‰¤åï¼ˆè£½å‰¤å or æˆåˆ†åï¼‰
                    <input id="drugInput" list="drugCandidates" type="text" placeholder="ä¾‹: ã‚«ãƒ­ãƒŠãƒ¼ãƒ«éŒ 500" class="mt-1 w-full border rounded p-2">
                </label>
                <datalist id="drugCandidates"></datalist>
                <label class="text-sm font-medium">
                    å†…æœé‡ (mg)
                    <input id="amountInput" type="number" min="0" placeholder="ä¾‹: 10000" class="mt-1 w-full border rounded p-2">
                </label>
                <div class="flex items-end gap-2">
                    <button id="addDrugBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 transition">
                        è¿½åŠ 
                    </button>
                    <button id="clearBtn" class="w-full bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded hover:bg-slate-300 transition">
                        å…¨æ¶ˆå»
                    </button>
                </div>
            </div>
            <p id="datasetStatus" class="mt-3 text-xs text-slate-500">
                å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ: èª­ã¿è¾¼ã¿ä¸­...
            </p>
        </section>

        <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-3 border-b pb-2">3) è¨ºç™‚ãƒ•ãƒ­ãƒ¼ï¼ˆè‡ªå‹•åŒ–ã—ã¦ã„ã‚‹å‡¦ç†ï¼‰</h2>
            <ol class="list-decimal pl-5 text-sm text-slate-700 space-y-1">
                <li>å…¥åŠ›ã—ãŸè–¬å‰¤åã‹ã‚‰è£½å‰¤ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ã€å«æœ‰æˆåˆ†ã‚’å±•é–‹</li>
                <li>æˆåˆ†ã”ã¨ã®æ¯’æ€§é–¾å€¤ï¼ˆä¸­æ¯’é‡ mg/kgï¼‰ã‚’å‚ç…§</li>
                <li>å†…æœé‡ã¨ä½“é‡ã‹ã‚‰æ‘‚å–é‡ mg/kg ã‚’ç®—å‡ºã—ã€é‡ç—‡åº¦ã‚’æ¨å®š</li>
                <li>é‡ç—‡åº¦ã‚¹ã‚³ã‚¢ã§å±é™ºåº¦é †ã«ã‚½ãƒ¼ãƒˆ</li>
                <li>äºˆæ¸¬ç—‡çŠ¶ã¨æ‚£è€…ç—‡çŠ¶ã®ä¸€è‡´ã‚’è©•ä¾¡</li>
                <li>æ‹®æŠ—è–¬ãƒ»èƒƒæ´—æµ„ãƒ»æ´»æ€§ç‚­ãƒ»è¡€æ¶²æµ„åŒ–ãƒ»ãã®ä»–æ²»ç™‚ã®å¦¥å½“æ€§ã‚’ç†ç”±ä»˜ãã§åˆ¤å®š</li>
            </ol>
        </section>

        <section>
            <h2 class="text-lg font-bold mb-3">4) é‡ç—‡åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé«˜ãƒªã‚¹ã‚¯é †ï¼‰</h2>
            <div id="priorityList" class="space-y-3">
                <p class="text-slate-400 text-center py-10 bg-white rounded-xl border border-slate-200">
                    è–¬å‰¤ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«è§£æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </p>
            </div>
        </section>

        <section id="treatmentSection" class="hidden bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2 text-red-700">5) æ²»ç™‚å¦¥å½“æ€§ã®æ¤œè¨¼</h2>
            <div id="treatmentMatrix" class="space-y-6"></div>
        </section>
    </main>

    <script>
        class ToxicNaviApp {
            constructor() {
                this.entries = [];
                this.entryCounter = 1;
                this.commonSymptoms = [
                    "å˜”æ°—", "å˜”å", "è…¹ç—›", "é »è„ˆ", "ä½è¡€åœ§", "ç—™æ”£", "æ„è­˜éšœå®³",
                    "å‘¼å¸æŠ‘åˆ¶", "ä¸æ•´è„ˆ", "ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "è€³é³´", "ç™ºæ±—"
                ];

                this.productDB = {
                    "ã‚«ãƒ­ãƒŠãƒ¼ãƒ«éŒ 500": [{ ingredient: "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³", ratio: 1 }],
                    "ãƒãƒ•ã‚¡ãƒªãƒ³A": [{ ingredient: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³", ratio: 0.85 }, { ingredient: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", ratio: 0.15 }],
                    "ã‚¨ã‚¹ã‚¿ãƒ­ãƒ³ãƒ¢ã‚«": [{ ingredient: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", ratio: 1 }],
                    "ã‚»ãƒ«ã‚·ãƒ³éŒ ": [{ ingredient: "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ", ratio: 1 }],
                    "ãƒ¡ãƒˆã‚°ãƒ«ã‚³éŒ ": [{ ingredient: "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³", ratio: 1 }],
                    "ãƒ†ã‚ªãƒ‰ãƒ¼ãƒ«éŒ ": [{ ingredient: "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³", ratio: 1 }],
                    "ãƒ–ãƒ­ãƒ³é…åˆéŒ ": [{ ingredient: "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³", ratio: 0.35 }, { ingredient: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", ratio: 0.15 }, { ingredient: "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³", ratio: 0.5 }],
                    "ä¸å‡æ¶²(ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«)": [{ ingredient: "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«", ratio: 1 }]
                };

                this.ingredientDB = {
                    "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³": {
                        component: "Acetaminophen",
                        toxicDoseMgKg: 150,
                        severeDoseMgKg: 250,
                        criticalDoseMgKg: 300,
                        symptoms: ["å˜”æ°—", "å˜”å", "è…¹ç—›", "è‚æ©Ÿèƒ½éšœå®³", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["æ„è­˜éšœå®³"],
                        antidote: { name: "N-ã‚¢ã‚»ãƒãƒ«ã‚·ã‚¹ãƒ†ã‚¤ãƒ³", indication: "æ‘‚å–é‡ 150 mg/kg è¶…ã€ã¾ãŸã¯è¡€ä¸­æ¿ƒåº¦ã§æ²»ç™‚åŸŸè¶…é" },
                        lavage: { allow: true, windowMin: 60, note: "è‡´æ­»é‡ãŒç–‘ã‚ã‚Œã‚‹æ—©æœŸä¾‹ã§ã®ã¿æ¤œè¨" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "å¾æ”¾è£½å‰¤ã§ã¯å»¶é•·ã—ã¦æ¤œè¨" },
                        dialysis: { effective: false, indication: "é€šå¸¸ã¯é©å¿œå¤–" },
                        otherTreatments: [
                            { name: "è¡€ä¸­æ¿ƒåº¦æ¸¬å®š", severityMin: 2, note: "4æ™‚é–“ä»¥é™ã®æ¿ƒåº¦ã‚’è©•ä¾¡ã—ã¦æ²»ç™‚ç¶™ç¶šåˆ¤æ–­" },
                            { name: "è‚æ©Ÿèƒ½/å‡å›ºãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°", severityMin: 2, note: "AST/ALT/INRã‚’é€£ç¶šè©•ä¾¡" }
                        ]
                    },
                    "ã‚¢ã‚¹ãƒ”ãƒªãƒ³": {
                        component: "Aspirin",
                        toxicDoseMgKg: 150,
                        severeDoseMgKg: 300,
                        criticalDoseMgKg: 500,
                        symptoms: ["éæ›æ°—", "è€³é³´", "å˜”å", "ç™ºç†±", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["æ„è­˜éšœå®³", "éæ›æ°—"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "å°¿ã‚¢ãƒ«ã‚«ãƒªåŒ–ãƒ»æ”¯æŒç™‚æ³•ãŒä¸­å¿ƒ" },
                        lavage: { allow: true, windowMin: 60, note: "å¤§é‡æ‘‚å–ã§1æ™‚é–“ä»¥å†…ãªã‚‰æ¤œè¨" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "å¤§é‡æ‘‚å–æ™‚ã¯å†æŠ•ä¸ã‚’æ¤œè¨" },
                        dialysis: { effective: true, indication: "é‡ç—‡ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã€è…éšœå®³ã€ç¥çµŒç—‡çŠ¶ã§é©å¿œ" },
                        otherTreatments: [
                            { name: "å°¿ã‚¢ãƒ«ã‚«ãƒªåŒ–", severityMin: 3, note: "ç‚­é…¸æ°´ç´ ãƒŠãƒˆãƒªã‚¦ãƒ ã§æ’æ³„ä¿ƒé€²" },
                            { name: "ä½“æ¸©ç®¡ç†", severityMin: 2, note: "é«˜ä½“æ¸©ã¯äºˆå¾Œæ‚ªåŒ–å› å­" }
                        ]
                    },
                    "ã‚«ãƒ•ã‚§ã‚¤ãƒ³": {
                        component: "Caffeine",
                        toxicDoseMgKg: 15,
                        severeDoseMgKg: 30,
                        criticalDoseMgKg: 80,
                        symptoms: ["é »è„ˆ", "èˆˆå¥®", "æŒ¯æˆ¦", "ä¸æ•´è„ˆ", "ç—™æ”£"],
                        criticalSymptoms: ["ä¸æ•´è„ˆ", "ç—™æ”£"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "å¾ªç’°ç®¡ç†ã¨ç—™æ”£ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«" },
                        lavage: { allow: true, windowMin: 60, note: "é«˜ç”¨é‡æ‘‚å–ç›´å¾Œã§ã‚ã‚Œã°è€ƒæ…®" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "æ—©æœŸæŠ•ä¸ã»ã©æœ‰åŠ¹" },
                        dialysis: { effective: true, indication: "é›£æ²»æ€§ä¸æ•´è„ˆã‚„é‡ç¯¤ä¸­æ¯’ã§æ¤œè¨" },
                        otherTreatments: [
                            { name: "ä¸æ•´è„ˆç›£è¦–", severityMin: 2, note: "æŒç¶šãƒ¢ãƒ‹ã‚¿ãƒ¼ç®¡ç†" },
                            { name: "ç—™æ”£æ™‚ãƒ™ãƒ³ã‚¾ã‚¸ã‚¢ã‚¼ãƒ”ãƒ³", severityMin: 3, symptomAny: ["ç—™æ”£"], note: "ç—™æ”£ç®¡ç†ã‚’å„ªå…ˆ" }
                        ]
                    },
                    "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ": {
                        component: "Diazepam",
                        toxicDoseMgKg: 0.5,
                        severeDoseMgKg: 1.5,
                        criticalDoseMgKg: 3,
                        symptoms: ["å‚¾çœ ", "æ§‹èªéšœå®³", "å‘¼å¸æŠ‘åˆ¶", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["å‘¼å¸æŠ‘åˆ¶", "æ„è­˜éšœå®³"],
                        antidote: { name: "ãƒ•ãƒ«ãƒã‚¼ãƒ‹ãƒ«", indication: "é©å¿œã‚’å³å¯†ã«è©•ä¾¡ï¼ˆä¾å­˜ãƒ»ç—™æ”£ãƒªã‚¹ã‚¯ã«æ³¨æ„ï¼‰" },
                        lavage: { allow: false, windowMin: 0, note: "é€šå¸¸æ¨å¥¨ã•ã‚Œãªã„" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "æ°—é“ä¿è­·ãŒå‰æ" },
                        dialysis: { effective: false, indication: "åŠ¹æœä¹ã—ã„" },
                        otherTreatments: [
                            { name: "æ°—é“/å‘¼å¸ç®¡ç†", severityMin: 3, symptomAny: ["å‘¼å¸æŠ‘åˆ¶"], note: "SpO2ä½ä¸‹æ™‚ã¯æ—©æœŸä»‹å…¥" }
                        ]
                    },
                    "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³": {
                        component: "Metformin",
                        toxicDoseMgKg: 50,
                        severeDoseMgKg: 100,
                        criticalDoseMgKg: 200,
                        symptoms: ["å˜”å", "è…¹ç—›", "é »å‘¼å¸", "ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "æ„è­˜éšœå®³"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "ä¹³é…¸ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ç®¡ç†ãŒä¸­å¿ƒ" },
                        lavage: { allow: false, windowMin: 0, note: "é€šå¸¸ã¯é©å¿œä¹ã—ã„" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 180, note: "æ—©æœŸä¾‹ã§ã®ã¿æœ‰åŠ¹æ€§ãŒæœŸå¾…" },
                        dialysis: { effective: true, indication: "é‡åº¦ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ãƒ»è…ä¸å…¨ã§å¼·ãæ¨å¥¨" },
                        otherTreatments: [
                            { name: "ä¹³é…¸/è¡€æ¶²ã‚¬ã‚¹æ¸¬å®š", severityMin: 2, note: "ä¹³é…¸ä¸Šæ˜‡ã‚’é€£ç¶šè©•ä¾¡" },
                            { name: "å¾ªç’°ç®¡ç†", severityMin: 3, note: "ã‚·ãƒ§ãƒƒã‚¯å¾´å€™ã¸æ—©æœŸå¯¾å¿œ" }
                        ]
                    },
                    "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³": {
                        component: "Theophylline",
                        toxicDoseMgKg: 10,
                        severeDoseMgKg: 20,
                        criticalDoseMgKg: 40,
                        symptoms: ["å˜”å", "é »è„ˆ", "ä¸æ•´è„ˆ", "ä½è¡€åœ§", "ç—™æ”£"],
                        criticalSymptoms: ["ç—™æ”£", "ä¸æ•´è„ˆ"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "ç—™æ”£ãƒ»ä¸æ•´è„ˆç®¡ç†ã‚’å„ªå…ˆ" },
                        lavage: { allow: true, windowMin: 60, note: "å¤§é‡æ‘‚å–ç›´å¾Œã§è€ƒæ…®" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 360, note: "å¤šå›æŠ•ä¸ã®é©å¿œã‚’æ¤œè¨" },
                        dialysis: { effective: true, indication: "é‡ç—‡ä¸­æ¯’ã€ç—™æ”£ã€é›£æ²»æ€§ä¸æ•´è„ˆã§é©å¿œ" },
                        otherTreatments: [
                            { name: "å¤šå›æ´»æ€§ç‚­ã®æ¤œè¨", severityMin: 3, note: "å†å¾ªç’°ã‚’æŠ‘åˆ¶" },
                            { name: "ç—™æ”£æ™‚é®é™æ²»ç™‚", severityMin: 3, symptomAny: ["ç—™æ”£"], note: "ãƒ™ãƒ³ã‚¾ã‚¸ã‚¢ã‚¼ãƒ”ãƒ³ã‚’å„ªå…ˆ" }
                        ]
                    },
                    "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³": {
                        component: "Dihydrocodeine",
                        toxicDoseMgKg: 1,
                        severeDoseMgKg: 2,
                        criticalDoseMgKg: 4,
                        symptoms: ["ç¸®ç³", "å‚¾çœ ", "å‘¼å¸æŠ‘åˆ¶", "ä½é…¸ç´ "],
                        criticalSymptoms: ["å‘¼å¸æŠ‘åˆ¶", "ä½é…¸ç´ "],
                        antidote: { name: "ãƒŠãƒ­ã‚­ã‚½ãƒ³", indication: "å‘¼å¸æŠ‘åˆ¶ã¾ãŸã¯æ„è­˜éšœå®³ã§é€Ÿã‚„ã‹ã«æŠ•ä¸" },
                        lavage: { allow: false, windowMin: 0, note: "èª¤åš¥ãƒªã‚¹ã‚¯ã‚’è€ƒæ…®ã—é€šå¸¸éæ¨å¥¨" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "æ°—é“ä¿è­·ä¸‹ã§æ¤œè¨" },
                        dialysis: { effective: false, indication: "é€šå¸¸ä¸è¦" },
                        otherTreatments: [
                            { name: "å‘¼å¸ç®¡ç†", severityMin: 3, symptomAny: ["å‘¼å¸æŠ‘åˆ¶", "ä½é…¸ç´ "], note: "æ›æ°—è£œåŠ©ã‚’æ—©æœŸã«åˆ¤æ–­" }
                        ]
                    },
                    "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³": {
                        component: "Methylephedrine",
                        toxicDoseMgKg: 2,
                        severeDoseMgKg: 5,
                        criticalDoseMgKg: 10,
                        symptoms: ["é »è„ˆ", "ä¸ç©", "é«˜è¡€åœ§", "ä¸æ•´è„ˆ"],
                        criticalSymptoms: ["ä¸æ•´è„ˆ"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "å¾ªç’°å‹•æ…‹ã«å¿œã˜ãŸå¯¾ç—‡ç™‚æ³•" },
                        lavage: { allow: true, windowMin: 60, note: "é‡ç—‡æ‘‚å–ç›´å¾Œã®ã¿" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 180, note: "æ—©æœŸæŠ•ä¸ã‚’æ¤œè¨" },
                        dialysis: { effective: false, indication: "é€šå¸¸åŠ¹æœä¹ã—ã„" },
                        otherTreatments: [
                            { name: "é®é™ãƒ»å¾ªç’°ç®¡ç†", severityMin: 2, note: "èˆˆå¥®ã‚„é‡åº¦é »è„ˆã‚’åˆ¶å¾¡" }
                        ]
                    },
                    "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«": {
                        component: "Ethylene glycol",
                        toxicDoseMgKg: 50,
                        severeDoseMgKg: 100,
                        criticalDoseMgKg: 150,
                        symptoms: ["é…©é…Šæ§˜ç—‡çŠ¶", "é »å‘¼å¸", "ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "è…éšœå®³", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "æ„è­˜éšœå®³"],
                        antidote: { name: "ãƒ›ãƒ¡ãƒ”ã‚¾ãƒ¼ãƒ«ï¼ˆã¾ãŸã¯ã‚¨ã‚¿ãƒãƒ¼ãƒ«ç™‚æ³•ï¼‰", indication: "ç–‘ã„æ®µéšã§æ—©æœŸé–‹å§‹ã‚’æ¤œè¨" },
                        lavage: { allow: false, windowMin: 0, note: "é€šå¸¸æ¨å¥¨ã•ã‚Œãªã„" },
                        charcoal: { allow: false, windowMin: 0, extendedWindowMin: 0, note: "å¸ç€åŠ¹æœãŒä¹ã—ã„" },
                        dialysis: { effective: true, indication: "ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã€è…éšœå®³ã€é‡ç—‡ä¾‹ã§ç©æ¥µé©å¿œ" },
                        otherTreatments: [
                            { name: "ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹è£œæ­£", severityMin: 3, note: "é‡ç‚­é…¸æŠ•ä¸ã‚’æ¤œè¨" },
                            { name: "è…æ©Ÿèƒ½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°", severityMin: 2, note: "Crã¨å°¿é‡ã‚’é€£ç¶šè©•ä¾¡" }
                        ]
                    }
                };

                this.ingredientSynonyms = {
                    "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³ãƒªãƒ³é…¸å¡©": "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³",
                    "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³ãƒªãƒ³é…¸å¡©æ°´å’Œç‰©": "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³",
                    "ç„¡æ°´ã‚«ãƒ•ã‚§ã‚¤ãƒ³": "ã‚«ãƒ•ã‚§ã‚¤ãƒ³",
                    "ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ°´å’Œç‰©": "ã‚«ãƒ•ã‚§ã‚¤ãƒ³",
                    "dl-ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "dlãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "d-ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "l-ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "ã‚¢ã‚»ãƒãƒ«ã‚µãƒªãƒãƒ«é…¸": "ã‚¢ã‚¹ãƒ”ãƒªãƒ³"
                };
                this.ingredientHeuristicSynonyms = [
                    { keyword: "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³", canonical: "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³" },
                    { keyword: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³", canonical: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³" },
                    { keyword: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", canonical: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³" },
                    { keyword: "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³", canonical: "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³" },
                    { keyword: "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³", canonical: "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³" },
                    { keyword: "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ", canonical: "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ " },
                    { keyword: "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³", canonical: "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³" },
                    { keyword: "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³", canonical: "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³" },
                    { keyword: "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«", canonical: "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«" }
                ];
                this.ingredientSynonymIndex = {};
                Object.entries(this.ingredientSynonyms).forEach(([alias, canonical]) => {
                    this.ingredientSynonymIndex[this.normalizeName(alias)] = canonical;
                });

                this.datasetLoaded = false;
                this.bindEvents();
                this.populateDrugCandidates();
                this.renderSymptomChips();
                this.loadExternalDatasets();
            }

            bindEvents() {
                document.getElementById("addDrugBtn").addEventListener("click", () => this.addDrug());
                document.getElementById("clearBtn").addEventListener("click", () => this.clearAll());
                document.getElementById("amountInput").addEventListener("keydown", (event) => {
                    if (event.key === "Enter") this.addDrug();
                });
                document.getElementById("drugInput").addEventListener("keydown", (event) => {
                    if (event.key === "Enter") this.addDrug();
                });
                document.getElementById("priorityList").addEventListener("click", (event) => {
                    const button = event.target.closest("[data-remove-id]");
                    if (!button) return;
                    this.removeEntry(Number(button.dataset.removeId));
                });
            }

            setDatasetStatus(message, tone = "info") {
                const statusEl = document.getElementById("datasetStatus");
                if (!statusEl) return;
                statusEl.textContent = message;

                statusEl.classList.remove("text-slate-500", "text-green-700", "text-amber-700");
                if (tone === "success") {
                    statusEl.classList.add("text-green-700");
                } else if (tone === "warn") {
                    statusEl.classList.add("text-amber-700");
                } else {
                    statusEl.classList.add("text-slate-500");
                }
            }

            parseAmountToken(amountText) {
                const normalized = String(amountText || "")
                    .replaceAll("ï¼…", "%")
                    .replace(/\s+/g, " ")
                    .trim();
                const match = normalized.match(/^([0-9]+(?:\.[0-9]+)?)\s*(mg|g|ml|mL|Î¼g|Âµg|mcg|%|IU|å˜ä½|å›½éš›å˜ä½|mEq)$/i);
                if (!match) return null;
                return {
                    value: Number(match[1]),
                    unit: match[2].toLowerCase()
                };
            }

            canonicalizeIngredientName(name) {
                const raw = String(name || "").trim();
                if (!raw) return "";

                const direct = this.findKeyByNormalizedName(this.ingredientDB, raw);
                if (direct) return direct;

                const byAlias = this.ingredientSynonymIndex[this.normalizeName(raw)];
                if (byAlias) return byAlias;

                const stripped = raw
                    .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, "")
                    .replace(/\([^)]*\)/g, "")
                    .replace(/^ç„¡æ°´/, "")
                    .replace(/æ°´å’Œç‰©$/, "")
                    .replace(/å¡©é…¸å¡©$/, "")
                    .replace(/ãƒªãƒ³é…¸å¡©$/, "")
                    .replace(/è‡­åŒ–æ°´ç´ é…¸å¡©(?:æ°´å’Œç‰©)?$/, "")
                    .replace(/ãƒãƒ¬ã‚¤ãƒ³é…¸å¡©$/, "")
                    .replace(/ç¡«é…¸å¡©$/, "")
                    .replace(/^[dDlL]+[-ï¼]?/, "")
                    .trim();

                if (stripped) {
                    const directStripped = this.findKeyByNormalizedName(this.ingredientDB, stripped);
                    if (directStripped) return directStripped;
                    const byAliasStripped = this.ingredientSynonymIndex[this.normalizeName(stripped)];
                    if (byAliasStripped) return byAliasStripped;
                }

                for (const rule of this.ingredientHeuristicSynonyms) {
                    if (raw.includes(rule.keyword) || stripped.includes(rule.keyword)) {
                        return rule.canonical;
                    }
                }

                return raw;
            }

            canonicalizeIngredientRatios(ratioDefs) {
                const merged = {};
                ratioDefs.forEach((item) => {
                    const canonical = this.canonicalizeIngredientName(item.ingredient);
                    const ratio = Number(item.ratio);
                    if (!canonical || !Number.isFinite(ratio) || ratio <= 0) return;
                    merged[canonical] = (merged[canonical] || 0) + ratio;
                });

                const mergedList = Object.entries(merged).map(([ingredient, ratio]) => ({ ingredient, ratio }));
                const totalRatio = mergedList.reduce((sum, item) => sum + item.ratio, 0);
                if (!Number.isFinite(totalRatio) || totalRatio <= 0) return [];
                return mergedList.map((item) => ({
                    ingredient: item.ingredient,
                    ratio: item.ratio / totalRatio
                }));
            }

            calculateIngredientRatios(ingredients) {
                const normalized = ingredients.map((item) => {
                    const ingredient = String(item.name || "")
                        .trim()
                        .replace(/^[ãƒ»\-]+/, "")
                        .replace(/\s+/g, " ");
                    const parsed = this.parseAmountToken(item.amount || "");
                    return { ingredient, parsed };
                }).filter((item) => item.ingredient);

                if (normalized.length === 0) return [];

                const parsedOnly = normalized.filter((item) => item.parsed && Number.isFinite(item.parsed.value) && item.parsed.value > 0);
                const unitSet = new Set(parsedOnly.map((item) => item.parsed.unit));
                const canWeighted = parsedOnly.length === normalized.length && unitSet.size === 1;

                if (canWeighted) {
                    const total = parsedOnly.reduce((sum, item) => sum + item.parsed.value, 0);
                    if (total > 0) {
                        return normalized.map((item) => ({
                            ingredient: item.ingredient,
                            ratio: item.parsed.value / total
                        }));
                    }
                }

                const equalRatio = 1 / normalized.length;
                return normalized.map((item) => ({
                    ingredient: item.ingredient,
                    ratio: equalRatio
                }));
            }

            buildUnknownIngredientInfo() {
                return {
                    component: "Unknown",
                    toxicDoseMgKg: null,
                    severeDoseMgKg: null,
                    criticalDoseMgKg: null,
                    symptoms: ["æƒ…å ±ä¸è¶³"],
                    criticalSymptoms: [],
                    antidote: { name: "è¦æƒ…å ±ç¢ºèª", indication: "è£½å‰¤æƒ…å ±ã€æˆåˆ†ã€æ¯’æ€§ãƒ‡ãƒ¼ã‚¿ã‚’è‡³æ€¥ç¢ºèª" },
                    lavage: { allow: false, windowMin: 0, note: "æ¯’æ€§ä¸æ˜ã®ãŸã‚æ…é‡åˆ¤æ–­" },
                    charcoal: { allow: false, windowMin: 0, extendedWindowMin: 0, note: "é©å¿œå¯å¦ã‚’ç¢ºèª" },
                    dialysis: { effective: false, indication: "æˆåˆ†ç‰¹æ€§ã®ç¢ºèªãŒå¿…è¦" },
                    otherTreatments: [{ name: "ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ã¸ç…§ä¼š", severityMin: 1, note: "ä¸æ˜æˆåˆ†ã¯ä¸€æ¬¡æƒ…å ±ã‚’åé›†" }],
                    unknown: true
                };
            }

            mergeProductsToDatabase(products) {
                let addedProducts = 0;
                let addedIngredients = 0;

                products.forEach((product) => {
                    const productName = String(product.product_name || "").trim();
                    const sourceIngredients = Array.isArray(product.ingredients) ? product.ingredients : [];
                    const ratioDefs = this.canonicalizeIngredientRatios(this.calculateIngredientRatios(sourceIngredients));
                    if (!productName || ratioDefs.length === 0) return;

                    if (!this.productDB[productName]) {
                        this.productDB[productName] = ratioDefs;
                        addedProducts += 1;
                    }

                    ratioDefs.forEach((item) => {
                        if (!this.ingredientDB[item.ingredient]) {
                            this.ingredientDB[item.ingredient] = this.buildUnknownIngredientInfo();
                            addedIngredients += 1;
                        }
                    });
                });

                return { addedProducts, addedIngredients };
            }

            async loadDatasetFile(path, label) {
                const response = await fetch(path, { cache: "no-store" });
                if (!response.ok) throw new Error(`${label}: HTTP ${response.status}`);

                const payload = await response.json();
                const products = Array.isArray(payload.products) ? payload.products : [];
                const merged = this.mergeProductsToDatabase(products);
                return {
                    label,
                    loadedProducts: products.length,
                    addedProducts: merged.addedProducts,
                    addedIngredients: merged.addedIngredients
                };
            }

            async loadExternalDatasets() {
                this.setDatasetStatus("å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...");
                const loaded = [];

                try {
                    loaded.push(await this.loadDatasetFile("data/pmda_otc_products.json", "PMDA-OTC"));
                } catch (error) {
                    // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¸ç¶™ç¶š
                }

                try {
                    loaded.push(await this.loadDatasetFile("data/pmda_iyaku_products.json", "PMDA-åŒ»ç™‚ç”¨"));
                } catch (error) {
                    // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯å†…è”µãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ç¶™ç¶š
                }

                this.populateDrugCandidates();
                this.datasetLoaded = loaded.length > 0;

                if (loaded.length === 0) {
                    this.setDatasetStatus("å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆå†…è”µãƒ‡ãƒ¼ã‚¿ã®ã¿åˆ©ç”¨ï¼‰", "warn");
                    return;
                }

                const totalAddedProducts = loaded.reduce((sum, item) => sum + item.addedProducts, 0);
                const totalAddedIngredients = loaded.reduce((sum, item) => sum + item.addedIngredients, 0);
                const sourceLabel = loaded.map((item) => item.label).join(" / ");
                this.setDatasetStatus(
                    `${sourceLabel} èª­è¾¼å®Œäº†: è£½å“ +${totalAddedProducts} ä»¶ / æ–°è¦æˆåˆ† +${totalAddedIngredients} ä»¶`,
                    "success"
                );
            }

            renderSymptomChips() {
                const chipArea = document.getElementById("symptomChips");
                chipArea.innerHTML = this.commonSymptoms.map((symptom) => `
                    <button type="button" class="text-xs border border-slate-300 rounded-full px-3 py-1 hover:bg-slate-100" data-chip="${this.escapeHTML(symptom)}">
                        ${this.escapeHTML(symptom)}
                    </button>
                `).join("");

                chipArea.addEventListener("click", (event) => {
                    const chip = event.target.closest("[data-chip]");
                    if (!chip) return;
                    this.appendSymptom(chip.dataset.chip);
                });
            }

            appendSymptom(symptom) {
                const symptomInput = document.getElementById("observedSymptoms");
                const currentSymptoms = this.parseSymptoms(symptomInput.value);
                if (!currentSymptoms.includes(symptom)) {
                    currentSymptoms.push(symptom);
                    symptomInput.value = currentSymptoms.join(", ");
                }
            }

            populateDrugCandidates() {
                const datalist = document.getElementById("drugCandidates");
                const candidates = [
                    ...Object.keys(this.productDB),
                    ...Object.keys(this.ingredientDB)
                ].sort((a, b) => a.localeCompare(b, "ja"));
                datalist.innerHTML = candidates.map((name) => `<option value="${this.escapeHTML(name)}"></option>`).join("");
            }

            addDrug() {
                const drugInput = document.getElementById("drugInput");
                const amountInput = document.getElementById("amountInput");
                const patientWeight = Number(document.getElementById("patientWeight").value);
                const elapsedMin = Number(document.getElementById("elapsedMinutes").value);
                const airwaySecured = document.getElementById("airwaySecured").checked;
                const observedSymptoms = this.parseSymptoms(document.getElementById("observedSymptoms").value);

                const drugName = drugInput.value.trim();
                const amountMg = Number(amountInput.value);

                if (!drugName || !Number.isFinite(amountMg) || amountMg <= 0) {
                    alert("è–¬å‰¤åã¨å†…æœé‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                if (!Number.isFinite(patientWeight) || patientWeight <= 0) {
                    alert("ä½“é‡(kg)ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                if (!Number.isFinite(elapsedMin) || elapsedMin < 0) {
                    alert("æ‘‚å–ã‹ã‚‰ã®æ™‚é–“(åˆ†)ã‚’0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                const ingestionContext = {
                    patientWeight,
                    elapsedMin,
                    airwaySecured,
                    observedSymptoms
                };

                const resolved = this.resolveDrugToIngredients(drugName, amountMg);
                resolved.ingredients.forEach((ingredientItem) => {
                    const amountForIngredient = amountMg * ingredientItem.ratio;
                    const ingredientInfo = this.getIngredientInfo(ingredientItem.ingredient);
                    const doseMgKg = amountForIngredient / patientWeight;
                    const severity = this.classifySeverity(doseMgKg, ingredientInfo);
                    const predictedSymptoms = ingredientInfo.symptoms || [];
                    const matchedSymptoms = this.matchSymptoms(predictedSymptoms, observedSymptoms);
                    const toxicRatio = ingredientInfo.toxicDoseMgKg ? (doseMgKg / ingredientInfo.toxicDoseMgKg) : null;

                    const treatment = this.evaluateTreatments({
                        ingredientInfo,
                        severity,
                        doseMgKg,
                        toxicRatio,
                        context: ingestionContext,
                        matchedSymptoms
                    });

                    const riskScore = this.calculateRiskScore(severity, toxicRatio, matchedSymptoms.length, ingredientInfo.unknown);

                    this.entries.push({
                        id: this.entryCounter++,
                        sourceDrug: resolved.sourceName,
                        inputDrug: drugName,
                        ingredient: ingredientItem.ingredient,
                        component: ingredientInfo.component,
                        ingredientAmountMg: amountForIngredient,
                        doseMgKg,
                        toxicRatio,
                        severity,
                        predictedSymptoms,
                        matchedSymptoms,
                        treatment,
                        riskScore,
                        unknown: ingredientInfo.unknown
                    });
                });

                this.entries.sort((a, b) => b.riskScore - a.riskScore);
                this.render();

                amountInput.value = "";
                drugInput.value = "";
                drugInput.focus();
            }

            resolveDrugToIngredients(drugName, amountMg) {
                const matchedProductKey = this.findKeyByNormalizedName(this.productDB, drugName);
                if (matchedProductKey) {
                    const ingredientDefs = this.canonicalizeIngredientRatios(this.productDB[matchedProductKey]);
                    const ratioTotal = ingredientDefs.reduce((sum, item) => sum + item.ratio, 0) || 1;
                    return {
                        sourceName: matchedProductKey,
                        ingredients: ingredientDefs.map((item) => ({
                            ingredient: item.ingredient,
                            ratio: item.ratio / ratioTotal
                        })),
                        totalAmountMg: amountMg
                    };
                }

                const canonicalDrugName = this.canonicalizeIngredientName(drugName);
                const matchedIngredientKey = this.findKeyByNormalizedName(this.ingredientDB, canonicalDrugName);
                if (matchedIngredientKey) {
                    return {
                        sourceName: matchedIngredientKey,
                        ingredients: [{ ingredient: matchedIngredientKey, ratio: 1 }],
                        totalAmountMg: amountMg
                    };
                }

                return {
                    sourceName: `${drugName} (ãƒ‡ãƒ¼ã‚¿æœªç™»éŒ²)`,
                    ingredients: [{ ingredient: canonicalDrugName || drugName, ratio: 1 }],
                    totalAmountMg: amountMg
                };
            }

            getIngredientInfo(ingredientName) {
                const canonicalName = this.canonicalizeIngredientName(ingredientName);
                const matchedKey = this.findKeyByNormalizedName(this.ingredientDB, canonicalName);
                if (matchedKey) return this.ingredientDB[matchedKey];
                return this.buildUnknownIngredientInfo();
            }

            classifySeverity(doseMgKg, ingredientInfo) {
                if (!ingredientInfo.toxicDoseMgKg) {
                    return { label: "æƒ…å ±ä¸è¶³", rank: 3, badgeClass: "severity-mid", detail: "ä¸­æ¯’é‡ãƒ‡ãƒ¼ã‚¿ãªã—" };
                }
                if (doseMgKg >= ingredientInfo.criticalDoseMgKg) {
                    return { label: "æœ€é‡ç—‡", rank: 5, badgeClass: "severity-critical", detail: "è‡´æ­»åŸŸã®å¯èƒ½æ€§" };
                }
                if (doseMgKg >= ingredientInfo.severeDoseMgKg) {
                    return { label: "é‡ç—‡", rank: 4, badgeClass: "severity-high", detail: "é›†ä¸­æ²»ç™‚ã‚’è¦ã™ã‚‹å¯èƒ½æ€§" };
                }
                if (doseMgKg >= ingredientInfo.toxicDoseMgKg) {
                    return { label: "ä¸­ç­‰ç—‡", rank: 3, badgeClass: "severity-mid", detail: "ä¸­æ¯’åŸŸã«åˆ°é”" };
                }
                if (doseMgKg >= ingredientInfo.toxicDoseMgKg * 0.5) {
                    return { label: "è»½ç—‡", rank: 2, badgeClass: "severity-low", detail: "ç—‡çŠ¶ç™ºç¾ã«æ³¨æ„" };
                }
                return { label: "ä½ãƒªã‚¹ã‚¯", rank: 1, badgeClass: "severity-minimal", detail: "ç¾æ™‚ç‚¹ã§ã¯ä½ãƒªã‚¹ã‚¯" };
            }

            calculateRiskScore(severity, toxicRatio, matchCount, isUnknown) {
                if (isUnknown) return 320 + (matchCount * 8);
                const ratioScore = toxicRatio ? Math.min(100, toxicRatio * 30) : 0;
                return severity.rank * 100 + ratioScore + (matchCount * 8);
            }

            parseSymptoms(symptomText) {
                if (!symptomText) return [];
                const parsed = symptomText.split(/[,ã€\n]/).map((item) => item.trim()).filter(Boolean);
                return [...new Set(parsed)];
            }

            matchSymptoms(predicted, observed) {
                const matches = predicted.filter((predictedSymptom) => {
                    return observed.some((observedSymptom) => {
                        return observedSymptom.includes(predictedSymptom) || predictedSymptom.includes(observedSymptom);
                    });
                });
                return [...new Set(matches)];
            }

            evaluateTreatments(payload) {
                const { ingredientInfo, severity, toxicRatio, context, matchedSymptoms } = payload;
                if (ingredientInfo.unknown) {
                    return {
                        antidote: { status: "è¦æƒ…å ±ç¢ºèª", action: "æˆåˆ†ç‰¹å®šã‚’å„ªå…ˆ", reason: "æ‹®æŠ—è–¬ã®é©å¿œåˆ¤å®šã«æˆåˆ†åŒå®šãŒå¿…é ˆ" },
                        lavage: { status: "è¦æƒ…å ±ç¢ºèª", action: "æ¯’æ€§æƒ…å ±ç¢ºèªå¾Œã«åˆ¤æ–­", reason: "æ¯’æ€§ãƒ»èª¤åš¥ãƒªã‚¹ã‚¯ã®è©•ä¾¡ãŒæœªç¢ºå®š" },
                        charcoal: { status: "è¦æƒ…å ±ç¢ºèª", action: "å¸ç€æ€§ã‚’ç¢ºèª", reason: "æˆåˆ†ã®å¸ç€å¯å¦ãƒ‡ãƒ¼ã‚¿ãŒãªã„" },
                        dialysis: { status: "è¦æƒ…å ±ç¢ºèª", action: "è¡€æ¶²æµ„åŒ–ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª", reason: "è›‹ç™½çµåˆç‡/åˆ†å¸ƒå®¹ç©ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦" },
                        others: [{ name: "ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ã¸å³æ™‚ç…§ä¼š", status: "å¦¥å½“", reason: "ä¸æ˜æˆåˆ†ã®åˆæœŸå¯¾å¿œã¨ã—ã¦å¿…é ˆ" }]
                    };
                }

                const hasCriticalSymptom = matchedSymptoms.some((symptom) => ingredientInfo.criticalSymptoms.includes(symptom));
                const toxicExceeded = typeof toxicRatio === "number" && toxicRatio >= 1;

                const antidote = (() => {
                    const action = ingredientInfo.antidote.name;
                    if (action.includes("ãªã—")) {
                        return { status: "é©å¿œãªã—", action, reason: ingredientInfo.antidote.indication };
                    }
                    if (severity.rank >= 3 || hasCriticalSymptom || toxicExceeded) {
                        return { status: "å¦¥å½“", action, reason: ingredientInfo.antidote.indication };
                    }
                    return { status: "æ¡ä»¶ä»˜ã", action, reason: `ç¾æ™‚ç‚¹ã¯ä½ã€œè»½ç—‡ã€‚ãŸã ã— ${ingredientInfo.antidote.indication}` };
                })();

                const lavage = (() => {
                    if (!ingredientInfo.lavage.allow) {
                        return { status: "éæ¨å¥¨", action: "èƒƒæ´—æµ„ã‚’é€šå¸¸ã¯è¡Œã‚ãªã„", reason: ingredientInfo.lavage.note };
                    }
                    if (context.elapsedMin > ingredientInfo.lavage.windowMin) {
                        return { status: "éæ¨å¥¨", action: "é©å¿œæ™‚é–“å¤–", reason: `${ingredientInfo.lavage.windowMin} åˆ†ã‚’è¶…é` };
                    }
                    if (!context.airwaySecured) {
                        return { status: "æ…é‡", action: "æ°—é“ç¢ºä¿å¾Œã«å†è©•ä¾¡", reason: "èª¤åš¥ãƒªã‚¹ã‚¯ãŒé«˜ã„" };
                    }
                    if (severity.rank >= 4 || (typeof toxicRatio === "number" && toxicRatio >= 2)) {
                        return { status: "å¦¥å½“", action: "èƒƒæ´—æµ„ã‚’æ¤œè¨", reason: ingredientInfo.lavage.note };
                    }
                    return { status: "æ¡ä»¶ä»˜ã", action: "ç—‡çŠ¶é€²è¡Œæ™‚ã«æ¤œè¨", reason: "é‡ç—‡åº¦ãŒä¸ŠãŒã‚Œã°é©å¿œ" };
                })();

                const charcoal = (() => {
                    if (!ingredientInfo.charcoal.allow) {
                        return { status: "éæ¨å¥¨", action: "æ´»æ€§ç‚­ã¯åŠ¹æœä¹ã—ã„", reason: ingredientInfo.charcoal.note };
                    }
                    if (context.elapsedMin <= ingredientInfo.charcoal.windowMin) {
                        return { status: "å¦¥å½“", action: "æ´»æ€§ç‚­æŠ•ä¸ã‚’æ¤œè¨", reason: ingredientInfo.charcoal.note };
                    }
                    if (context.elapsedMin <= ingredientInfo.charcoal.extendedWindowMin && severity.rank >= 3) {
                        return { status: "æ¡ä»¶ä»˜ã", action: "é…å»¶æŠ•ä¸ã‚’æ¤œè¨", reason: "é‡ç—‡ä¾‹ã§ã‚ã‚Œã°åˆ©ç›ŠãŒæ®‹ã‚‹å¯èƒ½æ€§" };
                    }
                    return { status: "éæ¨å¥¨", action: "æŠ•ä¸ãƒ¡ãƒªãƒƒãƒˆãŒé™å®šçš„", reason: "æœ‰åŠ¹æ™‚é–“ã‚’è¶…é" };
                })();

                const dialysis = (() => {
                    if (!ingredientInfo.dialysis.effective) {
                        return { status: "é©å¿œãªã—", action: "è¡€æ¶²æµ„åŒ–ã¯é€šå¸¸ä¸è¦", reason: ingredientInfo.dialysis.indication };
                    }
                    if (severity.rank >= 4 || hasCriticalSymptom || (typeof toxicRatio === "number" && toxicRatio >= 2)) {
                        return { status: "å¦¥å½“", action: "è¡€æ¶²æµ„åŒ–ã‚’æ—©æœŸæ¤œè¨", reason: ingredientInfo.dialysis.indication };
                    }
                    if (severity.rank >= 3) {
                        return { status: "æ¡ä»¶ä»˜ã", action: "é‡ç—‡åŒ–æ™‚ã«å°å…¥æ¤œè¨", reason: ingredientInfo.dialysis.indication };
                    }
                    return { status: "æ…é‡", action: "ç¾æ™‚ç‚¹ã§ã¯çµŒéè¦³å¯Ÿ", reason: "æ˜ç¢ºãªå°å…¥åŸºæº–ã«æœªé”" };
                })();

                const others = ingredientInfo.otherTreatments.map((item) => {
                    const symptomHit = !item.symptomAny || item.symptomAny.some((symptom) => {
                        return context.observedSymptoms.some((observed) => observed.includes(symptom) || symptom.includes(observed));
                    });
                    const severityHit = severity.rank >= (item.severityMin || 1);

                    let status = "æ…é‡";
                    if (severityHit && symptomHit) {
                        status = "å¦¥å½“";
                    } else if (severityHit || symptomHit) {
                        status = "æ¡ä»¶ä»˜ã";
                    }

                    return {
                        name: item.name,
                        status,
                        reason: item.note
                    };
                });

                return { antidote, lavage, charcoal, dialysis, others };
            }

            removeEntry(id) {
                this.entries = this.entries.filter((entry) => entry.id !== id);
                this.render();
            }

            clearAll() {
                this.entries = [];
                this.render();
            }

            findKeyByNormalizedName(objectMap, targetName) {
                const normalizedTarget = this.normalizeName(targetName);
                return Object.keys(objectMap).find((key) => this.normalizeName(key) === normalizedTarget) || null;
            }

            normalizeName(value) {
                return String(value)
                    .normalize("NFKC")
                    .replace(/[â€â€‘â€’â€“â€”â€•ãƒ¼âˆ’]/g, "-")
                    .replace(/\s+/g, "")
                    .toLowerCase();
            }

            formatNumber(value, digits = 1) {
                return Number(value).toFixed(digits);
            }

            statusClass(status) {
                const map = {
                    "å¦¥å½“": "bg-green-100 text-green-800",
                    "æ¡ä»¶ä»˜ã": "bg-amber-100 text-amber-800",
                    "æ…é‡": "bg-sky-100 text-sky-800",
                    "éæ¨å¥¨": "bg-rose-100 text-rose-800",
                    "é©å¿œãªã—": "bg-slate-100 text-slate-700",
                    "è¦æƒ…å ±ç¢ºèª": "bg-violet-100 text-violet-800"
                };
                return map[status] || "bg-slate-100 text-slate-700";
            }

            render() {
                this.renderPriorityList();
                this.renderTreatmentMatrix();
            }

            renderPriorityList() {
                const container = document.getElementById("priorityList");
                if (this.entries.length === 0) {
                    container.innerHTML = `
                        <p class="text-slate-400 text-center py-10 bg-white rounded-xl border border-slate-200">
                            è–¬å‰¤ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«è§£æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                        </p>
                    `;
                    return;
                }

                container.innerHTML = this.entries.map((entry, index) => {
                    const predictedWithoutMatch = entry.predictedSymptoms.filter((symptom) => !entry.matchedSymptoms.includes(symptom));
                    const matchedText = entry.matchedSymptoms.length > 0 ? entry.matchedSymptoms.join(", ") : "ä¸€è‡´ãªã—";
                    const unmatchedText = predictedWithoutMatch.length > 0 ? predictedWithoutMatch.join(", ") : "ä¸»è¦ç—‡çŠ¶ã¯æ¦‚ã­ä¸€è‡´";
                    const toxicDoseText = entry.unknown ? "ä¸æ˜" : `${entry.toxicRatio ? this.formatNumber(entry.toxicRatio, 2) : "0.00"} x ä¸­æ¯’é‡`;
                    const sourceLabel = entry.sourceDrug === entry.ingredient ? "æˆåˆ†ç›´å…¥åŠ›" : `è£½å‰¤: ${entry.sourceDrug}`;

                    return `
                        <article class="bg-white border border-slate-200 rounded-xl shadow-sm p-4">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                                <div class="space-y-2">
                                    <p class="text-xs text-slate-500 font-semibold">å„ªå…ˆåº¦ ${index + 1} | ${this.escapeHTML(sourceLabel)}</p>
                                    <h3 class="text-lg font-bold">
                                        ${this.escapeHTML(entry.ingredient)}
                                        <span class="text-sm text-slate-500 font-medium">(${this.escapeHTML(entry.component)})</span>
                                    </h3>
                                    <div class="text-sm text-slate-700 space-y-1">
                                        <p>æ¨å®šæˆåˆ†é‡: <span class="font-semibold">${this.formatNumber(entry.ingredientAmountMg, 1)} mg</span></p>
                                        <p>æ¨å®šæ‘‚å–é‡: <span class="font-semibold">${this.formatNumber(entry.doseMgKg, 2)} mg/kg</span> / æ¯’æ€§æ¯”: <span class="font-semibold">${toxicDoseText}</span></p>
                                        <p>äºˆæ¸¬ç—‡çŠ¶: <span class="text-red-700">${this.escapeHTML(entry.predictedSymptoms.join(", "))}</span></p>
                                        <p>æ‚£è€…ç—‡çŠ¶ä¸€è‡´: <span class="text-green-700">${this.escapeHTML(matchedText)}</span></p>
                                        <p>æœªä¸€è‡´ç—‡çŠ¶: <span class="text-slate-600">${this.escapeHTML(unmatchedText)}</span></p>
                                    </div>
                                </div>
                                <div class="flex md:flex-col gap-2 items-center md:items-end">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${entry.severity.badgeClass}">
                                        ${this.escapeHTML(entry.severity.label)}
                                    </span>
                                    <span class="text-xs text-slate-500">${this.escapeHTML(entry.severity.detail)}</span>
                                    <button data-remove-id="${entry.id}" class="text-xs px-3 py-1 rounded border border-slate-300 hover:bg-slate-100">
                                        ã“ã®æˆåˆ†ã‚’å‰Šé™¤
                                    </button>
                                </div>
                            </div>
                        </article>
                    `;
                }).join("");
            }

            renderTreatmentMatrix() {
                const section = document.getElementById("treatmentSection");
                const container = document.getElementById("treatmentMatrix");
                if (this.entries.length === 0) {
                    section.classList.add("hidden");
                    container.innerHTML = "";
                    return;
                }

                section.classList.remove("hidden");
                container.innerHTML = this.entries.map((entry, index) => {
                    const treatment = entry.treatment;
                    const otherRows = treatment.others.map((item) => `
                        <li class="flex items-start gap-2 mb-2">
                            <span class="text-xs font-bold px-2 py-1 rounded ${this.statusClass(item.status)}">${this.escapeHTML(item.status)}</span>
                            <div>
                                <p class="font-semibold text-sm">${this.escapeHTML(item.name)}</p>
                                <p class="text-xs text-slate-600">${this.escapeHTML(item.reason)}</p>
                            </div>
                        </li>
                    `).join("");

                    return `
                        <article class="border border-slate-200 rounded-lg p-4">
                            <h3 class="font-bold text-base mb-3">
                                ${index + 1}. ${this.escapeHTML(entry.ingredient)} ã®æ²»ç™‚å¦¥å½“æ€§
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <tbody>
                                        ${this.renderTreatmentRow("æ‹®æŠ—è–¬", treatment.antidote)}
                                        ${this.renderTreatmentRow("èƒƒæ´—æµ„", treatment.lavage)}
                                        ${this.renderTreatmentRow("æ´»æ€§ç‚­", treatment.charcoal)}
                                        ${this.renderTreatmentRow("è¡€æ¶²æµ„åŒ–", treatment.dialysis)}
                                        <tr class="border-t">
                                            <th class="text-left align-top p-2 w-36 bg-slate-50">ãã®ä»–æ²»ç™‚</th>
                                            <td class="p-2">
                                                <ul>${otherRows}</ul>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </article>
                    `;
                }).join("");
            }

            renderTreatmentRow(label, payload) {
                return `
                    <tr class="border-t">
                        <th class="text-left align-top p-2 w-36 bg-slate-50">${label}</th>
                        <td class="p-2">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-1 rounded ${this.statusClass(payload.status)}">${this.escapeHTML(payload.status)}</span>
                                <span class="font-semibold">${this.escapeHTML(payload.action)}</span>
                            </div>
                            <p class="text-xs text-slate-600">${this.escapeHTML(payload.reason)}</p>
                        </td>
                    </tr>
                `;
            }

            escapeHTML(value) {
                return String(value)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#39;");
            }
        }

        const app = new ToxicNaviApp();
    </script>
</body>
</html>
