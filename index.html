<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToxicNavi - ä¸­æ¯’è¨ºç™‚ãƒ•ãƒ­ãƒ¼æ”¯æ´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .severity-critical { background: #7f1d1d; color: #fff; }
        .severity-high { background: #dc2626; color: #fff; }
        .severity-mid { background: #f59e0b; color: #fff; }
        .severity-low { background: #0ea5e9; color: #fff; }
        .severity-minimal { background: #16a34a; color: #fff; }
        body { padding-bottom: calc(4rem + env(safe-area-inset-bottom)); }
        @media (max-width: 640px) {
            input, textarea, button, select { font-size: 16px; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-16">
    <header class="bg-slate-800 text-white shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span>ğŸ§ª ToxicNavi</span>
                <span class="text-sm font-normal opacity-80">è–¬å‰¤ä¸­æ¯’ åˆæœŸè¨ºç™‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</span>
            </h1>
            <p class="text-xs text-amber-200">
                æ•™è‚²ãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã€‚å®Ÿè‡¨åºŠã§ã¯ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼/å°‚é–€åŒ»ã‚³ãƒ³ã‚µãƒ«ãƒˆã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 space-y-6">
        <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2">1) æ‚£è€…èƒŒæ™¯ã¨ç¾ç—‡å…¥åŠ›</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <label class="text-sm font-medium">
                    ä½“é‡ (kg)
                    <input id="patientWeight" type="number" min="1" value="60" class="mt-1 w-full border rounded p-2">
                </label>
                <label class="text-sm font-medium">
                    æ‘‚å–ã‹ã‚‰ã®æ™‚é–“ (åˆ†)
                    <input id="elapsedMinutes" type="number" min="0" value="90" class="mt-1 w-full border rounded p-2">
                </label>
                <label class="text-sm font-medium md:col-span-2">
                    æ‚£è€…ç—‡çŠ¶ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
                    <input id="observedSymptoms" type="text" placeholder="ä¾‹: å˜”å, æ„è­˜éšœå®³, é »è„ˆ" class="mt-1 w-full border rounded p-2">
                </label>
            </div>
            <div class="mt-3 flex items-center gap-2">
                <input id="airwaySecured" type="checkbox" class="h-4 w-4">
                <label for="airwaySecured" class="text-sm">æ°—é“ç¢ºä¿æ¸ˆã¿ï¼ˆèƒƒæ´—æµ„ã®å®‰å…¨æ€§è©•ä¾¡ã«ä½¿ç”¨ï¼‰</label>
            </div>
            <div class="mt-3">
                <p class="text-xs text-slate-500 mb-2">ç—‡çŠ¶ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›</p>
                <div id="symptomChips" class="flex flex-wrap gap-2"></div>
            </div>
        </section>

        <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2">2) æ‘‚å–è–¬å‰¤å…¥åŠ›ï¼ˆè£½å‰¤å/æˆåˆ†åã€å†…æœé‡ï¼‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <label class="text-sm font-medium md:col-span-2">
                    è–¬å‰¤åï¼ˆè£½å‰¤å or æˆåˆ†åï¼‰
                    <input id="drugInput" list="drugCandidates" type="text" placeholder="ä¾‹: ã‚«ãƒ­ãƒŠãƒ¼ãƒ«éŒ 500" class="mt-1 w-full border rounded p-2">
                </label>
                <datalist id="drugCandidates"></datalist>
                <label class="text-sm font-medium">
                    è¦æ ¼ (mg/éŒ )
                    <input id="strengthInput" type="number" min="0" step="0.1" placeholder="ä¾‹: 500" class="mt-1 w-full border rounded p-2">
                </label>
                <label class="text-sm font-medium">
                    éŒ æ•°
                    <input id="tabletCountInput" type="number" min="0" step="1" placeholder="ä¾‹: 20" class="mt-1 w-full border rounded p-2">
                </label>
                <label class="text-sm font-medium">
                    ç·é‡ (mg)
                    <input id="amountInput" type="number" min="0" placeholder="ä¾‹: 10000" class="mt-1 w-full border rounded p-2">
                </label>
                <div class="flex flex-col sm:flex-row items-end gap-2 md:col-span-5">
                    <button id="addDrugBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 transition">
                        è¿½åŠ 
                    </button>
                    <button id="clearBtn" class="w-full bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded hover:bg-slate-300 transition">
                        å…¨æ¶ˆå»
                    </button>
                </div>
            </div>
            <p id="amountCalcStatus" class="mt-2 text-xs text-slate-500">
                è¦æ ¼ã¨éŒ æ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨ç·é‡ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ï¼ˆä¾‹: 500 mg/éŒ  Ã— 20 éŒ  = 10000 mgï¼‰
            </p>
            <p id="datasetStatus" class="mt-3 text-xs text-slate-500">
                å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ: èª­ã¿è¾¼ã¿ä¸­...
            </p>
        </section>

        <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2">2.5) å†™çœŸå–ã‚Šè¾¼ã¿ã¨è‡ªå‹•è–¬å‰¤æŠ½å‡º</h2>
            <input id="cameraCaptureInput" type="file" accept="image/*" capture="environment" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button id="capturePhotoBtn" class="bg-sky-600 text-white font-bold py-2 px-3 rounded hover:bg-sky-700 transition">
                        å†™çœŸã‚’æ’®å½±ã—ã¦è¿½åŠ 
                    </button>
                    <button id="runOcrBtn" class="bg-indigo-600 text-white font-bold py-2 px-3 rounded hover:bg-indigo-700 transition">
                        OCRå®Ÿè¡Œ
                    </button>
                </div>
                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button id="parseOcrTextBtn" class="bg-slate-700 text-white font-bold py-2 px-3 rounded hover:bg-slate-800 transition">
                        ãƒ†ã‚­ã‚¹ãƒˆè§£æ
                    </button>
                    <button id="importDetectedBtn" class="bg-emerald-600 text-white font-bold py-2 px-3 rounded hover:bg-emerald-700 transition">
                        è¨ºç™‚è©•ä¾¡ã¸åæ˜ 
                    </button>
                    <button id="clearDetectedBtn" class="bg-slate-200 text-slate-700 font-bold py-2 px-3 rounded hover:bg-slate-300 transition">
                        æŠ½å‡ºçµæœã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>
            <div id="capturedPhotoList" class="mt-3 text-xs text-slate-600"></div>
            <p id="ocrStatus" class="mt-3 text-xs text-slate-500">OCRå¾…æ©Ÿä¸­</p>
            <label class="text-sm font-medium block mt-3">
                OCR/è²¼ã‚Šä»˜ã‘ãƒ†ã‚­ã‚¹ãƒˆ
                <textarea id="ocrRawText" rows="6" class="mt-1 w-full border rounded p-2" placeholder="ç”»åƒOCRçµæœã‚„ä¸­æ¯’ãƒ¡ãƒ¢ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€è–¬å‰¤åãƒ»1éŒ é‡ãƒ»éŒ æ•°ã‚’æŠ½å‡ºã—ã¾ã™ã€‚"></textarea>
            </label>
            <div id="detectedDrugTable" class="mt-3 text-sm">
                <p class="text-slate-400">è§£æã™ã‚‹ã¨è–¬å‰¤å€™è£œãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
        </section>

        <section>
            <h2 class="text-lg font-bold mb-3">3) é‡ç—‡åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé«˜ãƒªã‚¹ã‚¯é †ï¼‰</h2>
            <div id="priorityList" class="space-y-3">
                <p class="text-slate-400 text-center py-10 bg-white rounded-xl border border-slate-200">
                    è–¬å‰¤ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«è§£æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </p>
            </div>
        </section>

        <section id="treatmentSection" class="hidden bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2 text-red-700">4) æ²»ç™‚å¦¥å½“æ€§ã®æ¤œè¨¼</h2>
            <div id="treatmentMatrix" class="space-y-6"></div>
        </section>

        <section id="reportSection" class="bg-white border border-slate-200 rounded-xl shadow-sm p-5">
            <h2 class="text-lg font-bold mb-4 border-b pb-2">5) è¨ºç™‚éŒ²è²¼ã‚Šä»˜ã‘ç”¨ å‡ºåŠ›</h2>
            <p class="text-xs text-slate-500">
                ä»•æ§˜: toxnavi-report-v1ï¼ˆæ§‹é€ åŒ–ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã€‚èƒŒæ™¯ãƒ­ã‚¸ãƒƒã‚¯ã¯ README.md ã‚’å‚ç…§ã€‚
            </p>
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                <button id="generateReportBtn" class="bg-slate-800 text-white font-bold py-2 px-3 rounded hover:bg-slate-900 transition">
                    å ±å‘Šæ›¸ã‚’ç”Ÿæˆ
                </button>
                <button id="copyReportBtn" class="bg-emerald-600 text-white font-bold py-2 px-3 rounded hover:bg-emerald-700 transition">
                    å‡ºåŠ›ã‚’ã‚³ãƒ”ãƒ¼
                </button>
            </div>
            <p id="reportStatus" class="mt-3 text-xs text-slate-500">å ±å‘Šæ›¸ã¯æœªç”Ÿæˆã§ã™</p>
            <textarea id="reportOutput" rows="16" class="mt-2 w-full border rounded p-2 font-mono text-xs"></textarea>
        </section>
    </main>

    <script>
        class ToxicNaviApp {
            constructor() {
                this.entries = [];
                this.detectedIngestionItems = [];
                this.capturedPhotos = [];
                this.photoCounter = 1;
                this.reportSpecVersion = "toxnavi-report-v1";
                this.ocrBusy = false;
                this.ocrLastText = "";
                this.searchEntries = [];
                this.productStrengthHintsMg = {};
                this.entryCounter = 1;
                this.commonSymptoms = [
                    "å˜”æ°—", "å˜”å", "è…¹ç—›", "é »è„ˆ", "ä½è¡€åœ§", "ç—™æ”£", "æ„è­˜éšœå®³",
                    "å‘¼å¸æŠ‘åˆ¶", "ä¸æ•´è„ˆ", "ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "è€³é³´", "ç™ºæ±—"
                ];

                this.productDB = {
                    "ã‚«ãƒ­ãƒŠãƒ¼ãƒ«éŒ 500": [{ ingredient: "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³", ratio: 1 }],
                    "ãƒãƒ•ã‚¡ãƒªãƒ³A": [{ ingredient: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³", ratio: 0.85 }, { ingredient: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", ratio: 0.15 }],
                    "ã‚¨ã‚¹ã‚¿ãƒ­ãƒ³ãƒ¢ã‚«": [{ ingredient: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", ratio: 1 }],
                    "ã‚»ãƒ«ã‚·ãƒ³éŒ ": [{ ingredient: "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ", ratio: 1 }],
                    "ãƒ¡ãƒˆã‚°ãƒ«ã‚³éŒ ": [{ ingredient: "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³", ratio: 1 }],
                    "ãƒ†ã‚ªãƒ‰ãƒ¼ãƒ«éŒ ": [{ ingredient: "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³", ratio: 1 }],
                    "ãƒ–ãƒ­ãƒ³é…åˆéŒ ": [{ ingredient: "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³", ratio: 0.35 }, { ingredient: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", ratio: 0.15 }, { ingredient: "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³", ratio: 0.5 }],
                    "ä¸å‡æ¶²(ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«)": [{ ingredient: "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«", ratio: 1 }]
                };

                this.ingredientDB = {
                    "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³": {
                        component: "Acetaminophen",
                        toxicDoseMgKg: 150,
                        severeDoseMgKg: 250,
                        criticalDoseMgKg: 300,
                        symptoms: ["å˜”æ°—", "å˜”å", "è…¹ç—›", "è‚æ©Ÿèƒ½éšœå®³", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["æ„è­˜éšœå®³"],
                        antidote: { name: "N-ã‚¢ã‚»ãƒãƒ«ã‚·ã‚¹ãƒ†ã‚¤ãƒ³", indication: "æ‘‚å–é‡ 150 mg/kg è¶…ã€ã¾ãŸã¯è¡€ä¸­æ¿ƒåº¦ã§æ²»ç™‚åŸŸè¶…é" },
                        lavage: { allow: true, windowMin: 60, note: "è‡´æ­»é‡ãŒç–‘ã‚ã‚Œã‚‹æ—©æœŸä¾‹ã§ã®ã¿æ¤œè¨" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "å¾æ”¾è£½å‰¤ã§ã¯å»¶é•·ã—ã¦æ¤œè¨" },
                        dialysis: { effective: false, indication: "é€šå¸¸ã¯é©å¿œå¤–" },
                        otherTreatments: [
                            { name: "è¡€ä¸­æ¿ƒåº¦æ¸¬å®š", severityMin: 2, note: "4æ™‚é–“ä»¥é™ã®æ¿ƒåº¦ã‚’è©•ä¾¡ã—ã¦æ²»ç™‚ç¶™ç¶šåˆ¤æ–­" },
                            { name: "è‚æ©Ÿèƒ½/å‡å›ºãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°", severityMin: 2, note: "AST/ALT/INRã‚’é€£ç¶šè©•ä¾¡" }
                        ]
                    },
                    "ã‚¢ã‚¹ãƒ”ãƒªãƒ³": {
                        component: "Aspirin",
                        toxicDoseMgKg: 150,
                        severeDoseMgKg: 300,
                        criticalDoseMgKg: 500,
                        symptoms: ["éæ›æ°—", "è€³é³´", "å˜”å", "ç™ºç†±", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["æ„è­˜éšœå®³", "éæ›æ°—"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "å°¿ã‚¢ãƒ«ã‚«ãƒªåŒ–ãƒ»æ”¯æŒç™‚æ³•ãŒä¸­å¿ƒ" },
                        lavage: { allow: true, windowMin: 60, note: "å¤§é‡æ‘‚å–ã§1æ™‚é–“ä»¥å†…ãªã‚‰æ¤œè¨" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "å¤§é‡æ‘‚å–æ™‚ã¯å†æŠ•ä¸ã‚’æ¤œè¨" },
                        dialysis: { effective: true, indication: "é‡ç—‡ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã€è…éšœå®³ã€ç¥çµŒç—‡çŠ¶ã§é©å¿œ" },
                        otherTreatments: [
                            { name: "å°¿ã‚¢ãƒ«ã‚«ãƒªåŒ–", severityMin: 3, note: "ç‚­é…¸æ°´ç´ ãƒŠãƒˆãƒªã‚¦ãƒ ã§æ’æ³„ä¿ƒé€²" },
                            { name: "ä½“æ¸©ç®¡ç†", severityMin: 2, note: "é«˜ä½“æ¸©ã¯äºˆå¾Œæ‚ªåŒ–å› å­" }
                        ]
                    },
                    "ã‚«ãƒ•ã‚§ã‚¤ãƒ³": {
                        component: "Caffeine",
                        toxicDoseMgKg: 15,
                        severeDoseMgKg: 30,
                        criticalDoseMgKg: 80,
                        symptoms: ["é »è„ˆ", "èˆˆå¥®", "æŒ¯æˆ¦", "ä¸æ•´è„ˆ", "ç—™æ”£"],
                        criticalSymptoms: ["ä¸æ•´è„ˆ", "ç—™æ”£"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "å¾ªç’°ç®¡ç†ã¨ç—™æ”£ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«" },
                        lavage: { allow: true, windowMin: 60, note: "é«˜ç”¨é‡æ‘‚å–ç›´å¾Œã§ã‚ã‚Œã°è€ƒæ…®" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "æ—©æœŸæŠ•ä¸ã»ã©æœ‰åŠ¹" },
                        dialysis: { effective: true, indication: "é›£æ²»æ€§ä¸æ•´è„ˆã‚„é‡ç¯¤ä¸­æ¯’ã§æ¤œè¨" },
                        otherTreatments: [
                            { name: "ä¸æ•´è„ˆç›£è¦–", severityMin: 2, note: "æŒç¶šãƒ¢ãƒ‹ã‚¿ãƒ¼ç®¡ç†" },
                            { name: "ç—™æ”£æ™‚ãƒ™ãƒ³ã‚¾ã‚¸ã‚¢ã‚¼ãƒ”ãƒ³", severityMin: 3, symptomAny: ["ç—™æ”£"], note: "ç—™æ”£ç®¡ç†ã‚’å„ªå…ˆ" }
                        ]
                    },
                    "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ": {
                        component: "Diazepam",
                        toxicDoseMgKg: 0.5,
                        severeDoseMgKg: 1.5,
                        criticalDoseMgKg: 3,
                        symptoms: ["å‚¾çœ ", "æ§‹èªéšœå®³", "å‘¼å¸æŠ‘åˆ¶", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["å‘¼å¸æŠ‘åˆ¶", "æ„è­˜éšœå®³"],
                        antidote: { name: "ãƒ•ãƒ«ãƒã‚¼ãƒ‹ãƒ«", indication: "é©å¿œã‚’å³å¯†ã«è©•ä¾¡ï¼ˆä¾å­˜ãƒ»ç—™æ”£ãƒªã‚¹ã‚¯ã«æ³¨æ„ï¼‰" },
                        lavage: { allow: false, windowMin: 0, note: "é€šå¸¸æ¨å¥¨ã•ã‚Œãªã„" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "æ°—é“ä¿è­·ãŒå‰æ" },
                        dialysis: { effective: false, indication: "åŠ¹æœä¹ã—ã„" },
                        otherTreatments: [
                            { name: "æ°—é“/å‘¼å¸ç®¡ç†", severityMin: 3, symptomAny: ["å‘¼å¸æŠ‘åˆ¶"], note: "SpO2ä½ä¸‹æ™‚ã¯æ—©æœŸä»‹å…¥" }
                        ]
                    },
                    "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³": {
                        component: "Metformin",
                        toxicDoseMgKg: 50,
                        severeDoseMgKg: 100,
                        criticalDoseMgKg: 200,
                        symptoms: ["å˜”å", "è…¹ç—›", "é »å‘¼å¸", "ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "æ„è­˜éšœå®³"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "ä¹³é…¸ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ç®¡ç†ãŒä¸­å¿ƒ" },
                        lavage: { allow: false, windowMin: 0, note: "é€šå¸¸ã¯é©å¿œä¹ã—ã„" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 180, note: "æ—©æœŸä¾‹ã§ã®ã¿æœ‰åŠ¹æ€§ãŒæœŸå¾…" },
                        dialysis: { effective: true, indication: "é‡åº¦ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ãƒ»è…ä¸å…¨ã§å¼·ãæ¨å¥¨" },
                        otherTreatments: [
                            { name: "ä¹³é…¸/è¡€æ¶²ã‚¬ã‚¹æ¸¬å®š", severityMin: 2, note: "ä¹³é…¸ä¸Šæ˜‡ã‚’é€£ç¶šè©•ä¾¡" },
                            { name: "å¾ªç’°ç®¡ç†", severityMin: 3, note: "ã‚·ãƒ§ãƒƒã‚¯å¾´å€™ã¸æ—©æœŸå¯¾å¿œ" }
                        ]
                    },
                    "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³": {
                        component: "Theophylline",
                        toxicDoseMgKg: 10,
                        severeDoseMgKg: 20,
                        criticalDoseMgKg: 40,
                        symptoms: ["å˜”å", "é »è„ˆ", "ä¸æ•´è„ˆ", "ä½è¡€åœ§", "ç—™æ”£"],
                        criticalSymptoms: ["ç—™æ”£", "ä¸æ•´è„ˆ"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "ç—™æ”£ãƒ»ä¸æ•´è„ˆç®¡ç†ã‚’å„ªå…ˆ" },
                        lavage: { allow: true, windowMin: 60, note: "å¤§é‡æ‘‚å–ç›´å¾Œã§è€ƒæ…®" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 360, note: "å¤šå›æŠ•ä¸ã®é©å¿œã‚’æ¤œè¨" },
                        dialysis: { effective: true, indication: "é‡ç—‡ä¸­æ¯’ã€ç—™æ”£ã€é›£æ²»æ€§ä¸æ•´è„ˆã§é©å¿œ" },
                        otherTreatments: [
                            { name: "å¤šå›æ´»æ€§ç‚­ã®æ¤œè¨", severityMin: 3, note: "å†å¾ªç’°ã‚’æŠ‘åˆ¶" },
                            { name: "ç—™æ”£æ™‚é®é™æ²»ç™‚", severityMin: 3, symptomAny: ["ç—™æ”£"], note: "ãƒ™ãƒ³ã‚¾ã‚¸ã‚¢ã‚¼ãƒ”ãƒ³ã‚’å„ªå…ˆ" }
                        ]
                    },
                    "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³": {
                        component: "Dihydrocodeine",
                        toxicDoseMgKg: 1,
                        severeDoseMgKg: 2,
                        criticalDoseMgKg: 4,
                        symptoms: ["ç¸®ç³", "å‚¾çœ ", "å‘¼å¸æŠ‘åˆ¶", "ä½é…¸ç´ "],
                        criticalSymptoms: ["å‘¼å¸æŠ‘åˆ¶", "ä½é…¸ç´ "],
                        antidote: { name: "ãƒŠãƒ­ã‚­ã‚½ãƒ³", indication: "å‘¼å¸æŠ‘åˆ¶ã¾ãŸã¯æ„è­˜éšœå®³ã§é€Ÿã‚„ã‹ã«æŠ•ä¸" },
                        lavage: { allow: false, windowMin: 0, note: "èª¤åš¥ãƒªã‚¹ã‚¯ã‚’è€ƒæ…®ã—é€šå¸¸éæ¨å¥¨" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 240, note: "æ°—é“ä¿è­·ä¸‹ã§æ¤œè¨" },
                        dialysis: { effective: false, indication: "é€šå¸¸ä¸è¦" },
                        otherTreatments: [
                            { name: "å‘¼å¸ç®¡ç†", severityMin: 3, symptomAny: ["å‘¼å¸æŠ‘åˆ¶", "ä½é…¸ç´ "], note: "æ›æ°—è£œåŠ©ã‚’æ—©æœŸã«åˆ¤æ–­" }
                        ]
                    },
                    "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³": {
                        component: "Methylephedrine",
                        toxicDoseMgKg: 2,
                        severeDoseMgKg: 5,
                        criticalDoseMgKg: 10,
                        symptoms: ["é »è„ˆ", "ä¸ç©", "é«˜è¡€åœ§", "ä¸æ•´è„ˆ"],
                        criticalSymptoms: ["ä¸æ•´è„ˆ"],
                        antidote: { name: "ç‰¹ç•°çš„æ‹®æŠ—è–¬ãªã—", indication: "å¾ªç’°å‹•æ…‹ã«å¿œã˜ãŸå¯¾ç—‡ç™‚æ³•" },
                        lavage: { allow: true, windowMin: 60, note: "é‡ç—‡æ‘‚å–ç›´å¾Œã®ã¿" },
                        charcoal: { allow: true, windowMin: 120, extendedWindowMin: 180, note: "æ—©æœŸæŠ•ä¸ã‚’æ¤œè¨" },
                        dialysis: { effective: false, indication: "é€šå¸¸åŠ¹æœä¹ã—ã„" },
                        otherTreatments: [
                            { name: "é®é™ãƒ»å¾ªç’°ç®¡ç†", severityMin: 2, note: "èˆˆå¥®ã‚„é‡åº¦é »è„ˆã‚’åˆ¶å¾¡" }
                        ]
                    },
                    "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«": {
                        component: "Ethylene glycol",
                        toxicDoseMgKg: 50,
                        severeDoseMgKg: 100,
                        criticalDoseMgKg: 150,
                        symptoms: ["é…©é…Šæ§˜ç—‡çŠ¶", "é »å‘¼å¸", "ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "è…éšœå®³", "æ„è­˜éšœå®³"],
                        criticalSymptoms: ["ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "æ„è­˜éšœå®³"],
                        antidote: { name: "ãƒ›ãƒ¡ãƒ”ã‚¾ãƒ¼ãƒ«ï¼ˆã¾ãŸã¯ã‚¨ã‚¿ãƒãƒ¼ãƒ«ç™‚æ³•ï¼‰", indication: "ç–‘ã„æ®µéšã§æ—©æœŸé–‹å§‹ã‚’æ¤œè¨" },
                        lavage: { allow: false, windowMin: 0, note: "é€šå¸¸æ¨å¥¨ã•ã‚Œãªã„" },
                        charcoal: { allow: false, windowMin: 0, extendedWindowMin: 0, note: "å¸ç€åŠ¹æœãŒä¹ã—ã„" },
                        dialysis: { effective: true, indication: "ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã€è…éšœå®³ã€é‡ç—‡ä¾‹ã§ç©æ¥µé©å¿œ" },
                        otherTreatments: [
                            { name: "ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹è£œæ­£", severityMin: 3, note: "é‡ç‚­é…¸æŠ•ä¸ã‚’æ¤œè¨" },
                            { name: "è…æ©Ÿèƒ½ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°", severityMin: 2, note: "Crã¨å°¿é‡ã‚’é€£ç¶šè©•ä¾¡" }
                        ]
                    }
                };

                this.ingredientSynonyms = {
                    "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³ãƒªãƒ³é…¸å¡©": "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³",
                    "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³ãƒªãƒ³é…¸å¡©æ°´å’Œç‰©": "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³",
                    "ç„¡æ°´ã‚«ãƒ•ã‚§ã‚¤ãƒ³": "ã‚«ãƒ•ã‚§ã‚¤ãƒ³",
                    "ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ°´å’Œç‰©": "ã‚«ãƒ•ã‚§ã‚¤ãƒ³",
                    "dl-ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "dlãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "d-ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "l-ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³å¡©é…¸å¡©": "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³",
                    "ã‚¢ã‚»ãƒãƒ«ã‚µãƒªãƒãƒ«é…¸": "ã‚¢ã‚¹ãƒ”ãƒªãƒ³"
                };
                this.ingredientHeuristicSynonyms = [
                    { keyword: "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³", canonical: "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³" },
                    { keyword: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³", canonical: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³" },
                    { keyword: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³", canonical: "ã‚«ãƒ•ã‚§ã‚¤ãƒ³" },
                    { keyword: "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³", canonical: "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³" },
                    { keyword: "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³", canonical: "ãƒ¡ãƒãƒ«ã‚¨ãƒ•ã‚§ãƒ‰ãƒªãƒ³" },
                    { keyword: "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ", canonical: "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ " },
                    { keyword: "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³", canonical: "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³" },
                    { keyword: "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³", canonical: "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³" },
                    { keyword: "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«", canonical: "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«" }
                ];
                this.ingredientSynonymIndex = {};
                Object.entries(this.ingredientSynonyms).forEach(([alias, canonical]) => {
                    this.ingredientSynonymIndex[this.normalizeName(alias)] = canonical;
                });
                this.seedStrengthHintsFromProductNames();

                this.bootstrapJpicSchema();
                this.datasetLoaded = false;
                this.bindEvents();
                this.populateDrugCandidates();
                this.renderSymptomChips();
                this.renderCapturedPhotoList();
                this.renderDetectedDrugTable();
                this.renderReportOutput();
                this.loadExternalDatasets();
            }

            bindEvents() {
                document.getElementById("addDrugBtn").addEventListener("click", () => this.addDrug());
                document.getElementById("clearBtn").addEventListener("click", () => this.clearAll());
                document.getElementById("strengthInput").addEventListener("input", () => {
                    const strengthInput = document.getElementById("strengthInput");
                    strengthInput.dataset.autoFilled = "0";
                    this.recalculateTotalAmount();
                });
                document.getElementById("strengthInput").addEventListener("keydown", (event) => {
                    if (event.key === "Enter") this.addDrug();
                });
                document.getElementById("tabletCountInput").addEventListener("input", () => this.recalculateTotalAmount());
                document.getElementById("tabletCountInput").addEventListener("keydown", (event) => {
                    if (event.key === "Enter") this.addDrug();
                });
                document.getElementById("amountInput").addEventListener("input", () => {
                    if (!this.hasTabletInputs()) {
                        this.setAmountCalcStatus("ç·é‡ã‚’æ‰‹å…¥åŠ›ä¸­ã§ã™ã€‚è¦æ ¼ã¨éŒ æ•°ãŒã‚ã‚Œã°è‡ªå‹•è¨ˆç®—ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚", "info");
                    }
                });
                document.getElementById("amountInput").addEventListener("keydown", (event) => {
                    if (event.key === "Enter") this.addDrug();
                });
                document.getElementById("drugInput").addEventListener("keydown", (event) => {
                    if (event.key === "Enter") this.addDrug();
                });
                document.getElementById("drugInput").addEventListener("change", () => {
                    this.tryAutoFillStrength();
                });
                document.getElementById("drugInput").addEventListener("blur", () => {
                    this.tryAutoFillStrength();
                });
                document.getElementById("priorityList").addEventListener("click", (event) => {
                    const button = event.target.closest("[data-remove-id]");
                    if (!button) return;
                    this.removeEntry(Number(button.dataset.removeId));
                });
                document.getElementById("capturePhotoBtn").addEventListener("click", () => this.openCameraCapture());
                document.getElementById("cameraCaptureInput").addEventListener("change", (event) => this.handleCameraCaptureChange(event));
                document.getElementById("capturedPhotoList").addEventListener("click", (event) => {
                    const button = event.target.closest("[data-remove-photo-id]");
                    if (!button) return;
                    this.removeCapturedPhoto(Number(button.dataset.removePhotoId));
                });
                document.getElementById("runOcrBtn").addEventListener("click", () => this.runOcrFromImages());
                document.getElementById("parseOcrTextBtn").addEventListener("click", () => this.parseAndMatchOcrText());
                document.getElementById("importDetectedBtn").addEventListener("click", () => this.importDetectedItemsToAssessment());
                document.getElementById("clearDetectedBtn").addEventListener("click", () => this.clearDetectedItems());
                document.getElementById("generateReportBtn").addEventListener("click", () => this.renderReportOutput("æ‰‹å‹•æ›´æ–°ã—ã¾ã—ãŸ"));
                document.getElementById("copyReportBtn").addEventListener("click", () => this.copyReportOutput());
            }

            bootstrapJpicSchema() {
                this.jpicSchemaSpec = {
                    schemaVersion: "jpic-compatible-v1",
                    required: [
                        "ingredientName",
                        "toxicThresholdMgKg",
                        "symptomTimeline",
                        "toxicokinetics",
                        "treatmentGuide",
                        "analysis",
                        "evidence"
                    ]
                };

                const jpicMaster = {
                    "ã‚¢ã‚»ãƒˆã‚¢ãƒŸãƒãƒ•ã‚§ãƒ³": {
                        aliases: ["Acetaminophen", "ãƒ‘ãƒ©ã‚»ã‚¿ãƒ¢ãƒ¼ãƒ«"],
                        toxicThresholdMgKg: { caution: 75, toxic: 150, severe: 250, critical: 300 },
                        symptomTimeline: [
                            { window: "0-4æ™‚é–“", symptoms: ["å˜”æ°—", "å˜”å", "ç™ºæ±—"], redFlags: ["åå¾©å˜”å"] },
                            { window: "4-24æ™‚é–“", symptoms: ["ç—‡çŠ¶ä¸€æ™‚è»½å¿«", "å³å­£è‚‹éƒ¨ç—›"], redFlags: ["è…¹ç—›å¢—æ‚ª"] },
                            { window: "24-72æ™‚é–“", symptoms: ["è‚æ©Ÿèƒ½éšœå®³", "é»„ç–¸", "æ„è­˜éšœå®³"], redFlags: ["æ„è­˜éšœå®³", "ä½è¡€ç³–"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "0.5-2",
                            halfLifeHours: "2-4",
                            vdLKg: "0.8-1.0",
                            proteinBindingPct: "10-25",
                            metabolism: "ä¸»ã«è‚ä»£è¬",
                            elimination: "è…æ’æ³„"
                        },
                        analysis: {
                            recommendedTests: ["è¡€ä¸­æ¿ƒåº¦(æ‘‚å–4æ™‚é–“ä»¥é™)", "AST/ALT", "PT-INR", "è¡€ç³–"],
                            interpretation: "æ™‚é–“ã¨è¡€ä¸­æ¿ƒåº¦ã‚’ãƒãƒ¢ã‚°ãƒ©ãƒ ã§è©•ä¾¡",
                            notes: "é‡ç—‡ä¾‹ã§ã¯å‡å›ºéšœå®³ã¨ä»£è¬éšœå®³ã‚’é€£ç¶šè©•ä¾¡"
                        }
                    },
                    "ã‚¢ã‚¹ãƒ”ãƒªãƒ³": {
                        aliases: ["ã‚¢ã‚»ãƒãƒ«ã‚µãƒªãƒãƒ«é…¸", "Aspirin"],
                        toxicThresholdMgKg: { caution: 100, toxic: 150, severe: 300, critical: 500 },
                        symptomTimeline: [
                            { window: "0-6æ™‚é–“", symptoms: ["å˜”å", "è€³é³´", "éæ›æ°—"], redFlags: ["éæ›æ°—"] },
                            { window: "6-24æ™‚é–“", symptoms: ["ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "ç™ºç†±", "è„±æ°´"], redFlags: ["æ„è­˜éšœå®³"] },
                            { window: "24æ™‚é–“ä»¥é™", symptoms: ["è‚ºæ°´è…«", "è…éšœå®³", "ä¸­æ¢æŠ‘åˆ¶"], redFlags: ["ä½è¡€åœ§", "æ„è­˜éšœå®³"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "1-4",
                            halfLifeHours: "2-20(ç”¨é‡ä¾å­˜)",
                            vdLKg: "0.2",
                            proteinBindingPct: "80-90",
                            metabolism: "è‚ä»£è¬",
                            elimination: "è…æ’æ³„(å°¿ã‚¢ãƒ«ã‚«ãƒªåŒ–ã§ä¿ƒé€²)"
                        },
                        analysis: {
                            recommendedTests: ["è¡€ä¸­ã‚µãƒªãƒãƒ«é…¸æ¿ƒåº¦", "è¡€æ¶²ã‚¬ã‚¹", "é›»è§£è³ª", "è…æ©Ÿèƒ½"],
                            interpretation: "æ¿ƒåº¦ã¨é…¸å¡©åŸºå¹³è¡¡ã‚’åˆã‚ã›ã¦é‡ç—‡åº¦è©•ä¾¡",
                            notes: "åå¾©æ¸¬å®šã§ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç¢ºèª"
                        }
                    },
                    "ã‚«ãƒ•ã‚§ã‚¤ãƒ³": {
                        aliases: ["ç„¡æ°´ã‚«ãƒ•ã‚§ã‚¤ãƒ³", "Caffeine"],
                        toxicThresholdMgKg: { caution: 8, toxic: 15, severe: 30, critical: 80 },
                        symptomTimeline: [
                            { window: "0-4æ™‚é–“", symptoms: ["å˜”å", "æŒ¯æˆ¦", "é »è„ˆ"], redFlags: ["ä¸æ•´è„ˆ"] },
                            { window: "4-12æ™‚é–“", symptoms: ["èˆˆå¥®", "ä½Kè¡€ç—‡", "ä¸æ•´è„ˆ"], redFlags: ["ç—™æ”£"] },
                            { window: "12æ™‚é–“ä»¥é™", symptoms: ["ä»£è¬éšœå®³", "å¾ªç’°ä¸å…¨"], redFlags: ["é›£æ²»æ€§ä¸æ•´è„ˆ"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "0.5-1.5",
                            halfLifeHours: "3-6",
                            vdLKg: "0.6",
                            proteinBindingPct: "10-35",
                            metabolism: "è‚ä»£è¬(CYP1A2)",
                            elimination: "è…æ’æ³„"
                        },
                        analysis: {
                            recommendedTests: ["è¡€æ¸…K", "ä¹³é…¸", "å¿ƒé›»å›³ãƒ¢ãƒ‹ã‚¿", "è¡€ä¸­ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ¿ƒåº¦(å¯èƒ½ãªã‚‰)"],
                            interpretation: "é›»è§£è³ªç•°å¸¸ã¨ä¸æ•´è„ˆã®è©•ä¾¡ã‚’å„ªå…ˆ",
                            notes: "é‡ç—‡ä¾‹ã§ã¯è¡€æ¶²æµ„åŒ–ã®é©å¿œã‚’æ¤œè¨"
                        }
                    },
                    "ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³": {
                        aliases: ["ã‚¸ãƒ’ãƒ‰ãƒ­ã‚³ãƒ‡ã‚¤ãƒ³ãƒªãƒ³é…¸å¡©", "Dihydrocodeine"],
                        toxicThresholdMgKg: { caution: 0.5, toxic: 1.0, severe: 2.0, critical: 4.0 },
                        symptomTimeline: [
                            { window: "0-2æ™‚é–“", symptoms: ["å‚¾çœ ", "ç¸®ç³"], redFlags: ["å‘¼å¸æŠ‘åˆ¶"] },
                            { window: "2-8æ™‚é–“", symptoms: ["å‘¼å¸æŠ‘åˆ¶", "ä½é…¸ç´ "], redFlags: ["æ„è­˜éšœå®³"] },
                            { window: "8æ™‚é–“ä»¥é™", symptoms: ["é·å»¶æ€§ä½æ›æ°—"], redFlags: ["å†é®é™"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "1-2",
                            halfLifeHours: "3-5",
                            vdLKg: "2-4",
                            proteinBindingPct: "20-30",
                            metabolism: "è‚ä»£è¬",
                            elimination: "è…æ’æ³„"
                        },
                        analysis: {
                            recommendedTests: ["SpO2", "å‘¼æ°—CO2", "è¡€æ¶²ã‚¬ã‚¹", "æ„è­˜ãƒ¬ãƒ™ãƒ«"],
                            interpretation: "å‘¼å¸æŠ‘åˆ¶ã®æœ‰ç„¡ãŒæ²»ç™‚åˆ¤æ–­ã®ä¸»è»¸",
                            notes: "ãƒŠãƒ­ã‚­ã‚½ãƒ³æŠ•ä¸å¾Œã®å†æŠ‘åˆ¶ã«æ³¨æ„"
                        }
                    },
                    "ãƒ¡ãƒˆãƒ›ãƒ«ãƒŸãƒ³": {
                        aliases: ["Metformin"],
                        toxicThresholdMgKg: { caution: 30, toxic: 50, severe: 100, critical: 200 },
                        symptomTimeline: [
                            { window: "0-6æ™‚é–“", symptoms: ["å˜”å", "è…¹ç—›"], redFlags: ["é »å‘¼å¸"] },
                            { window: "6-24æ™‚é–“", symptoms: ["ä¹³é…¸ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "å¾ªç’°ä¸å…¨"], redFlags: ["ã‚·ãƒ§ãƒƒã‚¯"] },
                            { window: "24æ™‚é–“ä»¥é™", symptoms: ["è…æ©Ÿèƒ½æ‚ªåŒ–", "æ„è­˜éšœå®³"], redFlags: ["æ˜ç¡"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "2-3",
                            halfLifeHours: "4-8",
                            vdLKg: "1-5",
                            proteinBindingPct: "ã»ã¼0",
                            metabolism: "ã»ã¼ä»£è¬ã•ã‚Œãªã„",
                            elimination: "è…æ’æ³„"
                        },
                        analysis: {
                            recommendedTests: ["ä¹³é…¸", "è¡€æ¶²ã‚¬ã‚¹", "è…æ©Ÿèƒ½", "è¡€ç³–"],
                            interpretation: "é‡ç—‡ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã¯è¡€æ¶²æµ„åŒ–é©å¿œ",
                            notes: "å¾ªç’°å‹•æ…‹ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’å„ªå…ˆ"
                        }
                    },
                    "ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³": {
                        aliases: ["Theophylline"],
                        toxicThresholdMgKg: { caution: 5, toxic: 10, severe: 20, critical: 40 },
                        symptomTimeline: [
                            { window: "0-4æ™‚é–“", symptoms: ["å˜”å", "é »è„ˆ"], redFlags: ["ä¸æ•´è„ˆ"] },
                            { window: "4-12æ™‚é–“", symptoms: ["æŒ¯æˆ¦", "ä½è¡€åœ§", "ç—™æ”£"], redFlags: ["ç—™æ”£"] },
                            { window: "12æ™‚é–“ä»¥é™", symptoms: ["å¾ªç’°ä¸å…¨", "é›£æ²»æ€§ä¸æ•´è„ˆ"], redFlags: ["ã‚·ãƒ§ãƒƒã‚¯"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "1-2",
                            halfLifeHours: "6-12",
                            vdLKg: "0.5",
                            proteinBindingPct: "40",
                            metabolism: "è‚ä»£è¬",
                            elimination: "è…æ’æ³„"
                        },
                        analysis: {
                            recommendedTests: ["è¡€ä¸­ãƒ†ã‚ªãƒ•ã‚£ãƒªãƒ³æ¿ƒåº¦", "å¿ƒé›»å›³", "è¡€æ¸…K", "è¡€ç³–"],
                            interpretation: "æ¿ƒåº¦ãƒ»ç—™æ”£ãƒ»ä¸æ•´è„ˆã§é‡ç—‡åº¦åˆ¤æ–­",
                            notes: "å¤šå›æ´»æ€§ç‚­ã‚„è¡€æ¶²æµ„åŒ–ã‚’æ—©æœŸæ¤œè¨"
                        }
                    },
                    "ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ": {
                        aliases: ["Diazepam"],
                        toxicThresholdMgKg: { caution: 0.3, toxic: 0.5, severe: 1.5, critical: 3.0 },
                        symptomTimeline: [
                            { window: "0-2æ™‚é–“", symptoms: ["å‚¾çœ ", "ãµã‚‰ã¤ã"], redFlags: ["å‘¼å¸æŠ‘åˆ¶"] },
                            { window: "2-12æ™‚é–“", symptoms: ["æ„è­˜éšœå®³", "ä½æ›æ°—"], redFlags: ["æ°—é“åå°„ä½ä¸‹"] },
                            { window: "12æ™‚é–“ä»¥é™", symptoms: ["é·å»¶é®é™"], redFlags: ["å†é®é™"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "0.5-2",
                            halfLifeHours: "20-50",
                            vdLKg: "0.8-1.0",
                            proteinBindingPct: "98",
                            metabolism: "è‚ä»£è¬",
                            elimination: "è…æ’æ³„(ä»£è¬ç‰©)"
                        },
                        analysis: {
                            recommendedTests: ["å‘¼å¸çŠ¶æ…‹", "æ„è­˜ãƒ¬ãƒ™ãƒ«", "è¡€æ¶²ã‚¬ã‚¹"],
                            interpretation: "è‡¨åºŠç—‡çŠ¶ä¸­å¿ƒã«è©•ä¾¡",
                            notes: "ãƒ•ãƒ«ãƒã‚¼ãƒ‹ãƒ«ã¯ç¦å¿Œã‚’ååˆ†ç¢ºèª"
                        }
                    },
                    "ã‚¨ãƒãƒ¬ãƒ³ã‚°ãƒªã‚³ãƒ¼ãƒ«": {
                        aliases: ["Ethylene glycol"],
                        toxicThresholdMgKg: { caution: 30, toxic: 50, severe: 100, critical: 150 },
                        symptomTimeline: [
                            { window: "0-12æ™‚é–“", symptoms: ["é…©é…Šæ§˜ç—‡çŠ¶", "å˜”å"], redFlags: ["æ„è­˜éšœå®³"] },
                            { window: "12-24æ™‚é–“", symptoms: ["ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹", "é »å‘¼å¸"], redFlags: ["é‡åº¦ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹"] },
                            { window: "24-72æ™‚é–“", symptoms: ["è…éšœå®³", "ä¹å°¿"], redFlags: ["è…ä¸å…¨"] }
                        ],
                        toxicokinetics: {
                            tmaxHours: "1-4",
                            halfLifeHours: "3-8",
                            vdLKg: "0.6",
                            proteinBindingPct: "ã»ã¼0",
                            metabolism: "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«è„±æ°´ç´ é…µç´ ",
                            elimination: "è…æ’æ³„"
                        },
                        analysis: {
                            recommendedTests: ["è¡€æ¶²ã‚¬ã‚¹", "æµ¸é€åœ§ã‚®ãƒ£ãƒƒãƒ—", "ã‚¢ãƒ‹ã‚ªãƒ³ã‚®ãƒ£ãƒƒãƒ—", "è…æ©Ÿèƒ½"],
                            interpretation: "ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã¨è…æ©Ÿèƒ½ã§é‡ç—‡åº¦åˆ¤æ–­",
                            notes: "ãƒ›ãƒ¡ãƒ”ã‚¾ãƒ¼ãƒ«/è¡€æ¶²æµ„åŒ–é©å¿œã‚’è¿…é€Ÿåˆ¤å®š"
                        }
                    }
                };

                Object.keys(this.ingredientDB).forEach((ingredientName) => {
                    const legacy = this.ingredientDB[ingredientName];
                    const combined = {
                        ...this.buildLegacyJpicProfile(ingredientName, legacy),
                        ...(jpicMaster[ingredientName] || {})
                    };
                    const normalized = this.normalizeJpicProfile(combined, ingredientName);
                    legacy.jpic = normalized;

                    if (!Number.isFinite(legacy.toxicDoseMgKg) && Number.isFinite(normalized.toxicThresholdMgKg.toxic)) {
                        legacy.toxicDoseMgKg = normalized.toxicThresholdMgKg.toxic;
                    }
                    if (!Number.isFinite(legacy.severeDoseMgKg) && Number.isFinite(normalized.toxicThresholdMgKg.severe)) {
                        legacy.severeDoseMgKg = normalized.toxicThresholdMgKg.severe;
                    }
                    if (!Number.isFinite(legacy.criticalDoseMgKg) && Number.isFinite(normalized.toxicThresholdMgKg.critical)) {
                        legacy.criticalDoseMgKg = normalized.toxicThresholdMgKg.critical;
                    }
                });
            }

            buildLegacyJpicProfile(ingredientName, legacy) {
                const toxic = Number.isFinite(legacy.toxicDoseMgKg) ? legacy.toxicDoseMgKg : null;
                const severe = Number.isFinite(legacy.severeDoseMgKg) ? legacy.severeDoseMgKg : (toxic ? toxic * 1.5 : null);
                const critical = Number.isFinite(legacy.criticalDoseMgKg) ? legacy.criticalDoseMgKg : (toxic ? toxic * 2 : null);

                const earlySymptoms = Array.isArray(legacy.symptoms) ? legacy.symptoms.slice(0, 3) : [];
                const lateSymptoms = Array.isArray(legacy.criticalSymptoms) ? legacy.criticalSymptoms : [];

                return {
                    schemaVersion: this.jpicSchemaSpec.schemaVersion,
                    ingredientName,
                    aliases: [],
                    toxicThresholdMgKg: {
                        caution: toxic ? toxic * 0.5 : null,
                        toxic,
                        severe,
                        critical
                    },
                    symptomTimeline: [
                        { window: "0-2æ™‚é–“", symptoms: earlySymptoms, redFlags: [] },
                        { window: "2-8æ™‚é–“", symptoms: legacy.symptoms || [], redFlags: lateSymptoms },
                        { window: "8-24æ™‚é–“", symptoms: lateSymptoms.length > 0 ? lateSymptoms : legacy.symptoms || [], redFlags: lateSymptoms }
                    ],
                    toxicokinetics: {
                        tmaxHours: "æƒ…å ±ä¸è¶³",
                        halfLifeHours: "æƒ…å ±ä¸è¶³",
                        vdLKg: "æƒ…å ±ä¸è¶³",
                        proteinBindingPct: "æƒ…å ±ä¸è¶³",
                        metabolism: "æƒ…å ±ä¸è¶³",
                        elimination: "æƒ…å ±ä¸è¶³"
                    },
                    treatmentGuide: {
                        decontamination: `${legacy.lavage?.allow ? "èƒƒæ´—æµ„æ¤œè¨" : "èƒƒæ´—æµ„ã¯é€šå¸¸éæ¨å¥¨"} / ${legacy.charcoal?.allow ? "æ´»æ€§ç‚­æ¤œè¨" : "æ´»æ€§ç‚­ã¯æ¡ä»¶ç¢ºèª"}`,
                        antidote: legacy.antidote?.name || "æƒ…å ±ä¸è¶³",
                        extracorporeal: legacy.dialysis?.effective ? "è¡€æ¶²æµ„åŒ–æœ‰åŠ¹æ€§ã‚ã‚Š" : "è¡€æ¶²æµ„åŒ–æœ‰åŠ¹æ€§ä½ã„",
                        other: "å€‹åˆ¥ç—‡çŠ¶ã«å¿œã˜ãŸæ”¯æŒç™‚æ³•"
                    },
                    analysis: {
                        recommendedTests: ["ãƒã‚¤ã‚¿ãƒ«", "è¡€æ¶²ã‚¬ã‚¹", "é›»è§£è³ª"],
                        interpretation: "è‡¨åºŠç—‡çŠ¶ã¨æ‘‚å–é‡ã‹ã‚‰ç·åˆåˆ¤æ–­",
                        notes: "å¿…è¦ã«å¿œã˜ã¦ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ã¸ç¢ºèª"
                    },
                    evidence: {
                        source: "JPICäº’æ›å†…éƒ¨ãƒã‚¹ã‚¿ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ç”±æ¥ï¼‰",
                        updatedAt: "2026-02-13",
                        level: "training"
                    }
                };
            }

            normalizeJpicProfile(profile, fallbackName = "ä¸æ˜æˆåˆ†") {
                const raw = profile || {};
                const thresholds = raw.toxicThresholdMgKg || {};
                const normalizedTimeline = Array.isArray(raw.symptomTimeline) ? raw.symptomTimeline : [];

                return {
                    schemaVersion: raw.schemaVersion || this.jpicSchemaSpec.schemaVersion,
                    ingredientName: raw.ingredientName || fallbackName,
                    aliases: [...new Set((raw.aliases || []).map((item) => String(item).trim()).filter(Boolean))],
                    toxicThresholdMgKg: {
                        caution: Number.isFinite(thresholds.caution) ? thresholds.caution : null,
                        toxic: Number.isFinite(thresholds.toxic) ? thresholds.toxic : null,
                        severe: Number.isFinite(thresholds.severe) ? thresholds.severe : null,
                        critical: Number.isFinite(thresholds.critical) ? thresholds.critical : null
                    },
                    symptomTimeline: normalizedTimeline.map((item) => ({
                        window: String(item.window || "ä¸æ˜"),
                        symptoms: [...new Set((item.symptoms || []).map((v) => String(v).trim()).filter(Boolean))],
                        redFlags: [...new Set((item.redFlags || []).map((v) => String(v).trim()).filter(Boolean))]
                    })),
                    toxicokinetics: {
                        tmaxHours: String(raw.toxicokinetics?.tmaxHours || "æƒ…å ±ä¸è¶³"),
                        halfLifeHours: String(raw.toxicokinetics?.halfLifeHours || "æƒ…å ±ä¸è¶³"),
                        vdLKg: String(raw.toxicokinetics?.vdLKg || "æƒ…å ±ä¸è¶³"),
                        proteinBindingPct: String(raw.toxicokinetics?.proteinBindingPct || "æƒ…å ±ä¸è¶³"),
                        metabolism: String(raw.toxicokinetics?.metabolism || "æƒ…å ±ä¸è¶³"),
                        elimination: String(raw.toxicokinetics?.elimination || "æƒ…å ±ä¸è¶³")
                    },
                    treatmentGuide: {
                        decontamination: String(raw.treatmentGuide?.decontamination || "æƒ…å ±ä¸è¶³"),
                        antidote: String(raw.treatmentGuide?.antidote || "æƒ…å ±ä¸è¶³"),
                        extracorporeal: String(raw.treatmentGuide?.extracorporeal || "æƒ…å ±ä¸è¶³"),
                        other: String(raw.treatmentGuide?.other || "æƒ…å ±ä¸è¶³")
                    },
                    analysis: {
                        recommendedTests: [...new Set((raw.analysis?.recommendedTests || []).map((v) => String(v).trim()).filter(Boolean))],
                        interpretation: String(raw.analysis?.interpretation || "æƒ…å ±ä¸è¶³"),
                        notes: String(raw.analysis?.notes || "")
                    },
                    evidence: {
                        source: String(raw.evidence?.source || "JPICäº’æ›å†…éƒ¨ãƒã‚¹ã‚¿"),
                        updatedAt: String(raw.evidence?.updatedAt || "ä¸æ˜"),
                        level: String(raw.evidence?.level || "training")
                    }
                };
            }

            buildUnknownJpicProfile(ingredientName = "ä¸æ˜æˆåˆ†") {
                return this.normalizeJpicProfile({
                    ingredientName,
                    toxicThresholdMgKg: { caution: null, toxic: null, severe: null, critical: null },
                    symptomTimeline: [{ window: "0-24æ™‚é–“", symptoms: ["æƒ…å ±ä¸è¶³"], redFlags: ["é‡ç—‡å¾´å€™ãŒã‚ã‚Œã°ç›´ã¡ã«å°‚é–€ç›¸è«‡"] }],
                    toxicokinetics: {
                        tmaxHours: "æƒ…å ±ä¸è¶³",
                        halfLifeHours: "æƒ…å ±ä¸è¶³",
                        vdLKg: "æƒ…å ±ä¸è¶³",
                        proteinBindingPct: "æƒ…å ±ä¸è¶³",
                        metabolism: "æƒ…å ±ä¸è¶³",
                        elimination: "æƒ…å ±ä¸è¶³"
                    },
                    treatmentGuide: {
                        decontamination: "æˆåˆ†åŒå®šå¾Œã«é©å¿œåˆ¤æ–­",
                        antidote: "ä¸æ˜",
                        extracorporeal: "ç‰©æ€§æƒ…å ±ç¢ºèªå¾Œã«åˆ¤æ–­",
                        other: "ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ã¸ç…§ä¼š"
                    },
                    analysis: {
                        recommendedTests: ["è¡€æ¶²ã‚¬ã‚¹", "é›»è§£è³ª", "è…æ©Ÿèƒ½", "è‚æ©Ÿèƒ½"],
                        interpretation: "ç—‡å€™å­¦çš„ã«é‡ç—‡åº¦ã‚’æš«å®šåˆ¤å®š",
                        notes: "ä¸€æ¬¡æƒ…å ±ã‚½ãƒ¼ã‚¹ã§å†è©•ä¾¡"
                    },
                    evidence: {
                        source: "JPICäº’æ›å†…éƒ¨ãƒã‚¹ã‚¿",
                        updatedAt: "2026-02-13",
                        level: "unknown"
                    }
                }, ingredientName);
            }

            getJpicProfile(ingredientInfo, ingredientName = "ä¸æ˜æˆåˆ†") {
                if (ingredientInfo?.jpic) {
                    return this.normalizeJpicProfile(ingredientInfo.jpic, ingredientName);
                }
                return this.buildUnknownJpicProfile(ingredientName);
            }

            parseHourRangeFromWindow(windowLabel) {
                const normalized = String(windowLabel || "").replace(/\s+/g, "");
                const match = normalized.match(/([0-9]+(?:\.[0-9]+)?)\-([0-9]+(?:\.[0-9]+)?)æ™‚é–“/);
                if (match) {
                    return { start: Number(match[1]), end: Number(match[2]) };
                }
                const single = normalized.match(/([0-9]+(?:\.[0-9]+)?)æ™‚é–“ä»¥é™/);
                if (single) {
                    return { start: Number(single[1]), end: Number.POSITIVE_INFINITY };
                }
                return null;
            }

            assessTimeline(jpicProfile, elapsedMin, observedSymptoms) {
                const elapsedHour = elapsedMin / 60;
                const timeline = Array.isArray(jpicProfile?.symptomTimeline) ? jpicProfile.symptomTimeline : [];
                if (timeline.length === 0) {
                    return {
                        phase: "ä¸æ˜",
                        expectedSymptoms: ["æƒ…å ±ä¸è¶³"],
                        redFlags: [],
                        matchedRedFlags: []
                    };
                }

                let currentPhase = timeline[0];
                for (const phase of timeline) {
                    const range = this.parseHourRangeFromWindow(phase.window);
                    if (!range) continue;
                    if (elapsedHour >= range.start && elapsedHour <= range.end) {
                        currentPhase = phase;
                        break;
                    }
                }

                const matchedRedFlags = (currentPhase.redFlags || []).filter((flag) => {
                    return observedSymptoms.some((symptom) => symptom.includes(flag) || flag.includes(symptom));
                });

                return {
                    phase: currentPhase.window || "ä¸æ˜",
                    expectedSymptoms: currentPhase.symptoms || [],
                    redFlags: currentPhase.redFlags || [],
                    matchedRedFlags
                };
            }

            formatThresholdSummary(thresholds) {
                const value = (num) => (Number.isFinite(num) ? `${num} mg/kg` : "ä¸æ˜");
                return `æ³¨æ„ ${value(thresholds?.caution)} / ä¸­æ¯’ ${value(thresholds?.toxic)} / é‡ç—‡ ${value(thresholds?.severe)} / å±æ©Ÿ ${value(thresholds?.critical)}`;
            }

            setDatasetStatus(message, tone = "info") {
                const statusEl = document.getElementById("datasetStatus");
                if (!statusEl) return;
                statusEl.textContent = message;

                statusEl.classList.remove("text-slate-500", "text-green-700", "text-amber-700");
                if (tone === "success") {
                    statusEl.classList.add("text-green-700");
                } else if (tone === "warn") {
                    statusEl.classList.add("text-amber-700");
                } else {
                    statusEl.classList.add("text-slate-500");
                }
            }

            setAmountCalcStatus(message, tone = "info") {
                const statusEl = document.getElementById("amountCalcStatus");
                if (!statusEl) return;
                statusEl.textContent = message;
                statusEl.classList.remove("text-slate-500", "text-green-700", "text-amber-700", "text-rose-700");
                if (tone === "success") statusEl.classList.add("text-green-700");
                else if (tone === "warn") statusEl.classList.add("text-amber-700");
                else if (tone === "error") statusEl.classList.add("text-rose-700");
                else statusEl.classList.add("text-slate-500");
            }

            hasTabletInputs() {
                const strength = Number(document.getElementById("strengthInput").value);
                const count = Number(document.getElementById("tabletCountInput").value);
                return Number.isFinite(strength) && strength > 0 && Number.isFinite(count) && count > 0;
            }

            amountTokenToMg(parsedAmount) {
                if (!parsedAmount) return null;
                const value = Number(parsedAmount.value);
                if (!Number.isFinite(value) || value <= 0) return null;
                const unit = String(parsedAmount.unit || "").toLowerCase();
                if (unit === "mg") return value;
                if (unit === "g") return value * 1000;
                if (unit === "Î¼g" || unit === "Âµg" || unit === "mcg") return value / 1000;
                return null;
            }

            parseDoseUnitCountFromText(ingredientText) {
                const normalized = String(ingredientText || "").normalize("NFKC").replace(/\s+/g, "");
                if (!normalized) return null;
                const match = normalized.match(/([0-9]+(?:\.[0-9]+)?)(éŒ |ã‚«ãƒ—ã‚»ãƒ«)ä¸­/)
                    || normalized.match(/1å›é‡[ï¼ˆ(]([0-9]+(?:\.[0-9]+)?)(éŒ |ã‚«ãƒ—ã‚»ãƒ«)[ï¼‰)]ä¸­/);
                if (!match) return null;
                return {
                    count: Number(match[1]),
                    unit: match[2]
                };
            }

            inferStrengthFromProductName(productName) {
                const normalized = String(productName || "").normalize("NFKC");
                const withMg = normalized.match(/([0-9]+(?:\.[0-9]+)?)\s*mg/i);
                if (withMg) return Number(withMg[1]);

                const tabletValue = normalized.match(/(?:OD)?éŒ \s*([0-9]+(?:\.[0-9]+)?)/i);
                if (tabletValue) return Number(tabletValue[1]);
                return null;
            }

            estimateStrengthHintFromProduct(product) {
                const dosageForm = String(product?.dosage_form || "");
                const looksTablet = dosageForm.includes("éŒ ");
                if (!looksTablet) {
                    return this.inferStrengthFromProductName(product?.product_name || "");
                }

                const unitInfo = this.parseDoseUnitCountFromText(product?.ingredient_text || "");
                if (!unitInfo || unitInfo.unit !== "éŒ " || !Number.isFinite(unitInfo.count) || unitInfo.count <= 0) {
                    return this.inferStrengthFromProductName(product?.product_name || "");
                }

                const ingredients = Array.isArray(product?.ingredients) ? product.ingredients : [];
                const totalMg = ingredients.reduce((sum, item) => {
                    const mg = this.amountTokenToMg(this.parseAmountToken(item?.amount || ""));
                    return Number.isFinite(mg) ? sum + mg : sum;
                }, 0);

                if (Number.isFinite(totalMg) && totalMg > 0) {
                    return totalMg / unitInfo.count;
                }
                return this.inferStrengthFromProductName(product?.product_name || "");
            }

            seedStrengthHintsFromProductNames() {
                Object.keys(this.productDB).forEach((productName) => {
                    const hinted = this.inferStrengthFromProductName(productName);
                    if (Number.isFinite(hinted) && hinted > 0) {
                        this.productStrengthHintsMg[productName] = hinted;
                    }
                });
            }

            findBestProductKeyByPartialName(targetName) {
                const normalizedTarget = this.normalizeName(targetName);
                if (!normalizedTarget || normalizedTarget.length < 2) return null;
                const candidates = Object.keys(this.productDB).filter((key) => {
                    const normalizedKey = this.normalizeName(key);
                    return normalizedKey.includes(normalizedTarget) || normalizedTarget.includes(normalizedKey);
                });
                if (candidates.length === 0) return null;
                if (candidates.length === 1) return candidates[0];

                const startsWith = candidates.filter((key) => this.normalizeName(key).startsWith(normalizedTarget));
                if (startsWith.length === 1) return startsWith[0];
                return null;
            }

            estimateStrengthForDrugName(drugName) {
                if (!drugName) return null;
                const exactProductKey = this.findKeyByNormalizedName(this.productDB, drugName);
                if (exactProductKey && Number.isFinite(this.productStrengthHintsMg[exactProductKey])) {
                    return this.productStrengthHintsMg[exactProductKey];
                }
                if (exactProductKey) {
                    const inferred = this.inferStrengthFromProductName(exactProductKey);
                    if (Number.isFinite(inferred) && inferred > 0) return inferred;
                }

                const partialProductKey = this.findBestProductKeyByPartialName(drugName);
                if (partialProductKey && Number.isFinite(this.productStrengthHintsMg[partialProductKey])) {
                    return this.productStrengthHintsMg[partialProductKey];
                }
                if (partialProductKey) {
                    const inferred = this.inferStrengthFromProductName(partialProductKey);
                    if (Number.isFinite(inferred) && inferred > 0) return inferred;
                }

                const direct = this.inferStrengthFromProductName(drugName);
                if (Number.isFinite(direct) && direct > 0) return direct;
                return null;
            }

            tryAutoFillStrength() {
                const drugName = document.getElementById("drugInput").value.trim();
                if (!drugName) return;

                const strengthInput = document.getElementById("strengthInput");
                const allowOverride = !strengthInput.value || strengthInput.dataset.autoFilled === "1";
                if (!allowOverride) return;

                const suggested = this.estimateStrengthForDrugName(drugName);
                if (!Number.isFinite(suggested) || suggested <= 0) return;

                const displayValue = Number.isInteger(suggested) ? String(suggested) : this.formatNumber(suggested, 2);
                strengthInput.value = displayValue;
                strengthInput.dataset.autoFilled = "1";
                this.recalculateTotalAmount();
                this.setAmountCalcStatus(`è¦æ ¼å€™è£œã‚’è‡ªå‹•å…¥åŠ›: ${displayValue} mg/éŒ `, "success");
            }

            recalculateTotalAmount() {
                const strength = Number(document.getElementById("strengthInput").value);
                const count = Number(document.getElementById("tabletCountInput").value);
                const amountInput = document.getElementById("amountInput");
                if (!Number.isFinite(strength) || strength <= 0 || !Number.isFinite(count) || count <= 0) {
                    if (!amountInput.value) {
                        this.setAmountCalcStatus("è¦æ ¼ã¨éŒ æ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨ç·é‡ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚", "info");
                    }
                    return null;
                }

                const total = strength * count;
                const totalText = Number.isInteger(total) ? String(total) : this.formatNumber(total, 2);
                amountInput.value = totalText;
                const countText = Number.isInteger(count) ? String(count) : this.formatNumber(count, 2);
                this.setAmountCalcStatus(`${this.formatNumber(strength, 2)} mg/éŒ  Ã— ${countText} éŒ  = ${totalText} mg`, "success");
                return total;
            }

            setOcrStatus(message, tone = "info") {
                const statusEl = document.getElementById("ocrStatus");
                if (!statusEl) return;
                statusEl.textContent = message;
                statusEl.classList.remove("text-slate-500", "text-green-700", "text-amber-700", "text-rose-700");
                if (tone === "success") statusEl.classList.add("text-green-700");
                else if (tone === "warn") statusEl.classList.add("text-amber-700");
                else if (tone === "error") statusEl.classList.add("text-rose-700");
                else statusEl.classList.add("text-slate-500");
            }

            setReportStatus(message, tone = "info") {
                const statusEl = document.getElementById("reportStatus");
                if (!statusEl) return;
                statusEl.textContent = message;
                statusEl.classList.remove("text-slate-500", "text-green-700", "text-amber-700", "text-rose-700");
                if (tone === "success") statusEl.classList.add("text-green-700");
                else if (tone === "warn") statusEl.classList.add("text-amber-700");
                else if (tone === "error") statusEl.classList.add("text-rose-700");
                else statusEl.classList.add("text-slate-500");
            }

            groupEntriesByInputDrug() {
                const grouped = new Map();
                this.entries.forEach((entry) => {
                    const key = `${entry.inputDrug}__${entry.sourceMode || "manual"}`;
                    if (!grouped.has(key)) {
                        grouped.set(key, {
                            inputDrug: entry.inputDrug,
                            sourceMode: entry.sourceMode || "manual",
                            sourceDrug: entry.sourceDrug,
                            totalAmountMg: 0,
                            ingredientSet: new Set()
                        });
                    }
                    const target = grouped.get(key);
                    target.totalAmountMg += Number(entry.ingredientAmountMg) || 0;
                    target.ingredientSet.add(entry.ingredient);
                });
                return [...grouped.values()].sort((a, b) => b.totalAmountMg - a.totalAmountMg);
            }

            collectRecommendedTests() {
                const tests = new Set();
                this.entries.forEach((entry) => {
                    const recommended = entry.jpicProfile?.analysis?.recommendedTests || [];
                    recommended.forEach((testName) => {
                        const clean = String(testName || "").trim();
                        if (clean) tests.add(clean);
                    });
                });
                return [...tests];
            }

            formatTreatmentForReport(label, payload) {
                const status = payload?.status || "æƒ…å ±ä¸è¶³";
                const action = payload?.action || "æƒ…å ±ä¸è¶³";
                const reason = payload?.reason || "æƒ…å ±ä¸è¶³";
                return `- ${label}: [${status}] ${action}\n  æ ¹æ‹ : ${reason}`;
            }

            generateReportText() {
                const now = new Date();
                const generatedAt = now.toLocaleString("ja-JP", { hour12: false });
                const weight = Number(document.getElementById("patientWeight").value);
                const elapsedMin = Number(document.getElementById("elapsedMinutes").value);
                const airwaySecured = document.getElementById("airwaySecured").checked;
                const observedSymptoms = this.parseSymptoms(document.getElementById("observedSymptoms").value);

                const symptomsText = observedSymptoms.length > 0 ? observedSymptoms.join(", ") : "è¨˜è¼‰ãªã—";
                const groupedInputs = this.groupEntriesByInputDrug();
                const recommendedTests = this.collectRecommendedTests();

                const inputDrugBlock = groupedInputs.length > 0
                    ? groupedInputs.map((item, index) => {
                        const sourceLabel = item.sourceMode === "photo_ocr" ? "å†™çœŸOCR" : "æ‰‹å…¥åŠ›";
                        const ingredientList = [...item.ingredientSet].join(", ");
                        return `${index + 1}. ${item.inputDrug}\n   - æ¨å®šç·é‡: ${this.formatNumber(item.totalAmountMg, 1)} mg\n   - å…¥åŠ›çµŒè·¯: ${sourceLabel}\n   - å±•é–‹æˆåˆ†: ${ingredientList}`;
                    }).join("\n")
                    : "è¨˜è¼‰ãªã—";

                const severityBlock = this.entries.length > 0
                    ? this.entries.map((entry, index) => {
                        const thresholdText = this.formatThresholdSummary(entry.jpicProfile?.toxicThresholdMgKg || {});
                        const matched = entry.matchedSymptoms.length > 0 ? entry.matchedSymptoms.join(", ") : "ä¸€è‡´ãªã—";
                        const redFlags = (entry.timelineAssessment?.matchedRedFlags || []).join(", ") || "ä¸€è‡´ãªã—";
                        return `${index + 1}. ${entry.ingredient} (${entry.component})\n   - åˆ¤å®š: ${entry.severity.label}ï¼ˆ${entry.severity.detail}ï¼‰\n   - æ¨å®šæˆåˆ†é‡: ${this.formatNumber(entry.ingredientAmountMg, 1)} mg\n   - æ¨å®šæ‘‚å–é‡: ${this.formatNumber(entry.doseMgKg, 2)} mg/kg\n   - æ¯’æ€§æ¯”: ${entry.unknown ? "ä¸æ˜" : `${entry.toxicRatio ? this.formatNumber(entry.toxicRatio, 2) : "0.00"} x ä¸­æ¯’é‡`}\n   - é–¾å€¤: ${thresholdText}\n   - ç—‡çŠ¶ä¸€è‡´: ${matched}\n   - èµ¤æ——ä¸€è‡´: ${redFlags}`;
                    }).join("\n")
                    : "è¨˜è¼‰ãªã—";

                const treatmentBlock = this.entries.length > 0
                    ? this.entries.map((entry, index) => {
                        const otherLines = (entry.treatment?.others || []).map((item) => `- ãã®ä»–: [${item.status}] ${item.name}\n  æ ¹æ‹ : ${item.reason}`).join("\n");
                        return [
                            `${index + 1}. ${entry.ingredient}`,
                            this.formatTreatmentForReport("æ‹®æŠ—è–¬", entry.treatment?.antidote),
                            this.formatTreatmentForReport("èƒƒæ´—æµ„", entry.treatment?.lavage),
                            this.formatTreatmentForReport("æ´»æ€§ç‚­", entry.treatment?.charcoal),
                            this.formatTreatmentForReport("è¡€æ¶²æµ„åŒ–", entry.treatment?.dialysis),
                            otherLines || "- ãã®ä»–: è¨˜è¼‰ãªã—"
                        ].join("\n");
                    }).join("\n")
                    : "è¨˜è¼‰ãªã—";

                const testsBlock = recommendedTests.length > 0 ? recommendedTests.map((item) => `- ${item}`).join("\n") : "- æ¨å¥¨æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿ãªã—";

                return [
                    `[ToxicNavi Report | ${this.reportSpecVersion}]`,
                    `ä½œæˆæ—¥æ™‚: ${generatedAt}`,
                    "",
                    "â– æ‚£è€…æƒ…å ±",
                    `- ä½“é‡: ${Number.isFinite(weight) ? `${weight} kg` : "æœªå…¥åŠ›"}`,
                    `- æ‘‚å–ã‹ã‚‰ã®æ™‚é–“: ${Number.isFinite(elapsedMin) ? `${elapsedMin} åˆ†` : "æœªå…¥åŠ›"}`,
                    `- æ°—é“ç¢ºä¿: ${airwaySecured ? "æ¸ˆã¿" : "æœª"}`,
                    `- è¦³å¯Ÿç—‡çŠ¶: ${symptomsText}`,
                    "",
                    "â– å…¥åŠ›è–¬å‰¤ï¼ˆè£½å‰¤ãƒ™ãƒ¼ã‚¹ï¼‰",
                    inputDrugBlock,
                    "",
                    "â– æˆåˆ†åˆ¥é‡ç—‡åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
                    severityBlock,
                    "",
                    "â– æ²»ç™‚ä»‹å…¥å¦¥å½“æ€§",
                    treatmentBlock,
                    "",
                    "â– æ¨å¥¨æ¤œæŸ»ï¼ˆé‡è¤‡é™¤å¤–ï¼‰",
                    testsBlock,
                    "",
                    "â– æ³¨è¨˜",
                    "- æœ¬å‡ºåŠ›ã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è¨ˆç®—ã«ã‚ˆã‚‹æ”¯æ´æƒ…å ±ã§ã™ã€‚",
                    "- æœ€çµ‚åˆ¤æ–­ã¯ä¸€æ¬¡æƒ…å ±ï¼ˆæ·»ä»˜æ–‡æ›¸/ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ï¼‰ã¨è‡¨åºŠæ‰€è¦‹ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
                ].join("\n");
            }

            renderReportOutput(statusMessage = "") {
                const outputEl = document.getElementById("reportOutput");
                if (!outputEl) return;
                outputEl.value = this.generateReportText();
                if (statusMessage) {
                    this.setReportStatus(statusMessage, "success");
                } else {
                    const summary = this.entries.length > 0 ? `${this.entries.length} æˆåˆ†ã‚’åæ˜ ` : "æœªå…¥åŠ›";
                    this.setReportStatus(`å ±å‘Šæ›¸ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆ${summary}ï¼‰`, "info");
                }
            }

            async copyReportOutput() {
                const outputEl = document.getElementById("reportOutput");
                if (!outputEl) return;
                const text = String(outputEl.value || "").trim();
                if (!text) {
                    this.setReportStatus("ã‚³ãƒ”ãƒ¼ã™ã‚‹å‡ºåŠ›ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "warn");
                    return;
                }

                try {
                    if (typeof navigator !== "undefined" && navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
                        await navigator.clipboard.writeText(text);
                        this.setReportStatus("å ±å‘Šæ›¸ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚", "success");
                        return;
                    }
                } catch (error) {
                    // fallback ã¸ç§»è¡Œ
                }

                outputEl.focus();
                outputEl.select();
                const success = typeof document.execCommand === "function" && document.execCommand("copy");
                if (success) {
                    this.setReportStatus("å ±å‘Šæ›¸ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚", "success");
                } else {
                    this.setReportStatus("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚", "error");
                }
            }

            buildSearchEntries() {
                const byNorm = new Map();
                const pushEntry = (name, type) => {
                    const normalized = this.normalizeName(name);
                    if (!normalized) return;
                    const current = byNorm.get(normalized);
                    if (!current || (current.type === "ingredient" && type === "product")) {
                        byNorm.set(normalized, { name, type, normalized });
                    }
                };

                Object.keys(this.productDB).forEach((name) => pushEntry(name, "product"));
                Object.keys(this.ingredientDB).forEach((name) => pushEntry(name, "ingredient"));
                this.searchEntries = [...byNorm.values()];
            }

            buildIngestionContextFromInputs({ showAlert = true } = {}) {
                const patientWeight = Number(document.getElementById("patientWeight").value);
                const elapsedMin = Number(document.getElementById("elapsedMinutes").value);
                const airwaySecured = document.getElementById("airwaySecured").checked;
                const observedSymptoms = this.parseSymptoms(document.getElementById("observedSymptoms").value);

                if (!Number.isFinite(patientWeight) || patientWeight <= 0) {
                    if (showAlert) alert("ä½“é‡(kg)ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return null;
                }
                if (!Number.isFinite(elapsedMin) || elapsedMin < 0) {
                    if (showAlert) alert("æ‘‚å–ã‹ã‚‰ã®æ™‚é–“(åˆ†)ã‚’0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return null;
                }

                return {
                    patientWeight,
                    elapsedMin,
                    airwaySecured,
                    observedSymptoms
                };
            }

            normalizeDrugNameCandidate(rawName) {
                const stopWords = [
                    "ssri", "snri", "nassa", "æŠ—ã†ã¤è–¬", "æŠ—ä¸å®‰è–¬", "ç¡çœ è–¬", "æŠ—ç²¾ç¥ç—…è–¬", "è§£ç†±é®ç—›è–¬",
                    "ä¸»ãªãƒªã‚¹ã‚¯", "ä¸€èˆ¬å", "è–¬å‰¤å", "æ¨å®šåˆè¨ˆé‡", "æ‘‚å–éŒ æ•°", "1éŒ å«æœ‰é‡", "mg", "éŒ "
                ];
                let name = String(rawName || "")
                    .normalize("NFKC")
                    .replace(/[|ï½œ]/g, " ")
                    .replace(/[ï¼š:]/g, " ")
                    .replace(/^[\-\sãƒ»]+/, "")
                    .replace(/\s+/g, " ")
                    .trim();

                stopWords.forEach((word) => {
                    const pattern = new RegExp(word, "ig");
                    name = name.replace(pattern, " ");
                });
                name = name.replace(/\s+/g, " ").trim();
                return name;
            }

            convertDoseToMg(value, unit) {
                const numeric = Number(value);
                if (!Number.isFinite(numeric)) return null;
                const normalizedUnit = String(unit || "").toLowerCase().replace("ï½ï½‡", "mg").replace("ï½‡", "g");
                if (normalizedUnit === "mg") return numeric;
                if (normalizedUnit === "g") return numeric * 1000;
                if (normalizedUnit === "Î¼g" || normalizedUnit === "Âµg" || normalizedUnit === "ug" || normalizedUnit === "mcg") {
                    return numeric / 1000;
                }
                return null;
            }

            matchDrugCandidate(rawName) {
                const normalizedRaw = this.normalizeName(rawName).replace(/[0-9]/g, "");
                if (!normalizedRaw) return null;

                const exact = this.searchEntries.find((entry) => entry.normalized === normalizedRaw);
                if (exact) {
                    return { ...exact, score: 1, strategy: "exact" };
                }

                const candidates = this.searchEntries
                    .filter((entry) => entry.normalized.includes(normalizedRaw) || normalizedRaw.includes(entry.normalized))
                    .map((entry) => {
                        const overlap = Math.min(entry.normalized.length, normalizedRaw.length) / Math.max(entry.normalized.length, normalizedRaw.length);
                        const typeBonus = entry.type === "product" ? 0.08 : 0;
                        const score = Math.min(0.96, 0.58 + overlap * 0.36 + typeBonus);
                        return { ...entry, score, strategy: "contains" };
                    })
                    .sort((a, b) => b.score - a.score);

                return candidates.length > 0 ? candidates[0] : null;
            }

            extractDrugCandidatesFromText(rawText) {
                const normalizedText = String(rawText || "").replace(/\r/g, "");
                const lines = normalizedText.split("\n").map((line) => line.trim()).filter(Boolean);
                const candidates = [];

                for (const line of lines) {
                    const lineNormalized = line.normalize("NFKC");
                    if (!/(éŒ |mg|g|Î¼g|ug|mcg)/i.test(lineNormalized)) continue;
                    if (/(bp|hr|rr|spo2|etco2|gcs|jcs|mmhg|ä½“æ¸©)/i.test(lineNormalized) && !/éŒ /.test(lineNormalized)) continue;

                    const countMatch = lineNormalized.match(/([0-9]+(?:\.[0-9]+)?)\s*éŒ /);
                    if (!countMatch) continue;
                    const tabletCount = Number(countMatch[1]);
                    if (!Number.isFinite(tabletCount) || tabletCount <= 0) continue;

                    const doseMatches = [...lineNormalized.matchAll(/([0-9]+(?:\.[0-9]+)?)\s*(mg|ï½ï½‡|g|ï½‡|Î¼g|Âµg|ug|mcg)/gi)];
                    let strengthPerTabletMg = null;
                    let totalAmountMg = null;
                    if (doseMatches.length > 0) {
                        strengthPerTabletMg = this.convertDoseToMg(doseMatches[0][1], doseMatches[0][2]);
                    }
                    if (doseMatches.length > 1) {
                        totalAmountMg = this.convertDoseToMg(doseMatches[doseMatches.length - 1][1], doseMatches[doseMatches.length - 1][2]);
                    }
                    if (!Number.isFinite(totalAmountMg) && Number.isFinite(strengthPerTabletMg)) {
                        totalAmountMg = strengthPerTabletMg * tabletCount;
                    }

                    const firstDoseIndex = doseMatches.length > 0 ? doseMatches[0].index : lineNormalized.length;
                    const countIndex = countMatch.index ?? lineNormalized.length;
                    const nameIndex = Math.min(firstDoseIndex, countIndex);
                    const nameCandidate = this.normalizeDrugNameCandidate(lineNormalized.slice(0, nameIndex));
                    if (!nameCandidate || nameCandidate.length < 2) continue;

                    const matched = this.matchDrugCandidate(nameCandidate);
                    const resolvedName = matched ? matched.name : nameCandidate;
                    const matchType = matched ? `${matched.type}:${matched.strategy}` : "none";
                    const confidence = matched ? Number(matched.score.toFixed(2)) : 0;

                    candidates.push({
                        sourceLine: lineNormalized,
                        detectedName: nameCandidate,
                        resolvedName,
                        matchType,
                        confidence,
                        tabletCount,
                        strengthPerTabletMg: Number.isFinite(strengthPerTabletMg) ? strengthPerTabletMg : null,
                        totalAmountMg: Number.isFinite(totalAmountMg) ? totalAmountMg : null
                    });
                }

                const mergedMap = new Map();
                candidates.forEach((item) => {
                    const key = `${item.resolvedName}__${item.strengthPerTabletMg || "na"}`;
                    const current = mergedMap.get(key);
                    if (!current) {
                        mergedMap.set(key, { ...item });
                        return;
                    }
                    current.tabletCount += item.tabletCount;
                    if (Number.isFinite(current.totalAmountMg) && Number.isFinite(item.totalAmountMg)) {
                        current.totalAmountMg += item.totalAmountMg;
                    } else {
                        current.totalAmountMg = current.totalAmountMg ?? item.totalAmountMg;
                    }
                    current.confidence = Math.max(current.confidence, item.confidence);
                });

                return [...mergedMap.values()];
            }

            parseAndMatchOcrText() {
                const rawText = document.getElementById("ocrRawText").value;
                const parsed = this.extractDrugCandidatesFromText(rawText);
                this.detectedIngestionItems = parsed;
                this.renderDetectedDrugTable();

                if (parsed.length === 0) {
                    this.setOcrStatus("è–¬å‰¤å€™è£œã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "warn");
                } else {
                    const importable = parsed.filter((item) => Number.isFinite(item.totalAmountMg) && item.totalAmountMg > 0).length;
                    this.setOcrStatus(`è§£æå®Œäº†: ${parsed.length} ä»¶æ¤œå‡ºï¼ˆè©•ä¾¡ã¸åæ˜ å¯èƒ½ ${importable} ä»¶ï¼‰`, "success");
                }
            }

            openCameraCapture() {
                if (this.ocrBusy) {
                    this.setOcrStatus("OCRå‡¦ç†ä¸­ã§ã™ã€‚å®Œäº†å¾Œã«æ’®å½±ã—ã¦ãã ã•ã„ã€‚", "warn");
                    return;
                }
                const input = document.getElementById("cameraCaptureInput");
                if (!input) return;
                input.value = "";
                input.click();
            }

            handleCameraCaptureChange(event) {
                const file = event?.target?.files?.[0];
                if (!file) return;
                this.capturedPhotos.push({
                    id: this.photoCounter++,
                    name: file.name || `camera_${Date.now()}.jpg`,
                    file
                });
                this.renderCapturedPhotoList();
                this.setOcrStatus(`å†™çœŸã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆ${this.capturedPhotos.length} æšï¼‰`, "info");
                event.target.value = "";
            }

            removeCapturedPhoto(id) {
                this.capturedPhotos = this.capturedPhotos.filter((item) => item.id !== id);
                this.renderCapturedPhotoList();
                this.setOcrStatus(`æ’®å½±å†™çœŸã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆ${this.capturedPhotos.length} æšï¼‰`, "info");
            }

            renderCapturedPhotoList() {
                const container = document.getElementById("capturedPhotoList");
                if (!container) return;
                if (this.capturedPhotos.length === 0) {
                    container.innerHTML = `<p class="text-slate-400">æ’®å½±ã—ãŸå†™çœŸã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼ˆã€Œå†™çœŸã‚’æ’®å½±ã—ã¦è¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰</p>`;
                    return;
                }
                const chips = this.capturedPhotos.map((item, index) => `
                    <div class="inline-flex items-center gap-2 border border-slate-300 rounded-full px-3 py-1 mr-2 mb-2 bg-slate-50">
                        <span>#${index + 1}: ${this.escapeHTML(item.name)}</span>
                        <button type="button" class="text-rose-700 font-semibold" data-remove-photo-id="${item.id}">å‰Šé™¤</button>
                    </div>
                `).join("");
                container.innerHTML = `
                    <p class="mb-2 text-slate-600">æ’®å½±æ¸ˆã¿: ${this.capturedPhotos.length} æš</p>
                    <div class="flex flex-wrap">${chips}</div>
                `;
            }

            async runOcrFromImages() {
                const files = this.capturedPhotos.map((item) => item.file).filter(Boolean);
                if (files.length === 0) {
                    this.setOcrStatus("å…ˆã«å†™çœŸã‚’æ’®å½±ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚", "warn");
                    return;
                }
                if (typeof Tesseract === "undefined") {
                    this.setOcrStatus("OCRã‚¨ãƒ³ã‚¸ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
                    return;
                }
                if (this.ocrBusy) {
                    this.setOcrStatus("OCRå‡¦ç†ä¸­ã§ã™ã€‚å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚", "warn");
                    return;
                }

                this.ocrBusy = true;
                const outputArea = document.getElementById("ocrRawText");
                const chunks = [];
                this.setOcrStatus(`OCRé–‹å§‹: ${files.length} æš`, "info");

                try {
                    for (let i = 0; i < files.length; i += 1) {
                        const file = files[i];
                        this.setOcrStatus(`OCRå‡¦ç†ä¸­ (${i + 1}/${files.length}): ${file.name}`, "info");
                        const result = await Tesseract.recognize(file, "jpn+eng", {
                            logger: (message) => {
                                if (message.status === "recognizing text" && Number.isFinite(message.progress)) {
                                    const percent = Math.round(message.progress * 100);
                                    this.setOcrStatus(`OCRå‡¦ç†ä¸­ (${i + 1}/${files.length}) ${percent}%`, "info");
                                }
                            }
                        });
                        const text = String(result?.data?.text || "").trim();
                        if (text) {
                            chunks.push(`# OCR(${i + 1}): ${file.name}\n${text}`);
                        }
                    }

                    const mergedText = chunks.join("\n\n");
                    this.ocrLastText = mergedText;
                    outputArea.value = mergedText;
                    this.setOcrStatus(`OCRå®Œäº†: ${files.length} æšã‚’è§£æã—ã¾ã—ãŸ`, "success");
                    this.parseAndMatchOcrText();
                } catch (error) {
                    this.setOcrStatus("OCRå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒå“è³ªã¾ãŸã¯å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error");
                } finally {
                    this.ocrBusy = false;
                }
            }

            clearDetectedItems() {
                this.detectedIngestionItems = [];
                this.capturedPhotos = [];
                document.getElementById("ocrRawText").value = "";
                document.getElementById("cameraCaptureInput").value = "";
                this.renderCapturedPhotoList();
                this.renderDetectedDrugTable();
                this.setOcrStatus("æŠ½å‡ºçµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", "info");
            }

            renderDetectedDrugTable() {
                const table = document.getElementById("detectedDrugTable");
                if (!table) return;
                if (this.detectedIngestionItems.length === 0) {
                    table.innerHTML = `<p class="text-slate-400">è§£æã™ã‚‹ã¨è–¬å‰¤å€™è£œãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>`;
                    return;
                }

                const rows = this.detectedIngestionItems.map((item, index) => {
                    const strengthText = Number.isFinite(item.strengthPerTabletMg) ? `${item.strengthPerTabletMg.toFixed(2)} mg/éŒ ` : "ä¸æ˜";
                    const totalText = Number.isFinite(item.totalAmountMg) ? `${item.totalAmountMg.toFixed(1)} mg` : "ä¸æ˜";
                    return `
                        <tr class="border-t">
                            <td class="p-2 align-top">${index + 1}</td>
                            <td class="p-2 align-top">${this.escapeHTML(item.detectedName)}</td>
                            <td class="p-2 align-top">${this.escapeHTML(item.resolvedName)}</td>
                            <td class="p-2 align-top">${this.escapeHTML(strengthText)}</td>
                            <td class="p-2 align-top">${this.escapeHTML(String(item.tabletCount))} éŒ </td>
                            <td class="p-2 align-top font-semibold">${this.escapeHTML(totalText)}</td>
                            <td class="p-2 align-top text-xs">${this.escapeHTML(item.matchType)} / ${this.escapeHTML(String(item.confidence))}</td>
                        </tr>
                    `;
                }).join("");

                table.innerHTML = `
                    <div class="overflow-x-auto border border-slate-200 rounded">
                        <table class="w-full text-xs md:text-sm">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="p-2 text-left">#</th>
                                    <th class="p-2 text-left">æŠ½å‡ºå</th>
                                    <th class="p-2 text-left">ç…§åˆçµæœ</th>
                                    <th class="p-2 text-left">1éŒ é‡</th>
                                    <th class="p-2 text-left">éŒ æ•°</th>
                                    <th class="p-2 text-left">ç·é‡</th>
                                    <th class="p-2 text-left">ç…§åˆä¿¡é ¼</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            }

            importDetectedItemsToAssessment() {
                if (this.detectedIngestionItems.length === 0) {
                    this.setOcrStatus("å…ˆã«OCRè§£æã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆè§£æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚", "warn");
                    return;
                }
                const ingestionContext = this.buildIngestionContextFromInputs({ showAlert: true });
                if (!ingestionContext) return;

                let imported = 0;
                this.detectedIngestionItems.forEach((item) => {
                    if (!Number.isFinite(item.totalAmountMg) || item.totalAmountMg <= 0) return;
                    this.addDrugCore(item.resolvedName, item.totalAmountMg, ingestionContext, {
                        sourceMode: "photo_ocr",
                        sourceLine: item.sourceLine
                    });
                    imported += 1;
                });

                if (imported === 0) {
                    this.setOcrStatus("ç·é‡è¨ˆç®—ã§ãã‚‹è–¬å‰¤ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è¦æ ¼(mg)ã¨éŒ æ•°ã®è¨˜è¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "warn");
                    return;
                }

                this.entries.sort((a, b) => b.riskScore - a.riskScore);
                this.render();
                this.setOcrStatus(`è¨ºç™‚è©•ä¾¡ã¸ ${imported} ä»¶åæ˜ ã—ã¾ã—ãŸã€‚`, "success");
            }

            parseAmountToken(amountText) {
                const normalized = String(amountText || "")
                    .replaceAll("ï¼…", "%")
                    .replace(/\s+/g, " ")
                    .trim();
                const match = normalized.match(/^([0-9]+(?:\.[0-9]+)?)\s*(mg|g|ml|mL|Î¼g|Âµg|mcg|%|IU|å˜ä½|å›½éš›å˜ä½|mEq)$/i);
                if (!match) return null;
                return {
                    value: Number(match[1]),
                    unit: match[2].toLowerCase()
                };
            }

            canonicalizeIngredientName(name) {
                const raw = String(name || "").trim();
                if (!raw) return "";

                const direct = this.findKeyByNormalizedName(this.ingredientDB, raw);
                if (direct) return direct;

                const byAlias = this.ingredientSynonymIndex[this.normalizeName(raw)];
                if (byAlias) return byAlias;

                const stripped = raw
                    .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, "")
                    .replace(/\([^)]*\)/g, "")
                    .replace(/^ç„¡æ°´/, "")
                    .replace(/æ°´å’Œç‰©$/, "")
                    .replace(/å¡©é…¸å¡©$/, "")
                    .replace(/ãƒªãƒ³é…¸å¡©$/, "")
                    .replace(/è‡­åŒ–æ°´ç´ é…¸å¡©(?:æ°´å’Œç‰©)?$/, "")
                    .replace(/ãƒãƒ¬ã‚¤ãƒ³é…¸å¡©$/, "")
                    .replace(/ç¡«é…¸å¡©$/, "")
                    .replace(/^[dDlL]+[-ï¼]?/, "")
                    .trim();

                if (stripped) {
                    const directStripped = this.findKeyByNormalizedName(this.ingredientDB, stripped);
                    if (directStripped) return directStripped;
                    const byAliasStripped = this.ingredientSynonymIndex[this.normalizeName(stripped)];
                    if (byAliasStripped) return byAliasStripped;
                }

                for (const rule of this.ingredientHeuristicSynonyms) {
                    if (raw.includes(rule.keyword) || stripped.includes(rule.keyword)) {
                        return rule.canonical;
                    }
                }

                return raw;
            }

            canonicalizeIngredientRatios(ratioDefs) {
                const merged = {};
                ratioDefs.forEach((item) => {
                    const canonical = this.canonicalizeIngredientName(item.ingredient);
                    const ratio = Number(item.ratio);
                    if (!canonical || !Number.isFinite(ratio) || ratio <= 0) return;
                    merged[canonical] = (merged[canonical] || 0) + ratio;
                });

                const mergedList = Object.entries(merged).map(([ingredient, ratio]) => ({ ingredient, ratio }));
                const totalRatio = mergedList.reduce((sum, item) => sum + item.ratio, 0);
                if (!Number.isFinite(totalRatio) || totalRatio <= 0) return [];
                return mergedList.map((item) => ({
                    ingredient: item.ingredient,
                    ratio: item.ratio / totalRatio
                }));
            }

            calculateIngredientRatios(ingredients) {
                const normalized = ingredients.map((item) => {
                    const ingredient = String(item.name || "")
                        .trim()
                        .replace(/^[ãƒ»\-]+/, "")
                        .replace(/\s+/g, " ");
                    const parsed = this.parseAmountToken(item.amount || "");
                    return { ingredient, parsed };
                }).filter((item) => item.ingredient);

                if (normalized.length === 0) return [];

                const parsedOnly = normalized.filter((item) => item.parsed && Number.isFinite(item.parsed.value) && item.parsed.value > 0);
                const unitSet = new Set(parsedOnly.map((item) => item.parsed.unit));
                const canWeighted = parsedOnly.length === normalized.length && unitSet.size === 1;

                if (canWeighted) {
                    const total = parsedOnly.reduce((sum, item) => sum + item.parsed.value, 0);
                    if (total > 0) {
                        return normalized.map((item) => ({
                            ingredient: item.ingredient,
                            ratio: item.parsed.value / total
                        }));
                    }
                }

                const equalRatio = 1 / normalized.length;
                return normalized.map((item) => ({
                    ingredient: item.ingredient,
                    ratio: equalRatio
                }));
            }

            buildUnknownIngredientInfo(ingredientName = "ä¸æ˜æˆåˆ†") {
                return {
                    component: "Unknown",
                    toxicDoseMgKg: null,
                    severeDoseMgKg: null,
                    criticalDoseMgKg: null,
                    symptoms: ["æƒ…å ±ä¸è¶³"],
                    criticalSymptoms: [],
                    antidote: { name: "è¦æƒ…å ±ç¢ºèª", indication: "è£½å‰¤æƒ…å ±ã€æˆåˆ†ã€æ¯’æ€§ãƒ‡ãƒ¼ã‚¿ã‚’è‡³æ€¥ç¢ºèª" },
                    lavage: { allow: false, windowMin: 0, note: "æ¯’æ€§ä¸æ˜ã®ãŸã‚æ…é‡åˆ¤æ–­" },
                    charcoal: { allow: false, windowMin: 0, extendedWindowMin: 0, note: "é©å¿œå¯å¦ã‚’ç¢ºèª" },
                    dialysis: { effective: false, indication: "æˆåˆ†ç‰¹æ€§ã®ç¢ºèªãŒå¿…è¦" },
                    otherTreatments: [{ name: "ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ã¸ç…§ä¼š", severityMin: 1, note: "ä¸æ˜æˆåˆ†ã¯ä¸€æ¬¡æƒ…å ±ã‚’åé›†" }],
                    jpic: this.buildUnknownJpicProfile(ingredientName),
                    unknown: true
                };
            }

            mergeProductsToDatabase(products) {
                let addedProducts = 0;
                let addedIngredients = 0;
                let updatedStrengthHints = 0;

                products.forEach((product) => {
                    const productName = String(product.product_name || "").trim();
                    const sourceIngredients = Array.isArray(product.ingredients) ? product.ingredients : [];
                    const ratioDefs = this.canonicalizeIngredientRatios(this.calculateIngredientRatios(sourceIngredients));
                    if (!productName || ratioDefs.length === 0) return;

                    if (!this.productDB[productName]) {
                        this.productDB[productName] = ratioDefs;
                        addedProducts += 1;
                    }

                    const strengthHint = this.estimateStrengthHintFromProduct(product);
                    if (Number.isFinite(strengthHint) && strengthHint > 0) {
                        const current = this.productStrengthHintsMg[productName];
                        if (!Number.isFinite(current)) {
                            this.productStrengthHintsMg[productName] = strengthHint;
                            updatedStrengthHints += 1;
                        }
                    }

                    ratioDefs.forEach((item) => {
                        if (!this.ingredientDB[item.ingredient]) {
                            this.ingredientDB[item.ingredient] = this.buildUnknownIngredientInfo(item.ingredient);
                            addedIngredients += 1;
                        }
                    });
                });

                return { addedProducts, addedIngredients, updatedStrengthHints };
            }

            parseNumericOrNull(value) {
                const num = Number(value);
                return Number.isFinite(num) ? num : null;
            }

            toStringList(values) {
                if (!Array.isArray(values)) return [];
                return [...new Set(values.map((item) => String(item || "").trim()).filter(Boolean))];
            }

            mergeOcrKnowledgeProfiles(profiles) {
                let loadedProfiles = 0;
                let addedProducts = 0;
                let addedIngredients = 0;
                let addedSynonyms = 0;

                (Array.isArray(profiles) ? profiles : []).forEach((profile) => {
                    const ingredientName = String(profile.ingredient_name || "").trim();
                    if (!ingredientName) return;
                    loadedProfiles += 1;

                    if (!this.ingredientDB[ingredientName]) {
                        this.ingredientDB[ingredientName] = this.buildUnknownIngredientInfo(ingredientName);
                        addedIngredients += 1;
                    }

                    const ingredient = this.ingredientDB[ingredientName];
                    ingredient.unknown = false;
                    ingredient.component = String(profile.component || ingredient.component || "Unknown");

                    const symptoms = this.toStringList(profile.symptoms);
                    if (symptoms.length > 0) ingredient.symptoms = symptoms;
                    const criticalSymptoms = this.toStringList(profile.critical_symptoms);
                    if (criticalSymptoms.length > 0) ingredient.criticalSymptoms = criticalSymptoms;

                    const thresholds = profile.toxic_threshold_mg_kg || {};
                    const toxic = this.parseNumericOrNull(thresholds.toxic);
                    const severe = this.parseNumericOrNull(thresholds.severe);
                    const critical = this.parseNumericOrNull(thresholds.critical);
                    if (Number.isFinite(toxic)) ingredient.toxicDoseMgKg = toxic;
                    if (Number.isFinite(severe)) ingredient.severeDoseMgKg = severe;
                    if (Number.isFinite(critical)) ingredient.criticalDoseMgKg = critical;

                    const treatment = profile.treatment || {};
                    const antidote = treatment.antidote || {};
                    ingredient.antidote = {
                        name: String(antidote.name || ingredient.antidote?.name || "ç‰¹ç•°çš„è§£æ¯’å‰¤ãªã—"),
                        indication: String(antidote.indication || ingredient.antidote?.indication || "æ”¯æŒç™‚æ³•ã‚’å„ªå…ˆ")
                    };

                    const lavage = treatment.lavage || {};
                    ingredient.lavage = {
                        allow: Boolean(lavage.allow),
                        windowMin: Number.isFinite(Number(lavage.window_min)) ? Number(lavage.window_min) : Number(ingredient.lavage?.windowMin || 0),
                        note: String(lavage.note || ingredient.lavage?.note || "é©å¿œã‚’å€‹åˆ¥åˆ¤æ–­")
                    };

                    const charcoal = treatment.charcoal || {};
                    ingredient.charcoal = {
                        allow: Boolean(charcoal.allow),
                        windowMin: Number.isFinite(Number(charcoal.window_min)) ? Number(charcoal.window_min) : Number(ingredient.charcoal?.windowMin || 0),
                        extendedWindowMin: Number.isFinite(Number(charcoal.extended_window_min))
                            ? Number(charcoal.extended_window_min)
                            : Number(ingredient.charcoal?.extendedWindowMin || 0),
                        note: String(charcoal.note || ingredient.charcoal?.note || "é©å¿œã‚’å€‹åˆ¥åˆ¤æ–­")
                    };

                    const dialysis = treatment.dialysis || {};
                    ingredient.dialysis = {
                        effective: Boolean(dialysis.effective),
                        indication: String(dialysis.indication || ingredient.dialysis?.indication || "æœ‰åŠ¹æ€§æƒ…å ±ã‚’ç¢ºèª")
                    };

                    const otherTreatments = Array.isArray(treatment.other) ? treatment.other : [];
                    if (otherTreatments.length > 0) {
                        ingredient.otherTreatments = otherTreatments.map((item) => ({
                            name: String(item.name || "æ”¯æŒç™‚æ³•"),
                            severityMin: Number.isFinite(Number(item.severity_min)) ? Number(item.severity_min) : 1,
                            note: String(item.note || "")
                        }));
                    }

                    const timeline = Array.isArray(profile.symptom_timeline) ? profile.symptom_timeline : [];
                    const normalizedTimeline = timeline.map((phase) => ({
                        window: String(phase.window || "ä¸æ˜"),
                        symptoms: this.toStringList(phase.symptoms),
                        redFlags: this.toStringList(phase.red_flags)
                    }));

                    const toxicokinetics = profile.toxicokinetics || {};
                    const analysis = profile.analysis || {};
                    const evidence = profile.evidence || {};
                    const treatmentGuide = {
                        decontamination: [
                            ingredient.lavage.allow ? `èƒƒæ´—æµ„(${ingredient.lavage.windowMin}åˆ†ä»¥å†…)` : "èƒƒæ´—æµ„ã¯åŸå‰‡éæ¨å¥¨",
                            ingredient.charcoal.allow ? `æ´»æ€§ç‚­(${ingredient.charcoal.windowMin}åˆ†ä»¥å†…)` : "æ´»æ€§ç‚­ã¯åŸå‰‡éæ¨å¥¨"
                        ].join(" / "),
                        antidote: ingredient.antidote.name,
                        extracorporeal: ingredient.dialysis.effective ? "è¡€æ¶²æµ„åŒ–ã‚’æ¤œè¨" : "è¡€æ¶²æµ„åŒ–ã¯é€šå¸¸é©å¿œå¤–",
                        other: this.toStringList((treatment.other || []).map((item) => item.name)).join(", ") || "æ”¯æŒç™‚æ³•"
                    };

                    ingredient.jpic = this.normalizeJpicProfile({
                        ingredientName,
                        aliases: this.toStringList(profile.aliases),
                        toxicThresholdMgKg: {
                            caution: this.parseNumericOrNull(thresholds.caution),
                            toxic: this.parseNumericOrNull(thresholds.toxic),
                            severe: this.parseNumericOrNull(thresholds.severe),
                            critical: this.parseNumericOrNull(thresholds.critical)
                        },
                        symptomTimeline: normalizedTimeline,
                        toxicokinetics: {
                            tmaxHours: String(toxicokinetics.tmaxHours || "æƒ…å ±ä¸è¶³"),
                            halfLifeHours: String(toxicokinetics.halfLifeHours || "æƒ…å ±ä¸è¶³"),
                            vdLKg: String(toxicokinetics.vdLKg || "æƒ…å ±ä¸è¶³"),
                            proteinBindingPct: String(toxicokinetics.proteinBindingPct || "æƒ…å ±ä¸è¶³"),
                            metabolism: String(toxicokinetics.metabolism || "æƒ…å ±ä¸è¶³"),
                            elimination: String(toxicokinetics.elimination || "æƒ…å ±ä¸è¶³")
                        },
                        treatmentGuide,
                        analysis: {
                            recommendedTests: this.toStringList(analysis.recommended_tests),
                            interpretation: String(analysis.interpretation || "ç—‡å€™ã¨æ›éœ²é‡ã‹ã‚‰ç·åˆåˆ¤æ–­"),
                            notes: String(analysis.notes || "")
                        },
                        evidence: {
                            source: String(evidence.source || "ocr_result_1770368005162.txt"),
                            updatedAt: String(evidence.updated_at || "ä¸æ˜"),
                            level: String(evidence.level || "ocr-reference")
                        }
                    }, ingredientName);

                    this.toStringList(profile.aliases).forEach((alias) => {
                        if (alias === ingredientName) return;
                        if (!this.ingredientSynonyms[alias]) {
                            this.ingredientSynonyms[alias] = ingredientName;
                            addedSynonyms += 1;
                        }
                        this.ingredientSynonymIndex[this.normalizeName(alias)] = ingredientName;
                    });

                    this.toStringList(profile.product_aliases).forEach((productName) => {
                        if (!this.productDB[productName]) {
                            this.productDB[productName] = [{ ingredient: ingredientName, ratio: 1 }];
                            addedProducts += 1;
                        }
                    });
                });

                return { loadedProfiles, addedProducts, addedIngredients, addedSynonyms };
            }

            async loadDatasetFile(path, label) {
                const response = await fetch(path, { cache: "no-store" });
                if (!response.ok) throw new Error(`${label}: HTTP ${response.status}`);

                const payload = await response.json();
                const products = Array.isArray(payload.products) ? payload.products : [];
                const merged = this.mergeProductsToDatabase(products);
                return {
                    label,
                    loadedProducts: products.length,
                    addedProducts: merged.addedProducts,
                    addedIngredients: merged.addedIngredients,
                    updatedStrengthHints: merged.updatedStrengthHints
                };
            }

            async loadOcrKnowledgeFile(path, label) {
                const response = await fetch(path, { cache: "no-store" });
                if (!response.ok) throw new Error(`${label}: HTTP ${response.status}`);
                const payload = await response.json();
                const profiles = Array.isArray(payload.profiles) ? payload.profiles : [];
                const merged = this.mergeOcrKnowledgeProfiles(profiles);
                return {
                    label,
                    loadedProfiles: merged.loadedProfiles,
                    addedProducts: merged.addedProducts,
                    addedIngredients: merged.addedIngredients,
                    addedSynonyms: merged.addedSynonyms
                };
            }

            async loadExternalDatasets() {
                this.setDatasetStatus("å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...");
                const loaded = [];

                try {
                    loaded.push(await this.loadDatasetFile("data/pmda_otc_products.json", "PMDA-OTC"));
                } catch (error) {
                    // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¸ç¶™ç¶š
                }

                try {
                    loaded.push(await this.loadDatasetFile("data/pmda_iyaku_products.json", "PMDA-åŒ»ç™‚ç”¨"));
                } catch (error) {
                    // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯å†…è”µãƒ‡ãƒ¼ã‚¿ã®ã¿ã§ç¶™ç¶š
                }

                try {
                    loaded.push(await this.loadOcrKnowledgeFile("data/ocr_household_knowledge.json", "OCR-å®¶åº­ç”¨å“çŸ¥è­˜"));
                } catch (error) {
                    // OCRçŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«æœªé…ç½®ã§ã‚‚å‹•ä½œç¶™ç¶š
                }

                this.populateDrugCandidates();
                this.datasetLoaded = loaded.length > 0;

                if (loaded.length === 0) {
                    this.setDatasetStatus("å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆå†…è”µãƒ‡ãƒ¼ã‚¿ã®ã¿åˆ©ç”¨ï¼‰", "warn");
                    return;
                }

                const totalAddedProducts = loaded.reduce((sum, item) => sum + item.addedProducts, 0);
                const totalAddedIngredients = loaded.reduce((sum, item) => sum + item.addedIngredients, 0);
                const totalStrengthHints = loaded.reduce((sum, item) => sum + (item.updatedStrengthHints || 0), 0);
                const totalKnowledgeProfiles = loaded.reduce((sum, item) => sum + (item.loadedProfiles || 0), 0);
                const totalAddedSynonyms = loaded.reduce((sum, item) => sum + (item.addedSynonyms || 0), 0);
                const sourceLabel = loaded.map((item) => item.label).join(" / ");
                this.setDatasetStatus(
                    `${sourceLabel} èª­è¾¼å®Œäº†: è£½å“ +${totalAddedProducts} ä»¶ / æ–°è¦æˆåˆ† +${totalAddedIngredients} ä»¶ / è¦æ ¼ãƒ’ãƒ³ãƒˆ +${totalStrengthHints} ä»¶ / OCRçŸ¥è­˜ ${totalKnowledgeProfiles} ä»¶ / åŒç¾©èª +${totalAddedSynonyms} ä»¶`,
                    "success"
                );
                this.tryAutoFillStrength();
            }

            renderSymptomChips() {
                const chipArea = document.getElementById("symptomChips");
                chipArea.innerHTML = this.commonSymptoms.map((symptom) => `
                    <button type="button" class="text-xs border border-slate-300 rounded-full px-3 py-1 hover:bg-slate-100" data-chip="${this.escapeHTML(symptom)}">
                        ${this.escapeHTML(symptom)}
                    </button>
                `).join("");

                chipArea.addEventListener("click", (event) => {
                    const chip = event.target.closest("[data-chip]");
                    if (!chip) return;
                    this.appendSymptom(chip.dataset.chip);
                });
            }

            appendSymptom(symptom) {
                const symptomInput = document.getElementById("observedSymptoms");
                const currentSymptoms = this.parseSymptoms(symptomInput.value);
                if (!currentSymptoms.includes(symptom)) {
                    currentSymptoms.push(symptom);
                    symptomInput.value = currentSymptoms.join(", ");
                }
            }

            populateDrugCandidates() {
                const datalist = document.getElementById("drugCandidates");
                const candidates = [
                    ...Object.keys(this.productDB),
                    ...Object.keys(this.ingredientDB)
                ].sort((a, b) => a.localeCompare(b, "ja"));
                datalist.innerHTML = candidates.map((name) => `<option value="${this.escapeHTML(name)}"></option>`).join("");
                this.buildSearchEntries();
            }

            addDrugCore(drugName, amountMg, ingestionContext, meta = {}) {
                const resolved = this.resolveDrugToIngredients(drugName, amountMg);
                resolved.ingredients.forEach((ingredientItem) => {
                    const amountForIngredient = amountMg * ingredientItem.ratio;
                    const ingredientInfo = this.getIngredientInfo(ingredientItem.ingredient);
                    const jpicProfile = this.getJpicProfile(ingredientInfo, ingredientItem.ingredient);
                    const doseMgKg = amountForIngredient / ingestionContext.patientWeight;
                    const severity = this.classifySeverity(doseMgKg, ingredientInfo);
                    const predictedSymptoms = ingredientInfo.symptoms || [];
                    const matchedSymptoms = this.matchSymptoms(predictedSymptoms, ingestionContext.observedSymptoms);
                    const toxicRatio = ingredientInfo.toxicDoseMgKg ? (doseMgKg / ingredientInfo.toxicDoseMgKg) : null;
                    const timelineAssessment = this.assessTimeline(jpicProfile, ingestionContext.elapsedMin, ingestionContext.observedSymptoms);

                    const treatment = this.evaluateTreatments({
                        ingredientInfo,
                        jpicProfile,
                        severity,
                        doseMgKg,
                        toxicRatio,
                        context: ingestionContext,
                        matchedSymptoms
                    });

                    const riskScore = this.calculateRiskScore(
                        severity,
                        toxicRatio,
                        matchedSymptoms.length,
                        ingredientInfo.unknown,
                        timelineAssessment.matchedRedFlags.length
                    );

                    this.entries.push({
                        id: this.entryCounter++,
                        sourceDrug: resolved.sourceName,
                        inputDrug: drugName,
                        ingredient: ingredientItem.ingredient,
                        component: ingredientInfo.component,
                        ingredientAmountMg: amountForIngredient,
                        doseMgKg,
                        toxicRatio,
                        severity,
                        predictedSymptoms,
                        matchedSymptoms,
                        jpicProfile,
                        timelineAssessment,
                        treatment,
                        riskScore,
                        unknown: ingredientInfo.unknown,
                        sourceMode: meta.sourceMode || "manual",
                        sourceLine: meta.sourceLine || ""
                    });
                });
            }

            addDrug() {
                const drugInput = document.getElementById("drugInput");
                const amountInput = document.getElementById("amountInput");
                const strengthInput = document.getElementById("strengthInput");
                const tabletCountInput = document.getElementById("tabletCountInput");
                const drugName = drugInput.value.trim();
                if (!drugName) {
                    alert("è–¬å‰¤åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                this.tryAutoFillStrength();
                const autoAmount = this.recalculateTotalAmount();
                const manualAmount = Number(amountInput.value);
                const amountMg = Number.isFinite(autoAmount) && autoAmount > 0 ? autoAmount : manualAmount;

                if (!Number.isFinite(amountMg) || amountMg <= 0) {
                    alert("ç·é‡(mg)ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€è¦æ ¼(mg/éŒ )ã¨éŒ æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }
                const ingestionContext = this.buildIngestionContextFromInputs({ showAlert: true });
                if (!ingestionContext) return;

                this.addDrugCore(drugName, amountMg, ingestionContext, { sourceMode: "manual" });
                this.entries.sort((a, b) => b.riskScore - a.riskScore);
                this.render();

                amountInput.value = "";
                tabletCountInput.value = "";
                strengthInput.value = "";
                strengthInput.dataset.autoFilled = "0";
                this.setAmountCalcStatus("è¦æ ¼ã¨éŒ æ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨ç·é‡ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚", "info");
                drugInput.value = "";
                drugInput.focus();
            }

            resolveDrugToIngredients(drugName, amountMg) {
                const matchedProductKey = this.findKeyByNormalizedName(this.productDB, drugName);
                if (matchedProductKey) {
                    const ingredientDefs = this.canonicalizeIngredientRatios(this.productDB[matchedProductKey]);
                    const ratioTotal = ingredientDefs.reduce((sum, item) => sum + item.ratio, 0) || 1;
                    return {
                        sourceName: matchedProductKey,
                        ingredients: ingredientDefs.map((item) => ({
                            ingredient: item.ingredient,
                            ratio: item.ratio / ratioTotal
                        })),
                        totalAmountMg: amountMg
                    };
                }

                const canonicalDrugName = this.canonicalizeIngredientName(drugName);
                const matchedIngredientKey = this.findKeyByNormalizedName(this.ingredientDB, canonicalDrugName);
                if (matchedIngredientKey) {
                    return {
                        sourceName: matchedIngredientKey,
                        ingredients: [{ ingredient: matchedIngredientKey, ratio: 1 }],
                        totalAmountMg: amountMg
                    };
                }

                return {
                    sourceName: `${drugName} (ãƒ‡ãƒ¼ã‚¿æœªç™»éŒ²)`,
                    ingredients: [{ ingredient: canonicalDrugName || drugName, ratio: 1 }],
                    totalAmountMg: amountMg
                };
            }

            getIngredientInfo(ingredientName) {
                const canonicalName = this.canonicalizeIngredientName(ingredientName);
                const matchedKey = this.findKeyByNormalizedName(this.ingredientDB, canonicalName);
                if (matchedKey) return this.ingredientDB[matchedKey];
                return this.buildUnknownIngredientInfo(canonicalName || ingredientName);
            }

            classifySeverity(doseMgKg, ingredientInfo) {
                const profile = this.getJpicProfile(ingredientInfo, ingredientInfo?.component || "ä¸æ˜æˆåˆ†");
                const thresholds = profile.toxicThresholdMgKg || {};
                const toxicDose = Number.isFinite(ingredientInfo.toxicDoseMgKg) ? ingredientInfo.toxicDoseMgKg : thresholds.toxic;
                const severeDose = Number.isFinite(ingredientInfo.severeDoseMgKg) ? ingredientInfo.severeDoseMgKg : thresholds.severe;
                const criticalDose = Number.isFinite(ingredientInfo.criticalDoseMgKg) ? ingredientInfo.criticalDoseMgKg : thresholds.critical;

                if (!Number.isFinite(toxicDose)) {
                    return { label: "æƒ…å ±ä¸è¶³", rank: 3, badgeClass: "severity-mid", detail: "ä¸­æ¯’é‡ãƒ‡ãƒ¼ã‚¿ãªã—" };
                }
                if (Number.isFinite(criticalDose) && doseMgKg >= criticalDose) {
                    return { label: "æœ€é‡ç—‡", rank: 5, badgeClass: "severity-critical", detail: "è‡´æ­»åŸŸã®å¯èƒ½æ€§" };
                }
                if (Number.isFinite(severeDose) && doseMgKg >= severeDose) {
                    return { label: "é‡ç—‡", rank: 4, badgeClass: "severity-high", detail: "é›†ä¸­æ²»ç™‚ã‚’è¦ã™ã‚‹å¯èƒ½æ€§" };
                }
                if (doseMgKg >= toxicDose) {
                    return { label: "ä¸­ç­‰ç—‡", rank: 3, badgeClass: "severity-mid", detail: "ä¸­æ¯’åŸŸã«åˆ°é”" };
                }
                if (doseMgKg >= toxicDose * 0.5) {
                    return { label: "è»½ç—‡", rank: 2, badgeClass: "severity-low", detail: "ç—‡çŠ¶ç™ºç¾ã«æ³¨æ„" };
                }
                return { label: "ä½ãƒªã‚¹ã‚¯", rank: 1, badgeClass: "severity-minimal", detail: "ç¾æ™‚ç‚¹ã§ã¯ä½ãƒªã‚¹ã‚¯" };
            }

            calculateRiskScore(severity, toxicRatio, matchCount, isUnknown, redFlagCount = 0) {
                if (isUnknown) return 320 + (matchCount * 8) + (redFlagCount * 12);
                const ratioScore = toxicRatio ? Math.min(100, toxicRatio * 30) : 0;
                return severity.rank * 100 + ratioScore + (matchCount * 8) + (redFlagCount * 12);
            }

            parseSymptoms(symptomText) {
                if (!symptomText) return [];
                const parsed = symptomText.split(/[,ã€\n]/).map((item) => item.trim()).filter(Boolean);
                return [...new Set(parsed)];
            }

            matchSymptoms(predicted, observed) {
                const matches = predicted.filter((predictedSymptom) => {
                    return observed.some((observedSymptom) => {
                        return observedSymptom.includes(predictedSymptom) || predictedSymptom.includes(observedSymptom);
                    });
                });
                return [...new Set(matches)];
            }

            evaluateTreatments(payload) {
                const { ingredientInfo, jpicProfile, severity, toxicRatio, context, matchedSymptoms } = payload;
                if (ingredientInfo.unknown) {
                    return {
                        antidote: { status: "è¦æƒ…å ±ç¢ºèª", action: "æˆåˆ†ç‰¹å®šã‚’å„ªå…ˆ", reason: "æ‹®æŠ—è–¬ã®é©å¿œåˆ¤å®šã«æˆåˆ†åŒå®šãŒå¿…é ˆ" },
                        lavage: { status: "è¦æƒ…å ±ç¢ºèª", action: "æ¯’æ€§æƒ…å ±ç¢ºèªå¾Œã«åˆ¤æ–­", reason: "æ¯’æ€§ãƒ»èª¤åš¥ãƒªã‚¹ã‚¯ã®è©•ä¾¡ãŒæœªç¢ºå®š" },
                        charcoal: { status: "è¦æƒ…å ±ç¢ºèª", action: "å¸ç€æ€§ã‚’ç¢ºèª", reason: "æˆåˆ†ã®å¸ç€å¯å¦ãƒ‡ãƒ¼ã‚¿ãŒãªã„" },
                        dialysis: { status: "è¦æƒ…å ±ç¢ºèª", action: "è¡€æ¶²æµ„åŒ–ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª", reason: "è›‹ç™½çµåˆç‡/åˆ†å¸ƒå®¹ç©ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦" },
                        others: [
                            { name: "ä¸­æ¯’æƒ…å ±ã‚»ãƒ³ã‚¿ãƒ¼ã¸å³æ™‚ç…§ä¼š", status: "å¦¥å½“", reason: "ä¸æ˜æˆåˆ†ã®åˆæœŸå¯¾å¿œã¨ã—ã¦å¿…é ˆ" },
                            { name: "æ¨å¥¨æ¤œæŸ»", status: "å¦¥å½“", reason: (jpicProfile?.analysis?.recommendedTests || []).join(", ") || "è¡€æ¶²ã‚¬ã‚¹ãƒ»é›»è§£è³ªã‚’ä¸­å¿ƒã«è©•ä¾¡" }
                        ]
                    };
                }

                const hasCriticalSymptom = matchedSymptoms.some((symptom) => ingredientInfo.criticalSymptoms.includes(symptom));
                const toxicExceeded = typeof toxicRatio === "number" && toxicRatio >= 1;

                const antidote = (() => {
                    const action = ingredientInfo.antidote.name;
                    if (action.includes("ãªã—")) {
                        return { status: "é©å¿œãªã—", action, reason: ingredientInfo.antidote.indication };
                    }
                    if (severity.rank >= 3 || hasCriticalSymptom || toxicExceeded) {
                        return { status: "å¦¥å½“", action, reason: `${ingredientInfo.antidote.indication} / ${jpicProfile?.treatmentGuide?.antidote || ""}` };
                    }
                    return { status: "æ¡ä»¶ä»˜ã", action, reason: `ç¾æ™‚ç‚¹ã¯ä½ã€œè»½ç—‡ã€‚ãŸã ã— ${ingredientInfo.antidote.indication}` };
                })();

                const lavage = (() => {
                    if (!ingredientInfo.lavage.allow) {
                        return { status: "éæ¨å¥¨", action: "èƒƒæ´—æµ„ã‚’é€šå¸¸ã¯è¡Œã‚ãªã„", reason: ingredientInfo.lavage.note };
                    }
                    if (context.elapsedMin > ingredientInfo.lavage.windowMin) {
                        return { status: "éæ¨å¥¨", action: "é©å¿œæ™‚é–“å¤–", reason: `${ingredientInfo.lavage.windowMin} åˆ†ã‚’è¶…é` };
                    }
                    if (!context.airwaySecured) {
                        return { status: "æ…é‡", action: "æ°—é“ç¢ºä¿å¾Œã«å†è©•ä¾¡", reason: "èª¤åš¥ãƒªã‚¹ã‚¯ãŒé«˜ã„" };
                    }
                    if (severity.rank >= 4 || (typeof toxicRatio === "number" && toxicRatio >= 2)) {
                        return { status: "å¦¥å½“", action: "èƒƒæ´—æµ„ã‚’æ¤œè¨", reason: ingredientInfo.lavage.note };
                    }
                    return { status: "æ¡ä»¶ä»˜ã", action: "ç—‡çŠ¶é€²è¡Œæ™‚ã«æ¤œè¨", reason: "é‡ç—‡åº¦ãŒä¸ŠãŒã‚Œã°é©å¿œ" };
                })();

                const charcoal = (() => {
                    if (!ingredientInfo.charcoal.allow) {
                        return { status: "éæ¨å¥¨", action: "æ´»æ€§ç‚­ã¯åŠ¹æœä¹ã—ã„", reason: ingredientInfo.charcoal.note };
                    }
                    if (context.elapsedMin <= ingredientInfo.charcoal.windowMin) {
                        return { status: "å¦¥å½“", action: "æ´»æ€§ç‚­æŠ•ä¸ã‚’æ¤œè¨", reason: ingredientInfo.charcoal.note };
                    }
                    if (context.elapsedMin <= ingredientInfo.charcoal.extendedWindowMin && severity.rank >= 3) {
                        return { status: "æ¡ä»¶ä»˜ã", action: "é…å»¶æŠ•ä¸ã‚’æ¤œè¨", reason: "é‡ç—‡ä¾‹ã§ã‚ã‚Œã°åˆ©ç›ŠãŒæ®‹ã‚‹å¯èƒ½æ€§" };
                    }
                    return { status: "éæ¨å¥¨", action: "æŠ•ä¸ãƒ¡ãƒªãƒƒãƒˆãŒé™å®šçš„", reason: "æœ‰åŠ¹æ™‚é–“ã‚’è¶…é" };
                })();

                const dialysis = (() => {
                    if (!ingredientInfo.dialysis.effective) {
                        return { status: "é©å¿œãªã—", action: "è¡€æ¶²æµ„åŒ–ã¯é€šå¸¸ä¸è¦", reason: ingredientInfo.dialysis.indication };
                    }
                    if (severity.rank >= 4 || hasCriticalSymptom || (typeof toxicRatio === "number" && toxicRatio >= 2)) {
                        return { status: "å¦¥å½“", action: "è¡€æ¶²æµ„åŒ–ã‚’æ—©æœŸæ¤œè¨", reason: ingredientInfo.dialysis.indication };
                    }
                    if (severity.rank >= 3) {
                        return { status: "æ¡ä»¶ä»˜ã", action: "é‡ç—‡åŒ–æ™‚ã«å°å…¥æ¤œè¨", reason: ingredientInfo.dialysis.indication };
                    }
                    return { status: "æ…é‡", action: "ç¾æ™‚ç‚¹ã§ã¯çµŒéè¦³å¯Ÿ", reason: "æ˜ç¢ºãªå°å…¥åŸºæº–ã«æœªé”" };
                })();

                const others = ingredientInfo.otherTreatments.map((item) => {
                    const symptomHit = !item.symptomAny || item.symptomAny.some((symptom) => {
                        return context.observedSymptoms.some((observed) => observed.includes(symptom) || symptom.includes(observed));
                    });
                    const severityHit = severity.rank >= (item.severityMin || 1);

                    let status = "æ…é‡";
                    if (severityHit && symptomHit) {
                        status = "å¦¥å½“";
                    } else if (severityHit || symptomHit) {
                        status = "æ¡ä»¶ä»˜ã";
                    }

                    return {
                        name: item.name,
                        status,
                        reason: item.note
                    };
                });

                return { antidote, lavage, charcoal, dialysis, others };
            }

            removeEntry(id) {
                this.entries = this.entries.filter((entry) => entry.id !== id);
                this.render();
            }

            clearAll() {
                this.entries = [];
                this.render();
            }

            findKeyByNormalizedName(objectMap, targetName) {
                const normalizedTarget = this.normalizeName(targetName);
                return Object.keys(objectMap).find((key) => this.normalizeName(key) === normalizedTarget) || null;
            }

            normalizeName(value) {
                return String(value)
                    .normalize("NFKC")
                    .replace(/[â€â€‘â€’â€“â€”â€•ãƒ¼âˆ’]/g, "-")
                    .replace(/\s+/g, "")
                    .toLowerCase();
            }

            formatNumber(value, digits = 1) {
                return Number(value).toFixed(digits);
            }

            statusClass(status) {
                const map = {
                    "å¦¥å½“": "bg-green-100 text-green-800",
                    "æ¡ä»¶ä»˜ã": "bg-amber-100 text-amber-800",
                    "æ…é‡": "bg-sky-100 text-sky-800",
                    "éæ¨å¥¨": "bg-rose-100 text-rose-800",
                    "é©å¿œãªã—": "bg-slate-100 text-slate-700",
                    "è¦æƒ…å ±ç¢ºèª": "bg-violet-100 text-violet-800"
                };
                return map[status] || "bg-slate-100 text-slate-700";
            }

            render() {
                this.renderPriorityList();
                this.renderTreatmentMatrix();
                this.renderReportOutput();
            }

            renderPriorityList() {
                const container = document.getElementById("priorityList");
                if (this.entries.length === 0) {
                    container.innerHTML = `
                        <p class="text-slate-400 text-center py-10 bg-white rounded-xl border border-slate-200">
                            è–¬å‰¤ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«è§£æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                        </p>
                    `;
                    return;
                }

                container.innerHTML = this.entries.map((entry, index) => {
                    const predictedWithoutMatch = entry.predictedSymptoms.filter((symptom) => !entry.matchedSymptoms.includes(symptom));
                    const matchedText = entry.matchedSymptoms.length > 0 ? entry.matchedSymptoms.join(", ") : "ä¸€è‡´ãªã—";
                    const unmatchedText = predictedWithoutMatch.length > 0 ? predictedWithoutMatch.join(", ") : "ä¸»è¦ç—‡çŠ¶ã¯æ¦‚ã­ä¸€è‡´";
                    const toxicDoseText = entry.unknown ? "ä¸æ˜" : `${entry.toxicRatio ? this.formatNumber(entry.toxicRatio, 2) : "0.00"} x ä¸­æ¯’é‡`;
                    const sourceLabel = entry.sourceMode === "photo_ocr"
                        ? `å†™çœŸOCR: ${entry.sourceDrug}`
                        : (entry.sourceDrug === entry.ingredient ? "æˆåˆ†ç›´å…¥åŠ›" : `è£½å‰¤: ${entry.sourceDrug}`);
                    const thresholdText = this.formatThresholdSummary(entry.jpicProfile?.toxicThresholdMgKg || {});
                    const timelinePhaseText = entry.timelineAssessment?.phase || "ä¸æ˜";
                    const timelineRedFlags = (entry.timelineAssessment?.redFlags || []).join(", ") || "ãªã—";
                    const timelineMatchedRedFlags = (entry.timelineAssessment?.matchedRedFlags || []).join(", ") || "ä¸€è‡´ãªã—";

                    return `
                        <article class="bg-white border border-slate-200 rounded-xl shadow-sm p-4">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                                <div class="space-y-2">
                                    <p class="text-xs text-slate-500 font-semibold">å„ªå…ˆåº¦ ${index + 1} | ${this.escapeHTML(sourceLabel)}</p>
                                    <h3 class="text-lg font-bold">
                                        ${this.escapeHTML(entry.ingredient)}
                                        <span class="text-sm text-slate-500 font-medium">(${this.escapeHTML(entry.component)})</span>
                                    </h3>
                                    <div class="text-sm text-slate-700 space-y-1">
                                        <p>æ¨å®šæˆåˆ†é‡: <span class="font-semibold">${this.formatNumber(entry.ingredientAmountMg, 1)} mg</span></p>
                                        <p>æ¨å®šæ‘‚å–é‡: <span class="font-semibold">${this.formatNumber(entry.doseMgKg, 2)} mg/kg</span> / æ¯’æ€§æ¯”: <span class="font-semibold">${toxicDoseText}</span></p>
                                        <p>JPICäº’æ›é–¾å€¤: <span class="text-indigo-700">${this.escapeHTML(thresholdText)}</span></p>
                                        <p>çµŒæ™‚ãƒ•ã‚§ãƒ¼ã‚º: <span class="font-semibold">${this.escapeHTML(timelinePhaseText)}</span> / èµ¤æ——: <span class="text-rose-700">${this.escapeHTML(timelineRedFlags)}</span> / ä¸€è‡´: <span class="text-green-700">${this.escapeHTML(timelineMatchedRedFlags)}</span></p>
                                        <p>äºˆæ¸¬ç—‡çŠ¶: <span class="text-red-700">${this.escapeHTML(entry.predictedSymptoms.join(", "))}</span></p>
                                        <p>æ‚£è€…ç—‡çŠ¶ä¸€è‡´: <span class="text-green-700">${this.escapeHTML(matchedText)}</span></p>
                                        <p>æœªä¸€è‡´ç—‡çŠ¶: <span class="text-slate-600">${this.escapeHTML(unmatchedText)}</span></p>
                                    </div>
                                </div>
                                <div class="flex md:flex-col gap-2 items-center md:items-end">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${entry.severity.badgeClass}">
                                        ${this.escapeHTML(entry.severity.label)}
                                    </span>
                                    <span class="text-xs text-slate-500">${this.escapeHTML(entry.severity.detail)}</span>
                                    <button data-remove-id="${entry.id}" class="text-xs px-3 py-1 rounded border border-slate-300 hover:bg-slate-100">
                                        ã“ã®æˆåˆ†ã‚’å‰Šé™¤
                                    </button>
                                </div>
                            </div>
                        </article>
                    `;
                }).join("");
            }

            renderTreatmentMatrix() {
                const section = document.getElementById("treatmentSection");
                const container = document.getElementById("treatmentMatrix");
                if (this.entries.length === 0) {
                    section.classList.add("hidden");
                    container.innerHTML = "";
                    return;
                }

                section.classList.remove("hidden");
                container.innerHTML = this.entries.map((entry, index) => {
                    const treatment = entry.treatment;
                    const otherRows = treatment.others.map((item) => `
                        <li class="flex items-start gap-2 mb-2">
                            <span class="text-xs font-bold px-2 py-1 rounded ${this.statusClass(item.status)}">${this.escapeHTML(item.status)}</span>
                            <div>
                                <p class="font-semibold text-sm">${this.escapeHTML(item.name)}</p>
                                <p class="text-xs text-slate-600">${this.escapeHTML(item.reason)}</p>
                            </div>
                        </li>
                    `).join("");

                    return `
                        <article class="border border-slate-200 rounded-lg p-4">
                            <h3 class="font-bold text-base mb-3">
                                ${index + 1}. ${this.escapeHTML(entry.ingredient)} ã®æ²»ç™‚å¦¥å½“æ€§
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm border-collapse">
                                    <tbody>
                                        ${this.renderTreatmentRow("æ‹®æŠ—è–¬", treatment.antidote)}
                                        ${this.renderTreatmentRow("èƒƒæ´—æµ„", treatment.lavage)}
                                        ${this.renderTreatmentRow("æ´»æ€§ç‚­", treatment.charcoal)}
                                        ${this.renderTreatmentRow("è¡€æ¶²æµ„åŒ–", treatment.dialysis)}
                                        ${this.renderJpicThresholdRow(entry)}
                                        ${this.renderJpicTimelineRow(entry)}
                                        ${this.renderJpicPkRow(entry)}
                                        ${this.renderJpicAnalysisRow(entry)}
                                        ${this.renderJpicEvidenceRow(entry)}
                                        <tr class="border-t">
                                            <th class="text-left align-top p-2 w-36 bg-slate-50">ãã®ä»–æ²»ç™‚</th>
                                            <td class="p-2">
                                                <ul>${otherRows}</ul>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </article>
                    `;
                }).join("");
            }

            renderTreatmentRow(label, payload) {
                return `
                    <tr class="border-t">
                        <th class="text-left align-top p-2 w-36 bg-slate-50">${label}</th>
                        <td class="p-2">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-1 rounded ${this.statusClass(payload.status)}">${this.escapeHTML(payload.status)}</span>
                                <span class="font-semibold">${this.escapeHTML(payload.action)}</span>
                            </div>
                            <p class="text-xs text-slate-600">${this.escapeHTML(payload.reason)}</p>
                        </td>
                    </tr>
                `;
            }

            renderJpicThresholdRow(entry) {
                const thresholds = entry.jpicProfile?.toxicThresholdMgKg || {};
                const displayValue = (value) => (Number.isFinite(value) ? `${value} mg/kg` : "ä¸æ˜");
                const rowText = `
                    æ³¨æ„: ${displayValue(thresholds.caution)} /
                    ä¸­æ¯’: ${displayValue(thresholds.toxic)} /
                    é‡ç—‡: ${displayValue(thresholds.severe)} /
                    å±æ©Ÿ: ${displayValue(thresholds.critical)}
                `.replace(/\s+/g, " ").trim();

                return `
                    <tr class="border-t">
                        <th class="text-left align-top p-2 w-36 bg-slate-50">ä¸­æ¯’é‡é–¾å€¤</th>
                        <td class="p-2 text-sm text-slate-700">${this.escapeHTML(rowText)}</td>
                    </tr>
                `;
            }

            renderJpicTimelineRow(entry) {
                const timeline = entry.jpicProfile?.symptomTimeline || [];
                const phaseRows = timeline.map((phase) => {
                    const symptoms = (phase.symptoms || []).join(", ") || "æƒ…å ±ä¸è¶³";
                    const redFlags = (phase.redFlags || []).join(", ") || "ãªã—";
                    return `
                        <li class="mb-1">
                            <span class="font-semibold">${this.escapeHTML(phase.window || "ä¸æ˜")}</span>:
                            ç—‡çŠ¶ ${this.escapeHTML(symptoms)} / èµ¤æ—— ${this.escapeHTML(redFlags)}
                        </li>
                    `;
                }).join("");

                const current = entry.timelineAssessment || { phase: "ä¸æ˜", matchedRedFlags: [] };
                const matched = (current.matchedRedFlags || []).join(", ") || "ä¸€è‡´ãªã—";

                return `
                    <tr class="border-t">
                        <th class="text-left align-top p-2 w-36 bg-slate-50">ç—‡çŠ¶ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</th>
                        <td class="p-2">
                            <p class="text-xs text-slate-600 mb-2">ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚º: <span class="font-semibold">${this.escapeHTML(current.phase || "ä¸æ˜")}</span> / èµ¤æ——ä¸€è‡´: <span class="text-rose-700">${this.escapeHTML(matched)}</span></p>
                            <ul class="text-sm text-slate-700">${phaseRows}</ul>
                        </td>
                    </tr>
                `;
            }

            renderJpicPkRow(entry) {
                const pk = entry.jpicProfile?.toxicokinetics || {};
                const text = `Tmax ${pk.tmaxHours || "æƒ…å ±ä¸è¶³"} h / åŠæ¸›æœŸ ${pk.halfLifeHours || "æƒ…å ±ä¸è¶³"} h / Vd ${pk.vdLKg || "æƒ…å ±ä¸è¶³"} L/kg / è›‹ç™½çµåˆ ${pk.proteinBindingPct || "æƒ…å ±ä¸è¶³"} / ä»£è¬ ${pk.metabolism || "æƒ…å ±ä¸è¶³"} / æ’æ³„ ${pk.elimination || "æƒ…å ±ä¸è¶³"}`;
                return `
                    <tr class="border-t">
                        <th class="text-left align-top p-2 w-36 bg-slate-50">ä½“å†…å‹•æ…‹</th>
                        <td class="p-2 text-sm text-slate-700">${this.escapeHTML(text)}</td>
                    </tr>
                `;
            }

            renderJpicAnalysisRow(entry) {
                const analysis = entry.jpicProfile?.analysis || {};
                const tests = (analysis.recommendedTests || []).join(", ") || "æƒ…å ±ä¸è¶³";
                const interpretation = analysis.interpretation || "æƒ…å ±ä¸è¶³";
                const notes = analysis.notes || "ãªã—";
                return `
                    <tr class="border-t">
                        <th class="text-left align-top p-2 w-36 bg-slate-50">åˆ†ææ³•ãƒ»æ¤œæŸ»</th>
                        <td class="p-2">
                            <p class="text-sm text-slate-700"><span class="font-semibold">æ¨å¥¨æ¤œæŸ»:</span> ${this.escapeHTML(tests)}</p>
                            <p class="text-sm text-slate-700"><span class="font-semibold">è§£é‡ˆ:</span> ${this.escapeHTML(interpretation)}</p>
                            <p class="text-xs text-slate-600"><span class="font-semibold">è£œè¶³:</span> ${this.escapeHTML(notes)}</p>
                        </td>
                    </tr>
                `;
            }

            renderJpicEvidenceRow(entry) {
                const evidence = entry.jpicProfile?.evidence || {};
                const text = `å‡ºå…¸: ${evidence.source || "ä¸æ˜"} / æ›´æ–°æ—¥: ${evidence.updatedAt || "ä¸æ˜"} / æ ¹æ‹ ãƒ¬ãƒ™ãƒ«: ${evidence.level || "ä¸æ˜"}`;
                return `
                    <tr class="border-t">
                        <th class="text-left align-top p-2 w-36 bg-slate-50">æ ¹æ‹ æƒ…å ±</th>
                        <td class="p-2 text-xs text-slate-600">${this.escapeHTML(text)}</td>
                    </tr>
                `;
            }

            escapeHTML(value) {
                return String(value)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#39;");
            }
        }

        const app = new ToxicNaviApp();
    </script>
</body>
</html>
